<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Derma Mini-App — Обнуление данных</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>window.API_BASE = window.API_BASE || '';</script>
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Manrope,Helvetica,Arial;font-size:16px;line-height:1.5}
    .wrap{max-width:760px;margin:0 auto;padding:24px 24px 40px}
    h1{font-size:26px;margin:0 0 12px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

    /* Toggle (copied from your FAQ style, adapted) */
    .topbar { display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:12px }
    #themeToggle{ margin-left:auto; }
    #themeToggle.theme-toggle{
      --h:64px; --w:192px; --pad:8px; --bd:2px;
      --thumb:calc(var(--h) - 2*(var(--pad) + var(--bd)));
      width:var(--w); height:var(--h); border-radius:999px; padding:0; overflow:hidden;
      border:var(--bd) solid #D7E0E2; background:#F4F8F9; cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.65);
      position:relative; z-index:1;
    }
    html[data-theme="dark"] #themeToggle.theme-toggle{
      background:#0F1726; border-color:rgba(255,255,255,.06);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
    }
    #themeToggle .scene{ position:absolute; inset:var(--pad); border-radius:calc(var(--h)/2 - var(--pad));
      overflow:hidden; transition:opacity .28s ease, transform .38s cubic-bezier(.2,.7,.2,1); }
    #themeToggle .scene svg{ position:absolute; inset:0; width:100%; height:100%; display:block; }
    html[data-theme="light"] #themeToggle .scene.light{ opacity:0; transform: translateX(-6px); }
    html[data-theme="light"] #themeToggle .scene.dark { opacity:1; transform: translateX(0); }
    html[data-theme="dark"]  #themeToggle .scene.light{ opacity:1; transform: translateX(0); }
    html[data-theme="dark"]  #themeToggle .scene.dark { opacity:0; transform: translateX(6px); }
    #themeToggle .thumb{
      position:absolute; top:calc(var(--pad) + var(--bd)); left:calc(var(--pad) + var(--bd));
      width:var(--thumb); height:var(--thumb); border-radius:50%; background:#FFF;
      box-shadow: 0 8px 24px rgba(0,0,0,.25), inset 0 0 0 1px rgba(0,0,0,.08), inset 0 1px 0 rgba(0,0,0,.06);
      transform: translateX(0); transition: transform .38s cubic-bezier(.2,.7,.2,1); z-index:3;
    }
    html[data-theme="light"] #themeToggle .thumb{ transform: translateX(calc(var(--w) - 2*(var(--pad) + var(--bd)) - var(--thumb))); }
    html[data-theme="dark"]  #themeToggle .thumb{ transform: translateX(0); }
    @media (max-width: 480px){ #themeToggle.theme-toggle{ --h:44px; --w:148px; --pad:6px; } }
    @media (max-width: 360px){ #themeToggle.theme-toggle{ --h:40px; --w:136px; --pad:6px; } }
    @media (prefers-reduced-motion: reduce){ #themeToggle .scene, #themeToggle .thumb{ transition:none!important; } }
    #themeToggle.theme-toggle .scene{ inset: var(--bd) !important; border-radius: calc(var(--h)/2 - var(--bd)) !important; overflow: hidden !important; }
    #themeToggle.theme-toggle .scene svg{ width: 100% !important; height: 100% !important; display: block !important; }

    /* Long-press destructive button */
    .hold-btn{ --p:0%; position: relative; display: inline-flex; align-items:center; justify-content:center;
      width: 100%; max-width: 520px; height: 56px; padding:0 18px; border-radius:14px; border:1px solid #a11a28;
      color:#ffe3e6; background:linear-gradient(180deg, var(--danger-700), var(--danger-900));
      font-weight:800; letter-spacing:.2px; cursor:pointer; box-shadow:0 12px 24px rgba(220,38,38,.25), inset 0 -2px 0 rgba(255,255,255,.05);
      overflow: hidden; user-select:none; -webkit-user-select:none; transition: transform .04s ease; }
    .hold-btn:disabled{opacity:.6; cursor:not-allowed}
    .hold-btn:active{ transform: scale(.995) }
    .hold-btn .label{ position: relative; z-index:2; text-align:center; padding:0 8px }
    .hold-btn .progress{ position:absolute; inset:0; background:linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,.22));
      transform: translateX(calc(-100% + var(--p))); z-index:1; }

    .card{border-radius:16px; padding:18px}
    .hint{font-size:14px; opacity:.85; margin:16px 0 6px}
    .list{margin-top:8px}
    .list li{margin:6px 0}
    .btns{display:flex; gap:14px; align-items:center; margin-top:16px; flex-wrap:wrap}
    .cancel{height:44px; padding:0 16px; border-radius:12px; border:1px solid var(--border); background:var(--surface); color:var(--text-high); text-decoration:none; display:inline-flex; align-items:center}
    #msg{margin-left:auto}

    :root{
      --bg:#0B1220; --surface:#0E1726; --card:#121C2E; --border:#1F2A3C;
      --text-high:#F3F7FF; --text-low:#93A3BF; --focus-ring:#93C5FD;
      --danger-700:#B91C1C; --danger-900:#7F1D1D;
    }
    body{ background:var(--bg); color:var(--text-high); }
    .card{ background:var(--card); border:1px solid var(--border); box-shadow:0 8px 24px rgba(0,0,0,.35) }
    .muted{ color:var(--text-low) }
    a{ color:#bcd0ff }
        
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1 style="margin:0">Roaccutane Tracker</h1>
      <button id="themeToggle" class="theme-toggle" role="switch" aria-checked="true" aria-label="Переключить тему">
        <span class="scene light">
          <svg viewBox="0 0 260 88" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <defs><linearGradient id="lgLight" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%" stop-color="#5ECFC8"/><stop offset="100%" stop-color="#FFD3A3"/></linearGradient>
            </defs>
            <rect x="0" y="0" width="260" height="88" rx="0" fill="url(#lgLight)"/>
            <g fill="#FFF1E2">
              <g opacity=".85"><circle cx="170" cy="46" r="18"/><circle cx="188" cy="46" r="22"/><circle cx="209" cy="50" r="18"/></g>
              <g opacity=".35"><circle cx="130" cy="54" r="10"/><circle cx="145" cy="56" r="12"/></g>
            </g>
          </svg>
        </span>
        <span class="scene dark">
          <svg viewBox="0 0 260 88" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <defs><linearGradient id="lgDark" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%" stop-color="#1C2140"/><stop offset="100%" stop-color="#2A0F4A"/></linearGradient>
            </defs>
            <rect x="0" y="0" width="260" height="88" rx="0" fill="url(#lgDark)"/>
            <g opacity=".55" style="mix-blend-mode:multiply"><ellipse cx="230" cy="44" rx="58" ry="44" fill="rgba(0,0,0,.22)"/></g>
            <g opacity=".38" style="mix-blend-mode:multiply"><ellipse cx="236" cy="44" rx="82" ry="60" fill="rgba(0,0,0,.15)"/></g>
            <g fill="#3B2A6B"><g opacity=".75"><circle cx="86" cy="52" r="22"/><circle cx="110" cy="50" r="18"/><circle cx="132" cy="54" r="22"/></g>
              <g opacity=".40"><circle cx="46" cy="56" r="18"/><circle cx="64" cy="56" r="14"/></g></g>
            <g fill="#A98DF7" opacity=".8"><circle cx="136" cy="18" r="1.8"/><circle cx="152" cy="24" r="1.4"/><circle cx="170" cy="20" r="1.3"/><circle cx="186" cy="28" r="1.6"/><circle cx="200" cy="22" r="1.2"/></g>
          </svg>
        </span>
        <span class="thumb"></span>
      </button>
    </div>

    <div class="card">
      <p>Это действие удалит ваши локальные отметки и серверные данные, связанные с прогрессом:</p>
      <ul class="list">
        <li>Журнал приёмов (<code>intakes</code>)</li>
        <li>Настройки напоминаний</li>
        <li>Локальные кэши прогресса</li>
      </ul>
      <p class="muted">Профиль и план курса останутся.</p>

      <div class="hint">Удерживайте кнопку ниже, чтобы подтвердить удаление.</div>
      <button id="holdDelete" class="hold-btn" aria-label="Удерживайте, чтобы удалить данные">
        <span class="progress" aria-hidden="true"></span>
        <span class="label">Я понимаю последствия и хочу удалить данные</span>
      </button>

      <div class="btns">
        <a class="cancel" id="btnCancel" href="./main-dark.html">Отмена — вернуться на главную</a>
        <span id="msg" class="muted"></span>
      </div>
    </div>
  </div>

  <script>
    const tgApp = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    tgApp?.ready?.(); tgApp?.expand?.();
    const initData = tgApp?.initData || '';
    const API_BASE = String(window.API_BASE||'').replace(/\/$/, '');
    const devTg = new URLSearchParams(location.search).get('tg') || '1002';

    function api(path, opts={}){
      let url = /^https?:\/\//i.test(path) ? path : (API_BASE + path);
      const params = []; if (!initData && devTg) params.push('tg='+encodeURIComponent(devTg)); params.push('v=reset-2025-08-30');
      url += (url.includes('?') ? '&' : '?') + params.join('&');
      const headers = {'Content-Type':'application/json', ...(opts.headers||{})};
      if (initData) headers['X-Telegram-InitData'] = initData;
      return fetch(url, {...opts, headers});
    }

    (function(){
      const PAGES = { light: 'reset-light.html', dark: 'reset-dark.html' };
      const btn = document.getElementById('themeToggle');
      if(!btn) return;
      btn.addEventListener('click', toggle);
      btn.addEventListener('keydown', (e)=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); toggle(); } });
      function toggle(){
        const next = (document.documentElement.dataset.theme === 'dark') ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        try{ localStorage.setItem('rt.theme', next); }catch(_ ){}
        const target = PAGES[next];
        if(target && !location.pathname.endsWith('/'+target)){ location.href = target + location.search; }
      }
    })();

    const btn = document.getElementById('holdDelete');
    const msg = document.getElementById('msg');
    let raf = null, start = 0, holding = false, duration = 1600;

    function setProgress(p){
      const val = Math.max(0, Math.min(1, p));
      btn.style.setProperty('--p', (val*100)+'%');
    }

    function onDown(e){
      if (btn.disabled) return;
      holding = true;
      start = performance.now();
      setProgress(0);
      tick();
      e.preventDefault?.();
    }
    function onUpCancel(){
      holding = false;
      if (raf){ cancelAnimationFrame(raf); raf = null; }
      setProgress(0);
    }
    function tick(){
      if (!holding) return;
      const t = performance.now();
      const p = (t - start) / duration;
      if (p >= 1){
        holding = false; setProgress(1);
        confirmDelete();
        return;
      }
      setProgress(p);
      raf = requestAnimationFrame(tick);
    }

    btn.addEventListener('pointerdown', onDown);
    ['pointerup','pointercancel','pointerleave'].forEach(ev=>btn.addEventListener(ev, onUpCancel));
    btn.addEventListener('keydown', (e)=>{ if (e.code === 'Space' || e.code === 'Enter'){ onDown(e); } });
    btn.addEventListener('keyup',   (e)=>{ if (e.code === 'Space' || e.code === 'Enter'){ onUpCancel(); } });

    async function confirmDelete(){
      try{
        btn.disabled = true; msg.textContent = 'Удаляю…';
        const r = await api('/api/reset', { method:'POST', body:'{}' });
        if(!r.ok){ msg.textContent = 'Ошибка ' + r.status; btn.disabled=false; setProgress(0); return; }
        try{
          const qs = new URLSearchParams(location.search);
          const uid = qs.get('tg') || (window.Telegram?.WebApp?.initDataUnsafe?.user?.id || '');
          const keys = [
            'derma_seed_cum_mg','derma_remind_optin','derma_remind_time',
            'derma_dose_mode','derma_last_notif','derma_reminded_today',
            'derma_alarm_id','derma_consent','derma_next','derma_splash_seen'
          ];
          keys.forEach(k=>{ try{ localStorage.removeItem(k); }catch(_ ){} });
          if (uid) {
            try{ localStorage.removeItem(`dermaApp:${uid}:splash_seen`); }catch(_ ){}
            try{ localStorage.removeItem(`dermaApp:${uid}:consentAccepted`); }catch(_ ){}
          }
          if ('serviceWorker' in navigator){
            try{ const regs = await navigator.serviceWorker.getRegistrations(); for (const r of regs) await r.unregister(); }catch(_ ){}
          }
          if ('caches' in window){
            try{ const names = await caches.keys(); for (const n of names) await caches.delete(n); }catch(_ ){}
          }
        }catch(_ ){}
        msg.textContent = 'Готово';
        setTimeout(()=>{ location.replace('./welcome-rt.html' + (location.search||'')); }, 450);
      }catch(e){
        msg.textContent = 'Ошибка сети'; btn.disabled=false; setProgress(0);
      }
    }
  </script>
</body>
</html>
