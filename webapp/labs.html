<!doctype html>
<html lang="ru" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Roaccutane Tracker — Анализы</title>
  <meta name="color-scheme" content="dark light">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: #0d1016;
      --card: #151922;
      --card-2: #1b2030;
      --text: #e8ecf5;
      --muted: #9aa4b2;
      --accent: #6ee7b7;
      --warn: #f7b93e;
      --danger: #ef4444;
      --input: #0f1420;
      --border: #2a3040;
      --shadow: 0 6px 24px rgba(0,0,0,.35);
      --radius: 16px;
    }
    @media (prefers-color-scheme: light) {
      :root{
        --bg:#f7f7fb;
        --card:#ffffff;
        --card-2:#ffffff;
        --text:#0f1115;
        --muted:#576077;
        --accent:#10b981;
        --warn:#f59e0b;
        --danger:#ef4444;
        --input:#f2f4f8;
        --border:#e7e9ef;
        --shadow: 0 6px 18px rgba(0,0,0,.06);
      }
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font: 15.5px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      display:flex; flex-direction:column;
    }

    header{
      position:sticky; top:0; z-index:20;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px; display:flex; align-items:center; gap:12px;
    }
    .app-title{font-weight:700; letter-spacing:.2px}

    .wrap{
      max-width: 720px; width:100%;
      margin:0 auto; padding:16px; box-sizing:border-box; flex:1 0 auto;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    h1{font-size:22px; margin:0 0 8px}
    h2{font-size:18px; margin:0 0 10px}
    .muted{color:var(--muted); font-size:13.5px}

    .grid{display:grid; gap:12px}
    .grid.cols-2{ grid-template-columns: 1fr 1fr }
    @media (max-width: 760px){ .grid.cols-2{ grid-template-columns:1fr } }

    .row{display:grid; gap:10px}
    .field{
      display:grid; gap:8px; align-items:center;
      grid-template-columns: 1fr 130px max-content;
      padding:10px 12px; border: 1px solid var(--border); border-radius:12px; background:var(--card-2);
      overflow:hidden;
    }
    @media (max-width: 420px){
      .field{ grid-template-columns: 1fr; align-items:start }
    }
    .name{font-weight:600; min-width:0}
    .unit{opacity:.8; font-size:12px; margin-left:6px}
    .field input{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background: var(--input); color: var(--text); outline: none;
    }
    .range{color:var(--muted); font-size:13px; white-space:nowrap}
    .chip{
      display:inline-flex; align-items:center; gap:6px; font-size:12px; font-weight:700;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border);
    }
    .chip.ok{ color:#10b981; background:#0e1a16 }
    .chip.warn{ color:var(--warn); background:#201a0b }
    .chip.bad{ color:var(--danger); background:#241013 }

    .toolbar{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .btn{
      appearance:none; border:1px solid var(--border); background:var(--card-2); color:var(--text);
      border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:700;
    }
    .btn.primary{ background: linear-gradient(180deg, var(--accent), color-mix(in oklab, var(--accent) 70%, #000)); border:none; color:#001310 }
    .btn:disabled{ opacity:.5; cursor:not-allowed }

    .seg{
      display:inline-grid; grid-auto-flow:column; gap:0; border:1px solid var(--border); border-radius:12px; overflow:hidden;
    }
    .seg button{ padding:8px 12px; border:none; background:var(--card-2); color:var(--text); cursor:pointer }
    .seg button.active{ background:var(--accent); color:#001310; font-weight:800 }

    .note-wrap{ background: var(--card-2); border:1px dashed var(--border); border-radius:12px; padding:12px }

    .uploader{ border: 1px dashed var(--border); border-radius:14px; padding:14px; text-align:center; background:var(--card-2); }
    .thumbs{ display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px }
    .thumb{ position:relative; border-radius:12px; overflow:hidden; border:1px solid var(--border); background:#000; aspect-ratio: 1 / 1; }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block }
    .thumb .del{ position:absolute; top:6px; right:6px; background: rgba(0,0,0,.6); color:#fff; border:none; border-radius:10px; padding:4px 8px; font-size:12px; cursor:pointer }
    .thumb .open{ position:absolute; left:6px; bottom:6px; background: rgba(0,0,0,.6); color:#fff; border:none; border-radius:10px; padding:4px 8px; font-size:12px; cursor:pointer }

    /* Fullscreen viewer (hidden by default via inline style in HTML) */
    .viewer{ position:fixed; inset:0; background: rgba(0,0,0,.9); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .viewer img{ max-width:95vw; max-height:90vh; display:block; border-radius:10px }
    .viewer .close{ position:absolute; top:14px; right:14px; background:#000; color:#fff; border:none; border-radius:10px; padding:8px 12px; cursor:pointer }

    /* Reports — accordion */
    .rep-list{ display:grid; gap:10px }
    .rep-item{ background: var(--card); border:1px solid var(--border); border-radius:12px; }
    .rep-toggle{ width:100%; background:transparent; color:var(--text); border:0; text-align:left; padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:8px; cursor:pointer }
    .rep-title{ font-weight:700 }
    .rep-meta{ display:flex; gap:6px; align-items:center; }
    .badge{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:var(--card-2) }
    .badge.bad{ color:var(--danger); border-color: color-mix(in oklab, var(--danger) 50%, var(--border)) }
    .badge.warn{ color:var(--warn); border-color: color-mix(in oklab, var(--warn) 50%, var(--border)) }
    .chev{ transition: transform .2s ease; opacity:.8 }
    .rep-item.open .chev{ transform: rotate(90deg) }
    .rep-panel{ overflow:hidden; max-height:0; transition:max-height .25s ease; padding:0 14px }
    .rep-item.open .rep-panel{ padding: 0 14px 12px; }
    .rep-body{ font-size:13px; color:var(--muted) }
    .rep-table{ width:100%; border-collapse:collapse; margin-top:6px; font-size:13px }
    .rep-table th, .rep-table td{ padding:4px 6px; border-bottom:1px dashed var(--border); text-align:left }
    .rep-table th{ color:var(--muted); font-weight:600 }
    .rep-actions{ display:flex; gap:8px; margin-top:10px }

    .bottom-nav{
      position: fixed; left: 0; right: 0; bottom: 0;
      background: var(--card);
      border-top: 1px solid var(--border);
      display:flex; justify-content: space-around; align-items: center;
      padding: 8px max(env(safe-area-inset-left),12px) calc(8px + env(safe-area-inset-bottom)) max(env(safe-area-inset-right),12px);
      z-index: 2000;
    }
    .tab{ display:flex; flex-direction:column; align-items:center; gap:4px; min-width: 56px; padding: 6px 10px; border-radius: 12px; color: #cbd5e1; text-decoration:none; font-size:12px; }
    .tab svg{ width:22px; height:22px; opacity:.9 }
    .tab.active{ background: #232b3a; color: #e9eef7; }
    .tab:active{ transform: translateY(1px) }

    .bottom-spacer{ height: calc(64px + env(safe-area-inset-bottom)); }
    
    .page{ opacity: 0; transform: translateY(8px); animation: fadeSlideIn .28s ease forwards; }
    @keyframes fadeSlideIn { to { opacity:1; transform: translateY(0); } }
    .page.exit{ opacity: 0; transform: translateY(8px); transition: opacity .28s ease, transform .28s ease; }
  </style>
</head>
<body>
  <header>
    <div class="app-title">Roaccutane Tracker</div>
  </header>

  <div class="wrap page" id="pageRoot">
    <div class="card" style="margin-bottom:14px;">
      <h1>Анализы</h1>
      <div class="muted">Классические показатели во время курса ретиноидов. Введите свои значения — справа увидите норму и статус. Диапазоны ориентировочные, ориентируйтесь на бланк вашей лаборатории.</div>
    </div>

    <div class="card" style="margin-bottom:14px;">
      <div class="toolbar" style="justify-content:space-between; margin-bottom:8px;">
        <div class="toolbar" style="gap:12px;">
          <strong>Пол:</strong>
          <div class="seg" id="sexSeg">
            <button type="button" data-sex="female" class="active">Ж</button>
            <button type="button" data-sex="male">М</button>
          </div>
        </div>
        <div class="muted" id="updatedLbl">Не сохранено</div>
      </div>

      <div class="grid cols-2">
        <div class="grid">
          <h2>Печёночные и билирубин</h2>
          <div class="row">
            <div class="field" data-key="ALT">
              <div class="name">АЛТ (ALT) <span class="unit">Ед/л</span></div>
              <input type="number" step="0.1" inputmode="decimal" placeholder="например, 22" />
              <div class="range">0–35 <span class="dyn-range" data-f="0–35" data-m="0–45" hidden></span></div>
              <div class="chip ok">—</div>
            </div>
            <div class="field" data-key="AST">
              <div class="name">АСТ (AST) <span class="unit">Ед/л</span></div>
              <input type="number" step="0.1" inputmode="decimal" placeholder="например, 20" />
              <div class="range">0–35 <span class="dyn-range" data-f="0–35" data-m="0–40" hidden></span></div>
              <div class="chip ok">—</div>
            </div>
            <div class="field" data-key="BILIRUBIN">
              <div class="name">Общий билирубин <span class="unit">мкмоль/л</span></div>
              <input type="number" step="0.1" inputmode="decimal" placeholder="например, 12" />
              <div class="range">3–21</div>
              <div class="chip ok">—</div>
            </div>
            <div class="field" data-key="ALP">
              <div class="name">ЩФ (ALP) <span class="unit">Ед/л</span></div>
              <input type="number" step="1" inputmode="decimal" placeholder="например, 75" />
              <div class="range">40–130</div>
              <div class="chip ok">—</div>
            </div>
          </div>
        </div>

        <div class="grid">
          <h2>Липидный профиль</h2>
          <div class="row">
            <div class="field" data-key="TG">
              <div class="name">Триглицериды <span class="unit">ммоль/л</span></div>
              <input type="number" step="0.01" inputmode="decimal" placeholder="например, 1.1" />
              <div class="range">0.4–1.7</div>
              <div class="chip ok">—</div>
            </div>
            <div class="field" data-key="TC">
              <div class="name">Общий холестерин <span class="unit">ммоль/л</span></div>
              <input type="number" step="0.01" inputmode="decimal" placeholder="например, 4.6" />
              <div class="range">3.0–5.2</div>
              <div class="chip ok">—</div>
            </div>
            <div class="field" data-key="LDL">
              <div class="name">ЛПНП (LDL) <span class="unit">ммоль/л</span></div>
              <input type="number" step="0.01" inputmode="decimal" placeholder="например, 2.7" />
              <div class="range">&lt; 3.0</div>
              <div class="chip ok">—</div>
            </div>
            <div class="field" data-key="HDL">
              <div class="name">ЛПВП (HDL) <span class="unit">ммоль/л</span></div>
              <input type="number" step="0.01" inputmode="decimal" placeholder="например, 1.4" />
              <div class="range"><span class="dyn-hdl" data-f="&gt; 1.2" data-m="&gt; 1.0">&gt; 1.2</span></div>
              <div class="chip ok">—</div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:12px;">
        <div class="grid">
          <h2>Глюкоза</h2>
          <div class="row">
            <div class="field" data-key="GLU">
              <div class="name">Глюкоза натощак <span class="unit">ммоль/л</span></div>
              <input type="number" step="0.01" inputmode="decimal" placeholder="например, 4.9" />
              <div class="range">3.9–5.6</div>
              <div class="chip ok">—</div>
            </div>
          </div>
        </div>
        <div class="grid">
          <h2>Примечание</h2>
          <div class="note-wrap">
            <div class="muted">Диапазоны могут отличаться по методике лаборатории. При значениях выше нормы (особенно триглицериды и АЛТ/АСТ) свяжитесь с лечащим врачом — на ретиноидах допустимы изменения, но резкие отклонения требуют коррекции дозы или паузы.</div>
          </div>
        </div>
      </div>

      <div class="toolbar" style="margin-top:12px; justify-content:flex-end; flex-wrap:wrap;">
        <button class="btn" id="clearBtn" title="Очистить значения">Сбросить</button>
        <button class="btn" id="saveReportBtn" title="Сохранить текущие значения как отчёт">Сохранить как отчёт</button>
        <button class="btn primary" id="saveBtn">Сохранить значения</button>
      </div>
    </div>

    <div class="card" style="margin-bottom:14px;">
      <h2>Фото анализов</h2>
      <div class="uploader">
        <input type="file" id="fileInput" accept="image/*" multiple style="display:none" />
        <div class="toolbar" style="justify-content:center;">
          <button class="btn" id="addPhotosBtn">Загрузить фото</button>
          <div class="muted">Поддерживаются JPG/PNG/HEIC (если браузер поддерживает). Фото сохраняются локально на устройстве.</div>
        </div>
      </div>
      <div class="thumbs" id="thumbs" style="margin-top:12px"></div>
    </div>

    <!-- Viewer hidden by default -->
    <div class="viewer" id="viewer" style="display:none" aria-hidden="true">
      <button class="close" id="viewerClose" style="display:none">Закрыть</button>
      <img id="viewerImg" alt="Фото анализа" style="display:none" />
    </div>

    <div class="card" style="margin-bottom:14px;">
      <h2>Внутренние отчёты</h2>
      <div class="muted" style="margin-bottom:8px;">Сохраняются только на этом устройстве. Для врача используйте официальный бланк лаборатории.</div>
      <div id="reportsList" class="rep-list"></div>
    </div>

    <div class="bottom-spacer"></div>
  </div>

  <nav class="bottom-nav">
    <a class="tab" id="navHome">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 11.5L12 4l9 7.5"></path>
        <path d="M5 10.5V20a1 1 0 0 0 1 1h4v-6h4v6h4a1 1 0 0 0 1-1v-9.5"></path>
      </svg>
      <span>Главная</span>
    </a>
    <a class="tab" id="navCalendar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2"></rect>
        <path d="M16 2v4M8 2v4M3 10h18"></path>
      </svg>
      <span>Календарь</span>
    </a>
    <a class="tab" id="navProfile">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="8" r="4"></circle>
        <path d="M4 20a8 8 0 0 1 16 0"></path>
      </svg>
      <span>Профиль</span>
    </a>
    <a class="tab" id="navDiary">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="5" width="18" height="14" rx="2"></rect>
        <path d="M8 13l2.5-2.5L14 14l2-2 3 3"></path>
      </svg>
      <span>Фотодневник</span>
    </a>
    <a class="tab active" id="navLabs">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <path d="M6 2h12"></path>
        <path d="M9 2v4l-5 8a6 6 0 0 0 6 8h4a6 6 0 0 0 6-8l-5-8V2"></path>
      </svg>
      <span>Анализы</span>
    </a>
  </nav>

<script>
(function(){
  const pageRoot = document.getElementById('pageRoot');

  // --- DOM refs
  const sexSeg = document.getElementById('sexSeg');
  const updatedLbl = document.getElementById('updatedLbl');
  const fileInput = document.getElementById('fileInput');
  const addPhotosBtn = document.getElementById('addPhotosBtn');
  const thumbs = document.getElementById('thumbs');
  const viewer = document.getElementById('viewer');
  const viewerImg = document.getElementById('viewerImg');
  const viewerClose = document.getElementById('viewerClose');
  const reportsList = document.getElementById('reportsList');
  const saveReportBtn = document.getElementById('saveReportBtn');

  // --- State
  let sex = (localStorage.getItem('labs.sex') || 'female');
  let values = JSON.parse(localStorage.getItem('labs.values') || '{}');
  let photos = JSON.parse(localStorage.getItem('labs.photos') || '[]');
  let reports = JSON.parse(localStorage.getItem('labs.reports') || '[]'); // array of report objects

  // --- Sex toggle
  sexSeg.querySelectorAll('button').forEach(btn=>{
    if(btn.dataset.sex===sex) btn.classList.add('active');
    btn.addEventListener('click', ()=>{
      sex = btn.dataset.sex;
      sexSeg.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b===btn));
      localStorage.setItem('labs.sex', sex);
      applySexRanges();
      recomputeAll();
    });
  });

  function applySexRanges(){
    const hdl = document.querySelector('.dyn-hdl');
    if(!hdl) return;
    hdl.textContent = (sex==='female')? hdl.getAttribute('data-f') : hdl.getAttribute('data-m');
  }

  // --- Ranges & status
  function rangesFor(key){
    if(key==='ALT') return (sex==='female')? {min:0, max:35} : {min:0, max:45};
    if(key==='AST') return (sex==='female')? {min:0, max:35} : {min:0, max:40};
    if(key==='BILIRUBIN') return {min:3, max:21};
    if(key==='ALP') return {min:40, max:130};
    if(key==='TG') return {min:0.4, max:1.7};
    if(key==='TC') return {min:3.0, max:5.2};
    if(key==='LDL') return {lt:3.0};
    if(key==='HDL') return (sex==='female')? {gt:1.2} : {gt:1.0};
    if(key==='GLU') return {min:3.9, max:5.6};
    return null;
  }

  function statusFor(key, val){
    if(val==='' || isNaN(val)) return {cls:'ok', label:'—', icon:''};
    const x = Number(val);
    const r = rangesFor(key);
    if(!r) return {cls:'ok', label:'—', icon:''};
    if('lt' in r){
      if(x < r.lt) return {cls:'ok', label:'OK', icon:'✓'};
      if(x < r.lt*1.2) return {cls:'warn', label:'Погранично', icon:'↑'};
      return {cls:'bad', label:'Высокий', icon:'↑↑'};
    }
    if('gt' in r){
      if(x > r.gt) return {cls:'ok', label:'OK', icon:'✓'};
      if(x > r.gt*0.9) return {cls:'warn', label:'Низковато', icon:'↓'};
      return {cls:'bad', label:'Низкий', icon:'↓↓'};
    }
    if(x>=r.min && x<=r.max) return {cls:'ok', label:'OK', icon:'✓'};
    const pad = (r.max - r.min) * 0.1;
    if(x>r.max && x <= r.max + pad) return {cls:'warn', label:'Выше нормы', icon:'↑'};
    if(x<r.min && x >= r.min - pad) return {cls:'warn', label:'Ниже нормы', icon:'↓'};
    return {cls:'bad', label: x>r.max ? 'Высокий' : 'Низкий', icon: x>r.max ? '↑↑' : '↓↓'};
  }

  function recomputeAll(){
    document.querySelectorAll('.field').forEach(box=>{
      const key = box.getAttribute('data-key');
      const input = box.querySelector('input');
      const chip = box.querySelector('.chip');
      const st = statusFor(key, input.value);
      chip.className = 'chip ' + st.cls;
      chip.textContent = st.label;
    });
  }

  // preload existing values (persist between sessions)
  document.querySelectorAll('.field').forEach(box=>{
    const key = box.getAttribute('data-key');
    const input = box.querySelector('input');
    if(values[key]!==undefined) input.value = values[key];
    input.addEventListener('input', ()=>{
      recomputeAll();
      updatedLbl.textContent = 'Есть несохранённые изменения';
    });
  });

  // Explicit save: persists "навсегда" до следующего изменения
  document.getElementById('saveBtn').addEventListener('click', ()=>{
    const out = {};
    document.querySelectorAll('.field').forEach(box=>{
      const key = box.getAttribute('data-key');
      const input = box.querySelector('input');
      const v = input.value;
      if(v!=='' && !isNaN(Number(v))) out[key] = Number(v);
    });
    values = out;
    localStorage.setItem('labs.values', JSON.stringify(values));
    const ts = new Date();
    updatedLbl.textContent = 'Сохранено: ' + ts.toLocaleString();
  });

  document.getElementById('clearBtn').addEventListener('click', ()=>{
    document.querySelectorAll('.field input').forEach(i=> i.value='');
    values = {};
    localStorage.removeItem('labs.values');
    updatedLbl.textContent = 'Очищено';
    recomputeAll();
  });

  // --- Reports
  const NAMES = {
    ALT: 'АЛТ (ALT)', AST: 'АСТ (AST)', BILIRUBIN: 'Общий билирубин',
    ALP: 'ЩФ (ALP)', TG: 'Триглицериды', TC: 'Общий холестерин',
    LDL: 'ЛПНП (LDL)', HDL: 'ЛПВП (HDL)', GLU: 'Глюкоза натощак'
  };
  const UNITS = {
    ALT:'Ед/л', AST:'Ед/л', BILIRUBIN:'мкмоль/л', ALP:'Ед/л',
    TG:'ммоль/л', TC:'ммоль/л', LDL:'ммоль/л', HDL:'ммоль/л', GLU:'ммоль/л'
  };
  function rangeText(key){
    if(key==='ALT') return (sex==='female')? '0–35 Ед/л' : '0–45 Ед/л';
    if(key==='AST') return (sex==='female')? '0–35 Ед/л' : '0–40 Ед/л';
    if(key==='BILIRUBIN') return '3–21 мкмоль/л';
    if(key==='ALP') return '40–130 Ед/л';
    if(key==='TG') return '0.4–1.7 ммоль/л';
    if(key==='TC') return '3.0–5.2 ммоль/л';
    if(key==='LDL') return '< 3.0 ммоль/л';
    if(key==='HDL') return (sex==='female')? '> 1.2 ммоль/л' : '> 1.0 ммоль/л';
    if(key==='GLU') return '3.9–5.6 ммоль/л';
    return '';
  }
  function collectCurrent(){
    const out = {};
    document.querySelectorAll('.field').forEach(box=>{
      const key = box.getAttribute('data-key');
      const input = box.querySelector('input');
      const v = input.value;
      if(v!=='' && !isNaN(Number(v))) out[key] = Number(v);
    });
    return out;
  }
  function buildReport(){
    const vals = collectCurrent();
    const entries = Object.keys(NAMES).map(k=>{
      const v = (k in vals) ? vals[k] : null;
      const st = statusFor(k, v==null? '' : String(v));
      return { key:k, name:NAMES[k], value:v, unit:UNITS[k], range:rangeText(k), status:st };
    });
    const abn = entries.filter(e => e.value!=null && e.status.cls!=='ok');
    return {
      ts: Date.now(), sex,
      entries, abnCount: abn.length
    };
  }
  function reportTitle(rep){
    const d = new Date(rep.ts);
    const dd = d.toLocaleDateString();
    const tt = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    return `${dd} ${tt} • ${rep.sex==='female'?'Ж':'М'}`;
  }
  function reportText(rep){
    let lines = [];
    lines.push(`Отчёт по анализам — ${reportTitle(rep)}`);
    lines.push('');
    rep.entries.forEach(e=>{
      if(e.value==null) return;
      lines.push(`${e.name}: ${e.value} ${e.unit} (норма ${e.range}) — ${e.status.label}`);
    });
    if(rep.abnCount>0){
      lines.push('');
      lines.push(`Отклонения: ${rep.entries.filter(e=>e.value!=null && e.status.cls!=='ok').map(e=>`${e.name} ${e.status.icon}`).join(', ')}`);
    }
    return lines.join('\n');
  }
  function saveReport(){
    const rep = buildReport();
    const hasAny = rep.entries.some(e=> e.value!=null);
    if(!hasAny){
      saveReportBtn.textContent = 'Нет значений';
      setTimeout(()=> saveReportBtn.textContent='Сохранить как отчёт', 1000);
      return;
    }
    reports.unshift(rep);
    localStorage.setItem('labs.reports', JSON.stringify(reports));
    renderReports(rep.ts); // auto-open freshly saved
    saveReportBtn.textContent = 'Сохранено ✓';
    setTimeout(()=> saveReportBtn.textContent='Сохранить как отчёт', 1200);
  }
  saveReportBtn.addEventListener('click', saveReport);

  function toggleItem(el, open){
    if(open===undefined) open = !el.classList.contains('open');
    el.classList.toggle('open', open);
    const panel = el.querySelector('.rep-panel');
    if(open){
      panel.style.maxHeight = panel.scrollHeight + 'px';
    }else{
      panel.style.maxHeight = '0px';
    }
  }

  function renderReports(openTs){
    reportsList.innerHTML = '';
    if(!reports.length){
      const m = document.createElement('div');
      m.className='muted';
      m.textContent = 'Отчётов пока нет. Заполните значения и нажмите «Сохранить как отчёт».';
      reportsList.appendChild(m);
      return;
    }
    reports.forEach((rep)=>{
      const item = document.createElement('div');
      item.className = 'rep-item';

      const btn = document.createElement('button');
      btn.className = 'rep-toggle';
      const title = document.createElement('div');
      title.className = 'rep-title';
      title.textContent = reportTitle(rep);
      const meta = document.createElement('div');
      meta.className = 'rep-meta';
      if(rep.abnCount>0){
        const b = document.createElement('span');
        b.className = 'badge ' + (rep.abnCount>1?'bad':'warn');
        b.textContent = rep.abnCount===1 ? '1 отклонение' : rep.abnCount + ' отклонения';
        meta.appendChild(b);
      } else {
        const b = document.createElement('span');
        b.className = 'badge';
        b.textContent = 'Без отклонений';
        meta.appendChild(b);
      }
      const chev = document.createElement('span');
      chev.className = 'chev';
      chev.textContent = '›';
      btn.appendChild(title);
      btn.appendChild(meta);
      btn.appendChild(chev);

      const panel = document.createElement('div');
      panel.className = 'rep-panel';

      const body = document.createElement('div');
      body.className = 'rep-body';
      const table = document.createElement('table');
      table.className = 'rep-table';
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr><th>Показатель</th><th>Значение</th><th>Норма</th><th>Статус</th></tr>';
      table.appendChild(thead);
      const tb = document.createElement('tbody');
      rep.entries.forEach(e=>{
        if(e.value==null) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${e.name}</td><td>${e.value} ${e.unit}</td><td>${e.range}</td><td>${e.status.label}</td>`;
        tb.appendChild(tr);
      });
      table.appendChild(tb);
      body.appendChild(table);

      const actions = document.createElement('div');
      actions.className = 'rep-actions';
      const btnCopy = document.createElement('button');
      btnCopy.className = 'btn';
      btnCopy.textContent = 'Скопировать';
      btnCopy.addEventListener('click', async ()=>{
        const txt = reportText(rep);
        try{
          await navigator.clipboard.writeText(txt);
          btnCopy.textContent = 'Скопировано ✓';
        }catch(_){
          const ta = document.createElement('textarea');
          ta.value = txt; document.body.appendChild(ta); ta.select();
          try{ document.execCommand('copy'); btnCopy.textContent = 'Скопировано ✓'; }catch(__){ btnCopy.textContent='Ошибка копирования'; }
          ta.remove();
        }
        setTimeout(()=> btnCopy.textContent='Скопировать', 1200);
      });
      const btnDl = document.createElement('a');
      btnDl.className = 'btn';
      btnDl.textContent = 'Скачать .txt';
      btnDl.href = '#';
      btnDl.addEventListener('click', (e)=>{
        e.preventDefault();
        const blob = new Blob([reportText(rep)], {type:'text/plain;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        btnDl.href = url;
        const d = new Date(rep.ts);
        btnDl.download = `labs-report-${d.toISOString().slice(0,16).replace(/[:T]/g,'-')}.txt`;
        setTimeout(()=> URL.revokeObjectURL(url), 15000);
      });
      const btnDel = document.createElement('button');
      btnDel.className = 'btn';
      btnDel.textContent = 'Удалить';
      btnDel.addEventListener('click', ()=>{
        if(!confirm('Удалить этот отчёт?')) return;
        reports = reports.filter(r => r.ts !== rep.ts);
        localStorage.setItem('labs.reports', JSON.stringify(reports));
        renderReports();
      });
      actions.appendChild(btnCopy);
      actions.appendChild(btnDl);
      actions.appendChild(btnDel);

      panel.appendChild(body);
      panel.appendChild(actions);

      item.appendChild(btn);
      item.appendChild(panel);
      reportsList.appendChild(item);

      btn.addEventListener('click', ()=> toggleItem(item));
      if(openTs && rep.ts === openTs){
        toggleItem(item, true);
      }
    });
  }
  renderReports();

  // --- Gallery
  function renderThumbs(){
    thumbs.innerHTML = '';
    if(!photos.length){
      const empty = document.createElement('div');
      empty.className='muted';
      empty.textContent='Галерея пуста. Загрузите фото бланка или результатов.';
      thumbs.appendChild(empty);
      return;
    }
    photos.forEach((p, idx)=>{
      const t = document.createElement('div'); t.className='thumb';
      const img = document.createElement('img'); img.src = p.data; img.alt = 'Фото анализа';
      const del = document.createElement('button'); del.className='del'; del.textContent='Удалить';
      const open = document.createElement('button'); open.className='open'; open.textContent='Открыть';
      del.addEventListener('click', ()=>{
        photos.splice(idx,1);
        localStorage.setItem('labs.photos', JSON.stringify(photos));
        renderThumbs();
      });
      open.addEventListener('click', ()=>{
        viewerImg.src = p.data;
        viewer.style.display = 'flex';
        viewer.removeAttribute('aria-hidden');
        viewerClose.style.display = 'inline-block';
        viewerImg.style.display = 'block';
      });
      t.appendChild(img); t.appendChild(del); t.appendChild(open);
      thumbs.appendChild(t);
    });
  }
  renderThumbs();
  viewerClose.addEventListener('click', ()=>{
    viewer.style.display = 'none';
    viewer.setAttribute('aria-hidden','true');
    viewerClose.style.display = 'none';
    viewerImg.style.display = 'none';
  });
  viewer.addEventListener('click', (e)=>{
    if(e.target===viewer){
      viewer.style.display = 'none';
      viewer.setAttribute('aria-hidden','true');
      viewerClose.style.display = 'none';
      viewerImg.style.display = 'none';
    }
  });

  async function compressImage(file, maxDim=1600, quality=0.9){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = ()=>{
        const img = new Image();
        img.onload = ()=>{
          const scale = Math.min(1, maxDim/Math.max(img.width,img.height));
          const canvas = document.createElement('canvas');
          canvas.width = Math.round(img.width*scale);
          canvas.height = Math.round(img.height*scale);
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          canvas.toBlob((blob)=>{
            const r2 = new FileReader();
            r2.onload = ()=> resolve(r2.result);
            r2.onerror = reject;
            r2.readAsDataURL(blob);
          }, 'image/jpeg', quality);
        };
        img.onerror = reject;
        img.src = reader.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  addPhotosBtn.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files || []);
    if(!files.length) return;
    addPhotosBtn.disabled = true; addPhotosBtn.textContent = 'Обработка...';
    for(const f of files){
      try{
        const dataUrl = await compressImage(f);
        photos.unshift({data:dataUrl, ts: Date.now()});
      }catch(_){}
    }
    localStorage.setItem('labs.photos', JSON.stringify(photos));
    renderThumbs();
    addPhotosBtn.disabled = false; addPhotosBtn.textContent = 'Загрузить фото';
    fileInput.value = '';
  });

  // --- Fade+slide navigation
  function navigateWithFx(url){
    pageRoot.classList.add('exit');
    const done = ()=> window.location.href = url;
    let handled = false;
    pageRoot.addEventListener('transitionend', ()=>{ if(!handled){ handled=true; done(); } }, {once:true});
    setTimeout(()=>{ if(!handled) done(); }, 320);
    getComputedStyle(pageRoot).opacity;
    pageRoot.style.opacity = '0';
    pageRoot.style.transform = 'translateY(8px)';
  }
  document.getElementById('navHome').addEventListener('click', (e)=>{ e.preventDefault(); navigateWithFx('main-dark.html'); });
  document.getElementById('navProfile').addEventListener('click', (e)=>{ e.preventDefault(); navigateWithFx('myprofile.html'); });

  try{ Telegram.WebApp.ready(); Telegram.WebApp.expand(); }catch(_){}
})();
</script>
</body>
</html>
