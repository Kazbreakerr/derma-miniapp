<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roaccutane Tracker — загрузка</title>
  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- 1) Перехват /api/* — прокинуть initData в заголовок и в URL (fallback) -->
  <script>
  (function patchFetchForTelegram(){
    const origFetch = window.fetch;
    window.fetch = function(input, init) {
      let url = (typeof input === 'string') ? input : (input && input.url) || String(input || '');
      init = init || {};

      if (url.startsWith('/api/')) {
        const initData = window.Telegram?.WebApp?.initData || '';
        const headers = new Headers(init.headers || {});
        if (initData) headers.set('X-Telegram-InitData', initData);

        const u = new URL(url, location.origin);
        if (initData) u.searchParams.set('tgWebAppData', initData);
        u.searchParams.set('v', Date.now());

        return origFetch(u.toString(), { ...init, headers, credentials:'include' });
      }
      return origFetch(input, init);
    };
  })();
  </script>

  <!-- 2) Глобальный helper window.api -->
  <script>
  window.api = function api(path, opts){
    opts = opts || {};
    const base     = String(window.API_BASE || '').replace(/\/$/,'');
    const initData = window.Telegram?.WebApp?.initData || '';
    const devTg    = new URLSearchParams(location.search).get('tg'); // только вне Telegram

    const headers = Object.assign({'Content-Type':'application/json'}, opts.headers || {});
    if (initData) headers['X-Telegram-InitData'] = initData;

    let url = base + path;
    if (!initData && devTg) url += (url.includes('?')?'&':'?') + 'tg=' + encodeURIComponent(devTg);
    url += (url.includes('?')?'&':'?') + 'v=' + Date.now();
    if (initData) url += '&tgWebAppData=' + encodeURIComponent(initData);

    return fetch(url, { ...opts, headers, credentials:'include' });
  };
  </script>

  <!-- 3) ЕДИНЫЙ РОУТЕР v3: splash один раз, учитываем derma_next -->
  <script>
  (function(){
    const qs = location.search || '';
    const sp = new URLSearchParams(qs);
    const tgId = sp.get('tg') || (window.Telegram?.WebApp?.initDataUnsafe?.user?.id || '');

    // reset=/index.html?tg=1002&reset=1 — очистка LS
    if (sp.get('reset') === '1') {
      try {
        localStorage.removeItem('derma_consent');
        localStorage.removeItem('derma_next');
        localStorage.removeItem('derma_splash_seen');
        if (tgId) {
          localStorage.removeItem(`dermaApp:${tgId}:consentAccepted`);
          localStorage.removeItem(`dermaApp:${tgId}:splash_seen`);
        }
      } catch(_) {}
      sp.delete('reset');
    }

    // Если явно задан следующий шаг — идём туда (минуем splash, чтобы не было циклов)
    const nextStage = (localStorage.getItem('derma_next') || '').trim();
    if (nextStage) {
      try { localStorage.removeItem('derma_next'); } catch(_) {}
      const tail = sp.toString() ? ('?' + sp.toString()) : '';
      const m = { profile:'profile-dark.html', plan:'plan-dark.html', main:'main-dark.html' };
      if (m[nextStage]) { location.replace('./' + m[nextStage] + tail); return; }
      if (nextStage === 'welcome') { location.replace('./welcome-rt.html' + tail); return; }
    }

    function goToSplash(nextPage){
      sp.set('next', nextPage);
      location.replace('./splash-video.html?' + sp.toString());
    }

    // 1) без согласия – после splasha идём на welcome
    const hasConsent =
      (localStorage.getItem('derma_consent') === '1') ||
      (tgId && localStorage.getItem(`dermaApp:${tgId}:consentAccepted`) === '1');

    if (!hasConsent) {
      return goToSplash('./welcome-rt.html');
    }
    // если роль = doctor — маршрут всегда через welcome ветку врача
const role = localStorage.getItem('rt_role') || '';
if (role === 'doctor') {
  return goToSplash('./welcome-rt.html');
}

    // 2) иначе решаем по API: profile → plan → main
    (async () => {
    try {
      const meR = await window.api('/api/me');
      const me  = meR.ok ? await meR.json() : null;

      if (me && (me.fresh_user || me.is_fresh_user)) {
        try {
          localStorage.removeItem('derma_consent');
          localStorage.removeItem('derma_next');
          if (tgId) {
            localStorage.removeItem(`dermaApp:${tgId}:consentAccepted`);
            localStorage.removeItem(`dermaApp:${tgId}:splash_seen`);
            localStorage.removeItem('rt_patient_done');
            localStorage.removeItem('rt_doctor_done');
            localStorage.removeItem('rt_role');
            localStorage.removeItem('rt_seen_warnings');
          }
        } catch(_) {}
        return goToSplash('./welcome-rt.html');
      }

      const hasWeight = !!(me && Number(me.weight_kg ?? me.weight) > 0);
      if (!hasWeight) return goToSplash('./profile-dark.html');

      const planR = await window.api('/api/plan');
      const plan  = planR.ok ? await planR.json() : null;
      const hasPlan = !!(plan && (plan.id || plan.start_date || plan.capsule_mg));

      // БЫЛО: goToSplash(hasPlan ? './main-dark.html' : './plan-dark.html');
      // СТАЛО: второй и более заход пациента → через welcome
      if (hasPlan) {
        return goToSplash('./welcome-rt.html');
      }
      return goToSplash('./plan-dark.html');
    } catch (_){
      return goToSplash('./profile-dark.html');
    }
  })();
  })();
  </script>

  <!-- ЛЁГКИЙ ЭКРАН ЗАГРУЗКИ -->
  <style>
    :root{
      --bg:#0B1220; --card:#101a2a; --border:#1F2A3C;
      --text:#E8F0FF; --muted:#9fb3d6; --teal:#14B8A6; --blue:#60A5FA;
    }
    html,body{height:100%}
    body{
      margin:0; min-height:100dvh; display:grid; place-items:center;
      background:
        radial-gradient(100% 60% at 20% 0%, rgba(20,184,166,.10), transparent 60%),
        radial-gradient(100% 60% at 80% 10%, rgba(96,165,250,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Manrope,Helvetica,Arial;
    }
    .box{
      width:min(680px,92vw);
      background:linear-gradient(180deg,#0e1726,#0c1422);
      border:1px solid var(--border);
      border-radius:20px; padding:24px 22px; box-shadow:0 18px 48px rgba(0,0,0,.4);
      position:relative; overflow:hidden;
    }
    .glow{position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(120% 80% at 10% 0%, rgba(20,184,166,.18), transparent 55%),
        radial-gradient(120% 80% at 90% 20%, rgba(96,165,250,.18), transparent 65%)}
    .row{display:flex; align-items:center; gap:16px}
    h1{margin:0 0 8px; font-size:28px; line-height:32px; font-weight:800; letter-spacing:.2px}
    p{margin:0; color:var(--muted)}

    /* мини-капсула-лоадер */
    .stage{width:54px; height:54px; border-radius:14px; display:grid; place-items:center;
      background:linear-gradient(160deg,#0E1726,#101b2b); border:1px solid var(--border); position:relative}
    .pill{width:44px; height:20px}
    .pill .l{fill:#fff} .pill .r{fill:#14b8a6}
    .pill{animation:bob 1.2s ease-in-out infinite}
    @keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
    .ring{position:absolute; width:64px; height:64px; border-radius:999px; pointer-events:none;
      border:3px solid rgba(94,234,212,.35); animation:ripple 1.6s ease-out infinite}
    @keyframes ripple{0%{transform:scale(.8);opacity:.8}80%{transform:scale(1.12);opacity:.08}100%{opacity:0}}
    .bar-wrap{height:3px; background:rgba(255,255,255,.12); border-radius:999px; margin-top:14px; overflow:hidden}
    .bar{height:100%; width:30%; background:linear-gradient(90deg,var(--blue),var(--teal)); animation:flow 1.6s ease-in-out infinite}
    @keyframes flow{0%{transform:translateX(-100%)}100%{transform:translateX(300%)}}
    @media (prefers-reduced-motion: reduce){ .pill,.ring,.bar{animation:none} }
  </style>
</head>
<body>
  <div class="box" role="status" aria-live="polite">
    <div class="glow"></div>
    <div class="row">
      <div class="stage" aria-hidden="true">
        <div class="ring"></div>
        <svg class="pill" viewBox="0 0 200 86" xmlns="http://www.w3.org/2000/svg">
          <defs><clipPath id="c"><rect x="0" y="0" rx="43" ry="43" width="200" height="86"/></clipPath></defs>
          <g clip-path="url(#c)">
            <rect class="l" x="0" y="0" width="100" height="86"/>
            <rect class="r" x="100" y="0" width="100" height="86"/>
            <rect x="94" y="0" width="12" height="86" fill="#0E1726" opacity=".45"/>
          </g>
          <rect x="0" y="0" rx="43" ry="43" width="200" height="86" fill="none"
                stroke="rgba(255,255,255,.65)" stroke-width="2"/>
        </svg>
      </div>
      <div style="flex:1; min-width:220px">
        <h1>Roaccutane Tracker</h1>
        <p>Загружаю и перенаправляю…</p>
        <div class="bar-wrap"><div class="bar"></div></div>
      </div>
    </div>
  </div>
</body>
</html>
