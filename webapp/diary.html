<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Дневник — запись дня</title>
<style>
  :root{
    --bgA:#0B1220;
    --bgB:#0F1B2E;
    --glow:#14B8A6;
    --trackA:#ef4444; /* left */
    --trackB:#22c55e; /* right */
    --surface:#111827;
    --card:#0F172A;
    --muted:#8CA3B0;
    --text:#E6EDF3;
    --border:rgba(255,255,255,.08);
    --radius:20px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font:16px/1.45 system-ui, -apple-system, "Segoe UI", Roboto, Inter, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 80% -20%, color-mix(in oklab, var(--glow), transparent 70%), transparent 60%),
      radial-gradient(1000px 700px at -10% -20%, color-mix(in oklab, var(--trackB), transparent 80%), transparent 60%),
      linear-gradient(180deg, var(--bgA), var(--bgB));
    transition: background .5s ease, background-color .5s ease;
  }
  header{
    position:sticky; top:0; z-index:20;
    background:linear-gradient(180deg, color-mix(in oklab, var(--bgA), transparent 20%), color-mix(in oklab, var(--bgB), transparent 20%));
    border-bottom:1px solid var(--border);
    backdrop-filter: blur(8px);
  }
  .wrap{max-width:980px;margin:0 auto;padding:16px 18px}
  h1{margin:0;font-size:22px; letter-spacing:.2px}
  .date-row{display:flex; gap:12px; align-items:center; margin-top:8px; flex-wrap:wrap}
  .date-row input[type="date"]{
    background:var(--card); color:var(--text); border:1px solid var(--border);
    padding:10px 12px; border-radius:12px;
  }
  .chip{
    background:rgba(20,184,166,.15); color:#c7fffb;
    border:1px solid rgba(20,184,166,.35);
    padding:8px 10px; border-radius:999px; font-size:13px;
  }
  .date-nav{margin-left:auto; display:flex; gap:6px}
  .icon-btn{appearance:none; border:1px solid var(--border); background:var(--surface); color:var(--text);
    width:38px; height:38px; border-radius:10px; cursor:pointer}
  .icon-btn:active{transform: translateY(1px)}

  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; margin:16px 0; box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .card h2{font-size:18px; margin:0 0 12px 0}

  /* === App button styles === */
  .btn{
    appearance:none; border:0; border-radius:14px;
    padding:12px 16px; font-weight:700; cursor:pointer;
    transition:transform .06s ease, filter .2s ease, box-shadow .25s ease;
    will-change: transform, filter; color:#062217;
  }
  .btn:active{ transform: translateY(1px) }
  .btn-primary{
    background:linear-gradient(180deg, #20e3b2, #14b8a6);
    box-shadow:0 10px 26px rgba(20,184,166,.35), inset 0 0 0 1px rgba(255,255,255,.06);
  }
  .btn-secondary{
    background:rgba(255,255,255,.06);
    color:#E6EDF3;
    border:1px solid rgba(255,255,255,.12);
  }
  .btn-danger{
    background:rgba(239,68,68,.12);
    color:#fecaca;
    border:1px solid rgba(239,68,68,.55);
  }
  .btn-sm{ padding:8px 12px; border-radius:12px; font-size:14px }

  /* ===== Mood block ===== */
  .mood{ display:grid; grid-template-columns: 1fr 360px; gap:18px; align-items:center; }
  @media (max-width: 900px){ .mood{ grid-template-columns: 1fr; } }
  .mood-stage{
    position:relative; height:360px; border-radius:22px; overflow:hidden;
    border:1px solid var(--border);
    /* базовый фолбэк под изображением */
    background:
      radial-gradient(420px 240px at 20% 0%, color-mix(in oklab, var(--glow), transparent 60%), transparent 60%),
      linear-gradient(180deg, color-mix(in oklab, var(--bgA), #000 8%), color-mix(in oklab, var(--bgB), #000 6%));
  }
  /* Сильно размытая картинка позади пилюли */
  .mood-stage::before{
    content:"";
    position:absolute; inset:0;
    background-image: var(--mood-bg, none);
    background-size: cover; background-position: center; background-repeat: no-repeat;
    filter: blur(var(--bg-blur, 16px)) saturate(.92) brightness(1.02);
    transform: scale(1.06);     /* чтобы блюр не срезался по краям */
    z-index:0; pointer-events:none;
  }
  .mood-stage #pillCanvas{ position:absolute; inset:0; width:100%; height:100%; display:block; z-index:2; }
  .mood-stage svg{ position:absolute; inset:0; width:100%; height:100% }
  .mood-ctrl{ display:grid; gap:14px; align-content:center; justify-items:stretch; }
  .state-label{ text-align:center; font-weight:800; letter-spacing:.3px }

  .bar{
    --x: .5; /* 0..1 */
    position:relative; height:54px; border-radius:999px;
    background: linear-gradient(90deg, var(--trackA), var(--trackB));
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.12), 0 12px 30px rgba(0,0,0,.35);
    display:flex; align-items:center; padding:0 18px; cursor: pointer; user-select:none; -webkit-user-select:none; touch-action: none;
  }
  .bar .rail{ position:absolute; left:18px; right:18px; height:10px; background: rgba(0,0,0,.35); border-radius:999px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.15); }
  .bar .center-mark{ position:absolute; top:50%; left:50%; width:2px; height:20px; transform:translate(-50%,-50%); background:rgba(255,255,255,.36); border-radius:2px; }
  .bar .knob{
    position:absolute; top:50%;
    width:42px; height:42px; transform:translate(-50%, -50%);
    left: calc(18px + var(--x) * (100% - 36px));
    border-radius:50%; background:#fff; color:#111; display:grid; place-items:center; font-weight:800;
    box-shadow: 0 12px 24px rgba(0,0,0,.35), inset 0 0 0 1px rgba(0,0,0,.1);
    transition: left .15s ease;
  }
  .bar.drag .knob{ transition:none }

  /* ===== Side effects ===== */
  .se-list{display:grid; gap:10px}
  .se-item{display:grid; grid-template-columns: minmax(0,1fr) auto; align-items:center; gap:12px;
    padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.02)}
  .se-item .label{font-weight:700; min-width:0}
  .se-item .ctrl{display:flex; align-items:center; gap:10px; width:100%; max-width:420px}
  .se-item input[type="range"]{-webkit-appearance:none; width:100%; height:8px; border-radius:999px; background:linear-gradient(90deg, #475569, #94a3b8)}
  .se-item input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none; width:20px; height:20px; border-radius:50%; background:#fff; border:2px solid #0004; box-shadow:0 3px 8px rgba(0,0,0,.3)}
  .se-badge{min-width:28px; text-align:center; padding:6px 8px; border-radius:10px; background:#0b1728; border:1px solid var(--border)}

  /* ===== Photos & compare ===== */
  .uploader{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
  .drop{position:relative; min-height:180px; border:1px dashed rgba(255,255,255,.25); border-radius:14px;
    display:grid; place-items:center; overflow:hidden; background:rgba(255,255,255,.03)}
  .drop input{position:absolute; inset:0; opacity:0; cursor:pointer}
  .drop .hint{color:var(--muted); text-align:center; padding:12px}
  .thumb{width:100%; height:100%; object-fit:cover}
  .actions-row{display:flex; gap:10px; flex-wrap:wrap}
  .outline{background:transparent; border:1px solid var(--border); color:var(--text)}
  .compare{position:relative; width:100%; max-width:760px; margin:8px auto 0; border:1px solid var(--border); border-radius:14px; overflow:hidden}
  .compare img{display:block; width:100%; height:auto}
  .compare .top{position:absolute; inset:0; overflow:hidden}
  .compare .handle{position:absolute; top:0; bottom:0; width:2px; background:#fff; left:50%; transform:translateX(-1px)}
  .compare .knob{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:38px; height:38px; border-radius:50%; background:#fff; color:#111; display:grid; place-items:center; box-shadow:0 8px 18px rgba(0,0,0,.35)}
  .compare .label{position:absolute; top:10px; padding:6px 10px; border-radius:10px; font-size:12px; background:rgba(0,0,0,.35); backdrop-filter: blur(8px)}
  .compare .label.start{left:10px} .compare .label.current{right:10px}
  .compare input[type="range"]{position:absolute; inset:0; opacity:0}

  /* ===== Notes ===== */
  textarea{width:100%; min-height:100px; resize:vertical; background:var(--surface); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:12px}

  @media (max-width: 760px){
    .uploader{ grid-template-columns: 1fr; }
    .mood-stage{ height:300px; }
  }
  @media (max-width:700px){
    .se-item{ grid-template-columns: 1fr; align-items:start }
    .se-item .ctrl{ max-width:100% }
  }

  /* ===== Top day navigation ===== */
  .day-nav{
    display:grid;
    grid-template-columns: 56px minmax(260px, 640px) 56px;
    align-items:center;
    justify-content:center;
    gap:14px;
    margin-top:12px;
  }
  .day-nav .center-stack{
    display:flex; flex-direction:column; align-items:center; gap:10px;
    padding:14px 18px;
    border-radius:18px;
    background: linear-gradient(180deg, color-mix(in oklab, var(--card), transparent 30%), color-mix(in oklab, var(--surface), transparent 30%));
    border:1px solid var(--border);
    box-shadow: 0 14px 32px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04);
    backdrop-filter: blur(8px);
  }
  .chip.big{ font-size:14px; padding:10px 14px; }
  .date-input{
    background:var(--card); color:var(--text);
    border:1px solid var(--border);
    padding:10px 12px; border-radius:12px; font-weight:700;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.03);
  }
  .nav-arrow{
    appearance:none; border:1px solid var(--border);
    background:linear-gradient(180deg, #0f172a, #0b1120);
    color:var(--text);
    width:56px; height:56px; border-radius:16px; cursor:pointer;
    display:grid; place-items:center;
    box-shadow:0 12px 28px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
    transition:transform .08s ease, filter .2s ease;
  }
  .nav-arrow:hover{ filter:brightness(1.08) }
  .nav-arrow:active{ transform:translateY(1px) }
  @media (max-width:560px){
    .day-nav{ grid-template-columns: 46px 1fr 46px }
    .nav-arrow{ width:46px; height:46px; border-radius:14px }
  }

  /* ===== Day pane transition ===== */
  #dayPane{ position:relative }
  .fade-slide-enter{ animation:fadeSlideIn .28s ease both }
  .fade-slide-leave{ animation:fadeSlideOut .28s ease both }
  @keyframes fadeSlideIn{ from{ opacity:0; transform:translateY(8px) } to{ opacity:1; transform:none } }
  @keyframes fadeSlideOut{ from{ opacity:1; transform:none } to{ opacity:0; transform:translateY(-8px) } }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <a href="myprofile.html" style="text-decoration:none;display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid var(--border);color:#E6EDF3;font-weight:800;">← В профиль</a>
      <h1>Дневник</h1>
    </div>
    <div class="day-nav">
      <button class="nav-arrow left" id="prevDay" aria-label="Предыдущий день">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="center-stack">
        <div class="chip big" id="dayChip">Текущий день: —</div>
        <input id="datePicker" type="date" class="date-input">
      </div>
      <button class="nav-arrow right" id="nextDay" aria-label="Следующий день">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>
  </div>
</header>

<main class="wrap"><div id="dayPane">
  <!-- Mood section -->
  <section class="card" id="moodSection">
    <h2>Оценка самочувствия</h2>
    <div class="mood">
      <div class="mood-stage">
        <canvas id="pillCanvas"></canvas>
      </div>
      <div class="mood-ctrl">
        <div class="state-label" id="stateLabel">Нейтрально</div>
        <div class="bar" id="moodBar" role="slider" aria-valuemin="-100" aria-valuemax="100" aria-valuenow="0" aria-label="Самочувствие">
          <div class="rail"></div>
          <div class="center-mark" aria-hidden="true"></div>
          <div class="knob" id="moodKnob"></div>
        </div>
        <button class="btn btn-primary" id="confirmMood">Подтвердить</button>
      </div>
    </div>
  </section>

  <!-- Side effects -->
  <section class="card">
    <h2>Побочные эффекты</h2>
    <div class="se-list" id="seList"></div>
  </section>

  <!-- Photos -->
  <section class="card">
    <h2>Фото дня</h2>
    <div class="uploader">
      <label class="drop" id="faceDrop">
        <img class="thumb" id="faceThumb" alt="" hidden>
        <input type="file" accept="image/*" capture="environment" id="faceInput">
        <div class="hint"><b>Лицо (обязательно)</b><br>Сделать фото или загрузить</div>
      </label>
      <label class="drop" id="bodyDrop">
        <img class="thumb" id="bodyThumb" alt="" hidden>
        <input type="file" accept="image/*" capture="environment" id="bodyInput">
        <div class="hint"><b>Тело (по желанию)</b><br>Сделать фото или загрузить</div>
      </label>
    </div>
    <div class="actions-row" style="margin-top:10px">
      <button class="btn btn-danger btn-sm" id="removeFace">Удалить лицо</button>
      <button class="btn btn-danger btn-sm" id="removeBody">Удалить тело</button>
      <button class="btn btn-primary" id="saveAll">Сохранить запись</button>
    </div>

    <div class="compare" id="compareWrap" hidden>
      <img id="imgStart" alt="День 1">
      <div class="top" id="topWrap">
        <img id="imgCurrent" alt="Сегодня">
      </div>
      <div class="handle"></div>
      <div class="knob">↔</div>
      <div class="label start">День 1</div>
      <div class="label current">Сегодня</div>
      <input id="compareRange" type="range" min="0" max="100" value="50">
    </div>
  </section>

  <!-- Notes -->
  <section class="card">
    <h2>Заметка дня</h2>
    <textarea id="notes" placeholder="Например: вода 2л, спорт 30 мин, губы ок..."></textarea>
    <div class="actions-row" style="justify-content:flex-end; margin-top:8px">
      <button class="btn btn-secondary" id="exportJSON">Экспорт JSON</button>
    </div>
  </section>

</div>
</main>

<script>
/* ===== Storage ===== */
const KEY = 'rt.diary.v2';
function toLocalISO(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
function todayISO(){ return toLocalISO(new Date()); }
function parseISO(s){ const [y,m,d] = s.split('-').map(Number); return new Date(y, m-1, d); }
function loadDB(){ try{const v=JSON.parse(localStorage.getItem(KEY)); if(v&&v.version===2) return v;}catch(e){} const fresh={version:2,baseline:null,entries:{}}; localStorage.setItem(KEY,JSON.stringify(fresh)); return fresh; }
function saveDB(db){ localStorage.setItem(KEY, JSON.stringify(db)); }
function getEntry(date){ const db=loadDB(); return db.entries[date] || {date, wellness:50, sideEffects:{}, photos:{face:null, body:null}, notes:''}; }
function putEntry(entry){ const db=loadDB(); db.entries[entry.date]=entry; if(!db.baseline) db.baseline = entry.date; saveDB(db); return db; }

/* ===== Date controls ===== */
const datePicker=document.getElementById('datePicker');
const dayChip=document.getElementById('dayChip');
const prevDay=document.getElementById('prevDay'), nextDay=document.getElementById('nextDay');
function animatePane(dir){
  const pane=document.getElementById('dayPane');
  pane.classList.remove('fade-slide-enter','fade-slide-leave');
  pane.classList.add('fade-slide-leave');
  setTimeout(()=>{
    pane.classList.remove('fade-slide-leave');
    pane.classList.add('fade-slide-enter');
    setTimeout(()=>pane.classList.remove('fade-slide-enter'), 280);
  }, 140);
}
function setDate(d, dir=0){ datePicker.value=d; animatePane(dir); loadIntoUI(d); }
function stepDate(dt){ const d=parseISO(datePicker.value||todayISO()); d.setDate(d.getDate()+dt); setDate(toLocalISO(d), dt); }
prevDay.addEventListener('click',()=>stepDate(-1)); nextDay.addEventListener('click',()=>stepDate(1));
datePicker.addEventListener('change',e=>loadIntoUI(e.target.value));

// ===== Mood PILL animation (replaces flower) =====
const stateLabel=document.getElementById('stateLabel');
const bar=document.getElementById('moodBar'); const knob=document.getElementById('moodKnob');
const canvas = document.getElementById('pillCanvas');
const ctx = canvas.getContext('2d');

// Фоновые изображения для 7 состояний (по порядку: очень плохо → отлично)
const BG_URLS = [
  'img/bg-very-bad.png',
  'img/bg-bad.png',
  'img/bg-below.png',
  'img/bg-neutral.png',
  'img/bg-fair.png',
  'img/bg-good.png',
  'img/bg-excellent.png'
];

// --- анимация как раньше ---
const rotationPeriod=10, breathAmp=0.04, breathPeriod=1.6, morphSpeed=0.7, morphAmpBase=0.06;

// --- управление «самочувствием»: 0..100 ---
let valence=50;                  // 0..100
let mood01=0.5, moodVis=0.5;     // 0..1 (внутреннее)
window.setPillMood01 = x => { mood01 = Math.max(0, Math.min(1, x)); };

// — служебные —
function fit(){
  const dpr=Math.max(1, window.devicePixelRatio||1);
  const w=canvas.clientWidth, h=canvas.clientHeight;
  canvas.width=Math.round(w*dpr); canvas.height=Math.round(h*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', fit); fit();

function pathCapsule(c, W, H, R){
  const r=Math.max(0, Math.min(R, Math.min(W,H)/2));
  const x=-W/2, y=-H/2;
  c.beginPath();
  c.moveTo(x+r,y); c.lineTo(x+W-r,y); c.quadraticCurveTo(x+W,y,x+W,y+r);
  c.lineTo(x+W,y+H-r); c.quadraticCurveTo(x+W,y+H,x+W-r,y+H);
  c.lineTo(x+r,y+H); c.quadraticCurveTo(x,y+H,x,y+H-r);
  c.lineTo(x,y+r); c.quadraticCurveTo(x,y,x+r,y); c.closePath();
}
const lerp=(a,b,t)=>a+(b-a)*t;
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
function hexToRgb(h){ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);
  return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:{r:255,g:255,b:255}; }
function mixHex(h1,h2,t,a=1){ const A=hexToRgb(h1),B=hexToRgb(h2);
  const r=Math.round(lerp(A.r,B.r,t)), g=Math.round(lerp(A.g,B.g,t)), b=Math.round(lerp(A.b,B.b,t));
  return `rgba(${r},${g},${b},${a})`;
}

// Палитра капсулы: 0 — тёпло/«плохо», 1 — холодно/«отлично»
function palette(m){
  const warm1='#e96a5a', warm2='#ffb36b';
  const mid1 ='#19d06a', mid2 ='#66e08f';
  const cool1='#00d2ff', cool2='#38f9d7';
  let cA,cB; if(m<0.5){ const t=m/0.5; cA=mixHex(warm1,mid1,t); cB=mixHex(warm2,mid2,t);}
  else { const t=(m-0.5)/0.5; cA=mixHex(mid1,cool1,t); cB=mixHex(mid2,cool2,t); }
  return {
    baseDark: mixHex('#0c1322', '#0b141e', m, 1),
    baseMid:  mixHex('#141d34', '#0f2234', m, 1),
    tintA: cA, tintB: cB,
    rimA: mixHex('#ff9866','#00ffee', m, .35),
    rimB: mixHex('#ffd8a0','#a0d8ff', m, .16),
    glintA: mixHex('#ffe5d4','#e8fbff', m, .85),
    glintB: mixHex('#ffd0f0','#c7e6ff', m, .72)
  };
}

// Текстуры: low-freq «бамп» + микро-поры
function makeValueNoise(size=256, cell=16, oct=3){
  const cnv=document.createElement('canvas'), c=cnv.getContext('2d');
  cnv.width=cnv.height=size; const img=c.createImageData(size,size);
  function pass(freq, amp){
    const gx=Math.ceil(size/freq)+2, gy=Math.ceil(size/freq)+2;
    const grid=Array.from({length:gy},()=>Array.from({length:gx},()=>Math.random()));
    for(let y=0;y<size;y++){ const fy=y/freq, y0=Math.floor(fy), ty=fy-y0;
      for(let x=0;x<size;x++){ const fx=x/freq, x0=Math.floor(fx), tx=fx-x0;
        const v00=grid[y0][x0], v10=grid[y0][x0+1], v01=grid[y0+1][x0], v11=grid[y0+1][x0+1];
        const v=((v00*(1-tx)+v10*tx)*(1-ty) + (v01*(1-tx)+v11*tx)*ty)*amp;
        const i=(y*size+x)*4; img.data[i]+=v*255; img.data[i+1]+=v*255; img.data[i+2]+=v*255; img.data[i+3]=255;
      }
    }
  }
  for(let o=0;o<oct;o++) pass(cell/(2**o), 1/(2**(o+1)));
  c.putImageData(img,0,0); return cnv;
}
function makeSpeckles(size=512, count=2200){
  const cnv=document.createElement('canvas'), c=cnv.getContext('2d');
  cnv.width=cnv.height=size; c.clearRect(0,0,size,size);
  for(let i=0;i<count;i++){
    const x=Math.random()*size, y=Math.random()*size, r=(Math.random()*1.6)+0.5, ang=Math.random()*Math.PI;
    c.fillStyle=`rgba(0,0,0,${0.10+Math.random()*0.10})`;
    c.beginPath(); c.ellipse(x,y,r*1.1,r*0.9,ang,0,Math.PI*2); c.fill();
    if(Math.random()<0.25){
      c.fillStyle=`rgba(255,255,255,${0.06+Math.random()*0.06})`;
      c.beginPath(); c.ellipse(x+0.2,y-0.2,r*0.8,r*0.6,ang,0,Math.PI*2); c.fill();
    }
  }
  return cnv;
}
const noiseTex = makeValueNoise(256,18,3);
const speckleTex = makeSpeckles(512,2200);

// Помощники для бликов/полос
function glossyBand(x1,y1,x2,y2, a1, a2, alpha){
  const g=ctx.createLinearGradient(x1,y1,x2,y2);
  g.addColorStop(0,'rgba(255,255,255,0)'); g.addColorStop(0.35,a1);
  g.addColorStop(0.65,a2); g.addColorStop(1,'rgba(255,255,255,0)');
  ctx.globalCompositeOperation='screen'; ctx.globalAlpha=alpha; ctx.fillStyle=g;
  ctx.fillRect(-9999,-9999,19999,19999);
  ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over';
}
function glint(cx,cy,rx,ry,color='rgba(255,255,255,.9)',a=1){
  const gr=ctx.createRadialGradient(cx,cy,0,cx,cy,Math.max(rx,ry));
  gr.addColorStop(0,color); gr.addColorStop(1,'rgba(255,255,255,0)');
  ctx.globalCompositeOperation='screen'; ctx.globalAlpha=a; ctx.fillStyle=gr;
  ctx.beginPath(); ctx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over';
}

// Текст пояснения
function textFromV(v){ const s=(v-50)/50;
  if(s<-0.66) return 'Очень плохо'; if(s<-0.33) return 'Плохо'; if(s<-0.06) return 'Ниже нормы';
  if(s<0.06) return 'Нейтрально'; if(s<0.33) return 'Неплохо'; if(s<0.66) return 'Хорошо'; return 'Отлично';
}

// Обновление цветов UI + фон-картинка
function updateColorsByValence(v){
  stateLabel.textContent = textFromV(v);

  // индексация 0..6 по порогам
  const s=(v-50)/50;
  let idx=3;
  if(s<-0.66) idx=0; else if(s<-0.33) idx=1; else if(s<-0.06) idx=2; else if(s<0.06) idx=3;
  else if(s<0.33) idx=4; else if(s<0.66) idx=5; else idx=6;

  // ===== Новая карта градиентов для страницы =====
  // 0: бордовый, 1: оранжевый, 2: бежево-коричневый, 3: перламутровый,
  // 4: желтоватый, 5: зеленоватый, 6: синий
  const THEMES = [
    ['#3a0d1b', '#14060d'], // very bad — maroon
    ['#4a2609', '#1a0d05'], // bad — orange/dark amber
    ['#4a3a2b', '#1e1812'], // below — beige-brown
    ['#2c3342', '#10141e'], // neutral — pearly cool
    ['#3d3a12', '#161306'], // fair — yellowish
    ['#0e2b1b', '#081712'], // good — greenish
    ['#0a2240', '#06121e']  // excellent — blue
  ];
  const [A,B]=THEMES[idx];
  document.documentElement.style.setProperty('--bgA', A);
  document.documentElement.style.setProperty('--bgB', B);

  // трек слайдера оставляем красно-зелёным
  document.documentElement.style.setProperty('--trackA', 'hsl(10 90% 55%)');
  document.documentElement.style.setProperty('--trackB', 'hsl(140 72% 45%)');

  // Фон-картинка за пилюлей (меняем var(--mood-bg))
  const moodStageEl = document.querySelector('.mood-stage');
  if (moodStageEl) {
    moodStageEl.style.setProperty('--mood-bg', `url('${BG_URLS[idx]}')`);
    moodStageEl.style.setProperty('--bg-blur', '8px'); // усилили блюр
  }

  // передаём настроение в капсулу
  window.setPillMood01(v/100);
}

// ===== Рендер капсулы (как был) =====
let start=performance.now();
function frame(nowMs){
  const t=(nowMs-start)/1000;
  moodVis += (mood01 - moodVis)*0.08;

  const W0=canvas.clientWidth, H0=canvas.clientHeight;
  ctx.clearRect(0,0,W0,H0);
  const cx=W0/2, cy=H0/2;

  const rot=(2*Math.PI/rotationPeriod)*t;
  const breath=1 + breathAmp*Math.sin(2*Math.PI*t/breathPeriod);
  const morphAmp = morphAmpBase * (0.7 + 0.6*Math.abs(moodVis-0.5));
  const morph=Math.sin(t*morphSpeed);

  const baseW=W0*0.60, baseH=H0*0.34;
  const W=baseW*(1 + morphAmp*0.52*morph) * (1 - 0.05*(moodVis-0.5));
  const H=baseH*(1 - morphAmp*0.34*morph) * (1 + 0.05*(moodVis-0.5));
  const R=Math.min(W,H)/2*(0.86 + 0.10*Math.sin(t*morphSpeed*1.7));
  const pal=palette(moodVis);

  /* тень и рисование пилюли — без изменений (опущено тут для краткости),
     оставь как в твоём текущем файле, если нужно — он уже ниже полностью */ 
  // … (ниже полный блок из твоего файла)

  // Тень (капсула)
  ctx.save();
  ctx.translate(cx, cy + H*0.24);
  ctx.rotate(rot + 0.5);
  const sw = W * 0.78, sh = H * 0.24, sr = Math.min(sw, sh) / 2;
  pathCapsule(ctx, sw, sh, sr); ctx.save(); ctx.clip();
  let g = ctx.createLinearGradient(0, -sh/2, 0, sh/2);
  g.addColorStop(0.00, 'rgba(0,0,0,.22)');
  g.addColorStop(0.45, 'rgba(0,0,0,.32)');
  g.addColorStop(1.00, 'rgba(0,0,0,0)');
  ctx.fillStyle = g; ctx.fillRect(-sw/2, -sh/2, sw, sh);
  ctx.filter = 'blur(3px)'; ctx.globalAlpha = 0.9; ctx.fillRect(-sw/2, -sh/2, sw, sh);
  ctx.filter = 'none'; ctx.globalAlpha = 1; ctx.restore();
  pathCapsule(ctx, sw * 0.72, sh * 0.64, sr * 0.64);
  ctx.fillStyle = 'rgba(0,0,0,.18)'; ctx.filter = 'blur(1.2px)'; ctx.fill(); ctx.filter = 'none';
  ctx.restore();

  // Капсула
  ctx.save();
  ctx.translate(cx,cy); ctx.rotate(rot + 0.5); ctx.scale(breath,breath);
  pathCapsule(ctx,W,H,R); ctx.save(); ctx.clip();

  const base=ctx.createLinearGradient(-W/2,-H/2, W/2,H/2);
  base.addColorStop(0.0,pal.baseDark); base.addColorStop(0.45,pal.baseMid); base.addColorStop(1.0,'#070b14');
  ctx.fillStyle=base; ctx.fillRect(-W,-H,W*2,H*2);

  glossyBand(-W*0.9,-H*0.2,  W*0.7,H*0.15, pal.tintA, pal.tintB, .45);
  glossyBand(-W*0.2,-H*0.85, W*0.2,H*0.75, mixHex('#ffd070','#a0d8ff',moodVis,.20), mixHex('#90e0ff','#70ffd8',moodVis,.22), .38);

  ctx.save(); ctx.rotate(-(rot + 0.5));
  const light=ctx.createLinearGradient(-W,0, W,0);
  light.addColorStop(0.0,'rgba(255,255,255,.18)');
  light.addColorStop(0.55,'rgba(0,0,0,0)');
  light.addColorStop(1.0,'rgba(0,0,0,.22)');
  ctx.globalCompositeOperation='overlay'; ctx.fillStyle=light; ctx.fillRect(-W,-H,W*2,H*2);
  ctx.globalCompositeOperation='source-over'; ctx.restore();

  ctx.globalCompositeOperation='multiply'; ctx.globalAlpha=0.10; ctx.drawImage(noiseTex, -W,-H, W*2,H*2);
  ctx.globalAlpha=0.20; ctx.drawImage(speckleTex, -W,-H, W*2,H*2);
  ctx.globalCompositeOperation='screen'; ctx.globalAlpha=0.06; ctx.drawImage(speckleTex, -W,-H, W*2,H*2);
  ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over';

  glint(W*0.26,-H*0.26, W*0.20,H*0.18, pal.glintA, .55);
  glint(-W*0.30, H*0.26, W*0.16,H*0.14, pal.glintB, .40);

  const rimAO=ctx.createLinearGradient(-W/2,0, W/2,0);
  rimAO.addColorStop(0.0,'rgba(0,0,0,0.16)'); rimAO.addColorStop(0.5,'rgba(0,0,0,0)');
  rimAO.addColorStop(1.0,'rgba(0,0,0,0.16)');
  ctx.globalCompositeOperation='multiply'; ctx.fillStyle=rimAO; ctx.fillRect(-W,-H,W*2,H*2);
  ctx.globalCompositeOperation='source-over';

  const rim=ctx.createLinearGradient(-W/2,-H/2, W/2,H/2);
  rim.addColorStop(0,pal.rimA); rim.addColorStop(0.5,'rgba(255,255,255,.08)'); rim.addColorStop(1,pal.rimB);
  ctx.lineWidth=Math.max(1.2, Math.min(W,H)/22); ctx.strokeStyle=rim; pathCapsule(ctx,W,H,R); ctx.stroke();

  ctx.lineWidth=1.0; ctx.strokeStyle='rgba(255,255,255,.20)';
  pathCapsule(ctx, W*0.988, H*0.988, R*0.988); ctx.stroke();

  const rx=W*0.014, ry=H*0.44; const seam=ctx.createLinearGradient(-rx,0, rx,0);
  seam.addColorStop(0, mixHex('#ffffff','#d0f0ff',moodVis,.40));
  seam.addColorStop(0.5,'rgba(0,0,0,.18)');
  seam.addColorStop(1, mixHex('#ffffff','#d0f0ff',moodVis,.40));
  ctx.lineWidth=Math.max(1.4, Math.min(W,H)/50); ctx.strokeStyle=seam;
  ctx.beginPath(); ctx.ellipse(0,0, rx,ry, 0,0,Math.PI*2); ctx.stroke();

  ctx.restore(); // clip
  ctx.restore(); // transform

  // Матовое отражение на «столе»
  ctx.save();
  ctx.translate(cx, cy + H*0.38); ctx.rotate(rot + 0.5); ctx.scale(1,-0.55);
  pathCapsule(ctx, W*0.98, H*0.98, R*0.98); ctx.clip();
  const refl=ctx.createLinearGradient(0,-H,0,H);
  refl.addColorStop(0,'rgba(255,255,255,.10)'); refl.addColorStop(1,'rgba(255,255,255,0)');
  ctx.fillStyle=refl; ctx.filter='blur(2.5px)'; ctx.fillRect(-W,-H,W*2,H*2);
  ctx.filter='none'; ctx.restore();

  requestAnimationFrame(frame);
}
requestAnimationFrame(frame);

// ==== ЛОГИКА СЛАЙДЕРА ====
function applyValence(v, setKnob=true){
  valence = clamp(v, 0, 100);
  if(setKnob){
    const x = valence/100;
    document.getElementById('moodBar').style.setProperty('--x', x);
    knob.setAttribute('aria-valuenow', Math.round((x-0.5)*200));
  }
  updateColorsByValence(valence);
}
function clientToValence(xClient){
  const rect=bar.getBoundingClientRect(); const left=rect.left+18, right=rect.right-18; const w=right-left;
  return Math.round(clamp((xClient-left)/w,0,1)*100);
}
bar.addEventListener('pointerdown', e=>{ bar.classList.add('drag'); applyValence(clientToValence(e.clientX)); });
window.addEventListener('pointermove', e=>{ if(!bar.classList.contains('drag')) return; applyValence(clientToValence(e.clientX)); });
window.addEventListener('pointerup', ()=> bar.classList.remove('drag'));
bar.addEventListener('click', e=> applyValence(clientToValence(e.clientX)));

/* ===== Side effects ===== */
const SE_DEFS=[['lips_dry','Сухость губ'],['skin_dry','Сухость кожи'],['nose_bleed','Кровотечения из носа'],['muscle_pain','Боль в мышцах/суставах'],['headache','Головная боль'],];
const seList=document.getElementById('seList');
function renderSE(entry){
  seList.innerHTML='';
  SE_DEFS.forEach(([key,title])=>{
    const level=entry.sideEffects[key]??0;
    const row=document.createElement('div'); row.className='se-item';
    row.innerHTML=`<div class="label">${title}</div><div class="ctrl"><input type="range" min="0" max="3" step="1" value="${level}"><span class="se-badge">${level}</span></div>`;
    const input=row.querySelector('input'); const badge=row.querySelector('.se-badge');
    input.addEventListener('input',e=>{ const v=+e.target.value; badge.textContent=v; entry.sideEffects[key]=v; putEntry(entry); });
    seList.appendChild(row);
  });
}

/* ===== Photos & compare ===== */
const faceInput=document.getElementById('faceInput'); const bodyInput=document.getElementById('bodyInput');
const faceThumb=document.getElementById('faceThumb'); const bodyThumb=document.getElementById('bodyThumb');
const removeFace=document.getElementById('removeFace'), removeBody=document.getElementById('removeBody');
const compareWrap=document.getElementById('compareWrap'); const imgStart=document.getElementById('imgStart'); const imgCurrent=document.getElementById('imgCurrent'); const topWrap=document.getElementById('topWrap');
const compareRange=document.getElementById('compareRange');
function readImageFile(file,max=1600,quality=0.85){ return new Promise((res,rej)=>{ const R=new FileReader(); R.onload=()=>{ const img=new Image(); img.onload=()=>{ const sc=Math.min(1,max/Math.max(img.width,img.height)); const w=Math.round(img.width*sc), h=Math.round(img.height*sc); const c=document.createElement('canvas'); c.width=w;c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); res(c.toDataURL('image/jpeg',quality)); }; img.onerror=rej; img.src=R.result; }; R.onerror=rej; R.readAsDataURL(file); }); }
async function onPick(input,key,thumb){ const f=input.files&&input.files[0]; if(!f)return; const url=await readImageFile(f); const d=datePicker.value||todayISO(); const e=getEntry(d); e.photos[key]=url; putEntry(e); thumb.src=url; thumb.hidden=false; refreshCompare(); }
faceInput.addEventListener('change',()=>onPick(faceInput,'face',faceThumb)); bodyInput.addEventListener('change',()=>onPick(bodyInput,'body',bodyThumb));
removeFace.addEventListener('click',()=>{ const d=datePicker.value||todayISO(); const e=getEntry(d); e.photos.face=null; putEntry(e); faceThumb.hidden=true; faceThumb.src=''; refreshCompare(); });
removeBody.addEventListener('click',()=>{ const d=datePicker.value||todayISO(); const e=getEntry(d); e.photos.body=null; putEntry(e); bodyThumb.hidden=true; bodyThumb.src=''; });
function setSplit(p){ p=Math.max(0,Math.min(100,p)); const w=compareWrap.getBoundingClientRect().width; const cut=w*p/100; topWrap.style.clipPath=`inset(0 ${Math.max(0,w-cut)}px 0 0)`; document.querySelector('.compare .handle').style.left=p+'%'; document.querySelector('.compare .knob').style.left=p+'%'; }
compareRange.addEventListener('input', e=> setSplit(+e.target.value));
function refreshCompare(){ const db=loadDB(); const curDate=datePicker.value||todayISO(); const e=getEntry(curDate); if(!db.baseline||!db.entries[db.baseline]||!db.entries[db.baseline].photos.face||!e.photos.face){ compareWrap.hidden=true; return; } imgStart.src=db.entries[db.baseline].photos.face; imgCurrent.src=e.photos.face; compareWrap.hidden=false; setSplit(50); }

/* ===== Notes ===== */
const notesEl=document.getElementById('notes');

/* ===== Load/Save UI ===== */
const confirmMood=document.getElementById('confirmMood'); const saveAll=document.getElementById('saveAll');
function updateDayChip(dateISO){
  const t=todayISO();
  if(dateISO===t){
    dayChip.textContent = 'Текущий день: ' + dateISO;
  }else{
    dayChip.textContent = 'Выбранный день: ' + dateISO;
  }
}
function loadIntoUI(dateISO){
  const entry=getEntry(dateISO); const db=loadDB();
  updateDayChip(dateISO);
  applyValence(entry.wellness ?? 50, true);
  renderSE(entry);
  if(entry.photos.face){ faceThumb.src=entry.photos.face; faceThumb.hidden=false; } else { faceThumb.hidden=true; }
  if(entry.photos.body){ bodyThumb.src=entry.photos.body; bodyThumb.hidden=false; } else { bodyThumb.hidden=true; }
  notesEl.value = entry.notes || '';
  refreshCompare();
}
confirmMood.addEventListener('click',()=>{
  const date=datePicker.value||todayISO(); const entry=getEntry(date);
  entry.wellness = Math.round(valence); putEntry(entry);
  confirmMood.disabled=true; const old=confirmMood.textContent; confirmMood.textContent='Сохранено ✓'; setTimeout(()=>{confirmMood.disabled=false; confirmMood.textContent=old;},1200);
});
document.getElementById('exportJSON').addEventListener('click',()=>{
  const data=localStorage.getItem(KEY) || '{}';
  const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(data);
  a.download='diary-export.json'; a.click();
});

/* ===== Init ===== */
(function init(){
  const d=todayISO(); datePicker.value=d;
  const db=loadDB(); if(!db.baseline){ const en=getEntry(d); putEntry(en); }
  updateDayChip(d);
  applyValence(50,true);
  loadIntoUI(d);
})();
</script>
</body>
</html>
