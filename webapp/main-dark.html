<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <script>try{ if(localStorage.getItem('derma_consent')!=='1'){ location.replace('./warnings.html' + (location.search||'')); } }catch(_){}
(function hookOpenCalendar(){
  const btn = document.getElementById('openCalendarBtn');
  if(!btn) return;
  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    try{ if(typeof go==='function'){ go('/calendar'); return; } }catch(_){}
    location.assign('/calendar');
  });
})();


// --- Pill burst animation on Add button ---
(function setupPillBurst(){
  const btn = document.getElementById('save');
  if(!btn) return;
  function burst(x,y){
    const rect = btn.getBoundingClientRect();
    const cx = x ? (x - rect.left) : rect.width/2;
    const cy = y ? (y - rect.top)  : rect.height/2;
    // Pill emoji
    const pill = document.createElement('span');
    pill.className = 'fx-pill';
    pill.textContent = 'üíä';
    pill.style.left = cx + 'px';
    pill.style.top  = cy + 'px';
    btn.appendChild(pill);
    setTimeout(()=>pill.remove(), 900);

    // Particles
    const colors = ['#22D3EE','#14B8A6','#5EEAD4','#FDE047','#A7F3D0','#93C5FD'];
    const N = 10;
    for(let i=0;i<N;i++){
      const dot = document.createElement('span');
      dot.className = 'fx-dot';
      dot.style.left = cx + 'px';
      dot.style.top  = cy + 'px';
      const angle = (Math.PI*2) * (i/N) + (Math.random()*0.6 - 0.3);
      const r = 22 + Math.random()*16;
      dot.style.setProperty('--dx',  Math.cos(angle)*r + 'px');
      dot.style.setProperty('--dy',  Math.sin(angle)*r + 'px');
      dot.style.width = dot.style.height = (4 + Math.random()*4) + 'px';
      dot.style.background = colors[i % colors.length];
      btn.appendChild(dot);
      setTimeout(()=>dot.remove(), 800);
    }
  }
  btn.addEventListener('click', (e)=>{
    try{ burst(e.clientX, e.clientY); }catch(_){ burst(); }
  });
  btn.addEventListener('touchstart', (e)=>{
    try{ const t = e.touches[0]; if(t) burst(t.clientX, t.clientY); }catch(_){ burst(); }
  }, {passive:true});
})();

</script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roaccutane Tracker ‚Äî –ì–ª–∞–≤–Ω–∞—è</title>
 <script src="https://telegram.org/js/telegram-web-app.js"></script>

</script>
  <script>window.API_BASE = window.API_BASE || '';
(function hookOpenCalendar(){
  const btn = document.getElementById('openCalendarBtn');
  if(!btn) return;
  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    try{ if(typeof go==='function'){ go('/calendar'); return; } }catch(_){}
    location.assign('/calendar');
  });
})();


// --- Pill burst animation on Add button ---
(function setupPillBurst(){
  const btn = document.getElementById('save');
  if(!btn) return;
  function burst(x,y){
    const rect = btn.getBoundingClientRect();
    const cx = x ? (x - rect.left) : rect.width/2;
    const cy = y ? (y - rect.top)  : rect.height/2;
    // Pill emoji
    const pill = document.createElement('span');
    pill.className = 'fx-pill';
    pill.textContent = 'üíä';
    pill.style.left = cx + 'px';
    pill.style.top  = cy + 'px';
    btn.appendChild(pill);
    setTimeout(()=>pill.remove(), 900);

    // Particles
    const colors = ['#22D3EE','#14B8A6','#5EEAD4','#FDE047','#A7F3D0','#93C5FD'];
    const N = 10;
    for(let i=0;i<N;i++){
      const dot = document.createElement('span');
      dot.className = 'fx-dot';
      dot.style.left = cx + 'px';
      dot.style.top  = cy + 'px';
      const angle = (Math.PI*2) * (i/N) + (Math.random()*0.6 - 0.3);
      const r = 22 + Math.random()*16;
      dot.style.setProperty('--dx',  Math.cos(angle)*r + 'px');
      dot.style.setProperty('--dy',  Math.sin(angle)*r + 'px');
      dot.style.width = dot.style.height = (4 + Math.random()*4) + 'px';
      dot.style.background = colors[i % colors.length];
      btn.appendChild(dot);
      setTimeout(()=>dot.remove(), 800);
    }
  }
  btn.addEventListener('click', (e)=>{
    try{ burst(e.clientX, e.clientY); }catch(_){ burst(); }
  });
  btn.addEventListener('touchstart', (e)=>{
    try{ const t = e.touches[0]; if(t) burst(t.clientX, t.clientY); }catch(_){ burst(); }
  }, {passive:true});
})();

</script>
  <style>
    :root{
      --bg:#0B1220; --surface:#0E1726; --card:#121C2E; --border:#1F2A3C;
      --primary:#14B8A6; --primary-700:#0EA5A6; --primary-300:#5EEAD4;
      --text-high:#F3F7FF; --text-mid:#C7D2FE; --text-low:#93A3BF; --focus-ring:#93C5FD;
      --ring-gray:#2a3342; --ring-ok:#22C55E;
      --muted-ink: rgba(255,255,255,.65);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text-high);
         font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Manrope,Helvetica,Arial;
         font-size:16px;line-height:1.5}
    .wrap{max-width:980px;margin:0 auto;padding:24px 24px 112px} /* –∑–∞–ø–∞—Å –ø–æ–¥ –Ω–∏–∂–Ω—é—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é */
    h1{font-size:28px;line-height:34px;margin:0 0 16px;font-weight:800; text-align:center; letter-spacing:.2px}
    h2{font-size:22px;line-height:28px;margin:0 0 12px;font-weight:700}
    .card{position:relative;background:var(--card);border:1px solid var(--border);border-radius:16px;
          padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.35);overflow:hidden}
    .glow{position:absolute;inset:0;pointer-events:none;background:radial-gradient(120% 120% at 10% 0%, rgba(20,184,166,.18) 0%, rgba(18,28,46,0) 50%)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--text-low)}
    .ava{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;font-weight:700;background:#0E1726;border:1px solid var(--border);color:var(--text-mid);overflow:hidden}
    .ava img{width:100%;height:100%;object-fit:cover}
    .clickable{cursor:pointer}
    input,button{font:inherit}
    input[type="number"], input[type="date"]{
      background:var(--surface);border:1px solid var(--border);color:var(--text-high);
      border-radius:12px;padding:10px 12px;font-size:16px;line-height:24px;outline:none
    }
    input:focus{border-color:var(--primary-700);box-shadow:0 0 0 2px var(--focus-ring)}
    .cta{height:44px;padding:0 16px;border-radius:12px;border:none;font-weight:700;cursor:pointer;
         background-image:linear-gradient(135deg,#22D3EE 0%, #14B8A6 100%); color:#07121F;
         box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .chip{min-width:48px;height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:12px;padding:0 14px;margin-right:10px;background:#152235;color:#F3F7FF;border:1px solid transparent;font-weight:700}
    .chip:hover{border-color:#14B8A6}
    .section{margin-top:16px}

    /* === PROGRESS RINGS LAYOUT (3 –∫–æ–ª—å—Ü–∞) === */
    .rings-rail{position:relative;height:220px;margin:6px 0 0}
    .ring{position:absolute;left:50%;top:50%;transform-origin:center;transition:transform 250ms ease-out, opacity 200ms ease-out}
    .ring svg{width:170px;height:170px;display:block}
    .ring .pct{position:absolute;left:0;right:0;top:0;bottom:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;text-shadow:0 2px 8px rgba(0,0,0,.35)}
    .ring.small svg{width:96px;height:96px}
    .ring.small .pct{font-size:12px;color:var(--muted-ink)}
    /* positions */
    .pos-center{transform:translate(-50%,-50%) scale(1)}
    .pos-left  {transform:translate(calc(-50% - 170px),-50%) scale(0.56)}
    .pos-right {transform:translate(calc(-50% + 170px),-50%) scale(0.56)}
    @media (max-width:520px){
      .rings-rail{height:200px}
      .pos-left{transform:translate(calc(-50% - 130px),-50%) scale(0.56)}
      .pos-right{transform:translate(calc(-50% + 130px),-50%) scale(0.56)}
    }
    .ring button{all:unset;cursor:pointer;display:block}
    /* --- –ù–µ–æ–Ω–æ–≤—ã–µ —Ç–æ–ª—Å—Ç—ã–µ –∫–æ–ª—å—Ü–∞ --- */
.ring circle.track{ stroke: url(#ringTrackGrad); stroke-width:18; }
.ring circle[data-arc]{
  stroke: url(#ringArcGrad);
  stroke-width:18;
  stroke-linecap:round;
  transition: stroke-dashoffset .8s cubic-bezier(.2,.8,.2,1);
  filter: url(#ringGlow);
}
.ring svg{ filter: url(#ringInner); } /* –æ–±—ä—ë–º —Ç—Ä–µ–∫–∞ */
    

    /* === BOTTOM NAV WITH ICONS === */
    .bottom-nav{position:fixed;left:0;right:0;bottom:0;background:var(--surface);border-top:1px solid var(--border);height:64px;padding:6px 6px calc(env(safe-area-inset-bottom) + 6px);display:flex;justify-content:space-around;align-items:center;z-index:50}
    .bottom-nav a{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--text-mid);text-decoration:none;font-size:11px;opacity:.6;transition:opacity .15s ease,color .15s ease,background .15s ease;padding:4px 10px;border-radius:12px}
    .bottom-nav a.active{opacity:1;color:#E8F0FF;background:#111b2b}
    .bottom-nav svg{width:22px;height:22px;display:block}

    /* segmented control */
    .seg{display:inline-flex;background:#0E1726;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .seg button{padding:8px 12px;border:0;background:transparent;color:var(--text-mid);cursor:pointer;font-weight:700}
    .seg button.active{background:linear-gradient(135deg,#22D3EE 0%, #14B8A6 100%);color:#07121F}

    /* === CALENDAR PREVIEW (–Ω–µ–¥–µ–ª—è, —Å–≤–∞–π–ø/—Å—Ç—Ä–µ–ª–∫–∏) === */
    .preview-wrap{position:relative;margin-top:10px}
    .cal-grid{display:grid;grid-template-columns:repeat(var(--days,7),1fr);gap:8px;align-items:stretch}
    .day-card{background:#0F1828;border:1px solid var(--border);border-radius:12px;padding:10px 10px 12px;min-height:62px}
    .day-card b{display:block;margin-bottom:4px}
    .day-card .muted{font-size:13px}
    .day-card .dow{font-size:12px;color:var(--text-low);margin-bottom:2px;letter-spacing:.2px}
    .today{outline:2px solid rgba(94,234,212,.3); outline-offset:2px}
    .cal-nav{display:none}
    @media (min-width:900px){
      .cal-nav{display:block; position:absolute; top:50%; transform:translateY(-50%); background:#0e1726; border:1px solid var(--border); width:34px; height:34px; border-radius:50%; display:grid; place-items:center; color:var(--text-mid); cursor:pointer; opacity:.8}
      .cal-nav:hover{opacity:1}
      .cal-nav.left{left:-6px}
      .cal-nav.right{right:-6px}
      .cal-nav svg{width:18px;height:18px}
    }

    /* FAQ decoration */
    .faq-deco{position:absolute; right:-10px; top:-10px; opacity:.18; width:140px; height:140px; pointer-events:none}
    @media (max-width: 380px){
      .seg button{ padding:6px 8px; font-size:14px }
    }
    @media (max-width: 340px){
      .seg button{ padding:6px 6px; font-size:13px }
    }
    /* Calendar slide animation */
    .cal-grid{ transition: transform 260ms ease, opacity 260ms ease }
    .cal-grid.leave-left{ transform: translateX(-12%); opacity: 0 }
    .cal-grid.leave-right{ transform: translateX(12%); opacity: 0 }
    .cal-grid.pre-enter-left{ transform: translateX(-12%); opacity: 0 }
    .cal-grid.pre-enter-right{ transform: translateX(12%); opacity: 0 }

  
    /* Show calendar arrows on desktop (pointer: fine), even if viewport is narrow */
    .no-touch .cal-nav{display:grid; position:absolute; top:50%; transform:translateY(-50%); background:#0e1726; border:1px solid var(--border); width:34px; height:34px; border-radius:50%; place-items:center; color:var(--text-mid); cursor:pointer; opacity:.85}
    .no-touch .cal-nav:hover{opacity:1}
    .no-touch .cal-nav.left{left:-6px}
    .no-touch .cal-nav.right{right:-6px}
    .no-touch .cal-nav svg{width:18px;height:18px}

    /* === Interactions (scoped as requested) === */

    /* Save button: hover tint + press + ripple container */
    #save{ position:relative; overflow:hidden; isolation:isolate; transition:filter .2s ease, transform .12s ease }
    #save:hover{ filter: brightness(1.07) saturate(1.03) }
    #save:active{ transform: scale(.98) }

    /* Generic ripple element (used for #save) */
    .ripple-ink{
      position:absolute; border-radius:50%; pointer-events:none; transform:scale(0);
      background: radial-gradient(circle, rgba(255,255,255,.45) 0%, rgba(255,255,255,.25) 40%, rgba(255,255,255,0) 60%);
      mix-blend-mode: screen; opacity:.75; animation: ripple .6s ease-out forwards;
    }
    @keyframes ripple{ to{ transform:scale(12); opacity:0 } }

    /* Dose chips: press compression */
    #chips .chip{ transition: transform 120ms ease }
    #chips .chip:active{ transform: scale(.96) }

    /* Calendar: hover glow + press */
    .day-card{ cursor:pointer; transition: transform 120ms ease, box-shadow 200ms ease }
    .day-card:hover{ box-shadow: 0 0 0 2px rgba(94,234,212,.30) inset, 0 8px 22px rgba(20,184,166,.12) }
    .day-card:active{ transform: scale(.98) }

    /* Reset button: hover red tint + press */
    #resetBtn{ transition: background-color .2s ease, border-color .2s ease, transform .12s ease }
    #resetBtn:hover{ background:#1d0d14; border-color:#d33a49 }
    #resetBtn:active{ transform: scale(.98) }

  
    /* Persistent selection glow */
    .day-card.selected{ box-shadow: 0 0 0 2px rgba(94,234,212,.38) inset, 0 8px 24px rgba(20,184,166,.18) }
    #chips .chip.selected{ border-color:#14B8A6; box-shadow: 0 0 0 2px rgba(94,234,212,.30) inset }

  
    /* === Mobile horizontal flat scroll (3 cards + snapping) === */
    @media (max-width: 720px){
      .preview-wrap{ overflow-x:hidden }
      .cal-grid{
        display:flex;
        overflow-x:auto;
        gap:8px;
        padding-bottom:6px;
        scroll-snap-type:x mandatory;
        -webkit-overflow-scrolling: touch;
        scroll-padding-left:4px;
        user-select:none;
      }
      .cal-grid::-webkit-scrollbar{ height:0 }
      .day-card{
        flex:0 0 auto;
        scroll-snap-align:start;
        min-width: clamp(110px, 32vw, 140px); /* ~3 –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ —ç–∫—Ä–∞–Ω */
      }
      /* –∞–≤—Ç–æ–ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫—Ä–æ–ª–ª–∞ */
      .day-card.snap{ box-shadow: 0 0 0 2px rgba(94,234,212,.28) inset, 0 6px 16px rgba(20,184,166,.10) }
    }

  
/* --- Reminder Block --- */
.rem-ctrl{ display:flex; align-items:center; gap:12px; }
.rem-ctrl .switch{ display:flex; align-items:center; gap:8px; color:var(--text); }
.rem-ctrl .switch input[type="checkbox"]{ width:42px; height:24px; accent-color:#22D3EE; }
.rem-ctrl .time input[type="time"]{ background:#0E1726; border:1px solid var(--border); color:var(--text); padding:6px 10px; border-radius:10px; }

.flip-wrap{ margin-top:12px; display:flex; justify-content:center; }
.flip-card{
  width: min(520px, 100%);
  height: 160px;
  perspective: 1000px;
  border-radius:16px;
  position:relative;
}
.flip-card .face{
  position:absolute; inset:0;
  border-radius:16px;
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  backface-visibility: hidden;
  box-shadow: 0 12px 28px rgba(0,0,0,.30), inset 0 0 0 1px rgba(255,255,255,.05);
  transition: transform .8s cubic-bezier(.2,.7,.2,1), opacity .8s ease, filter .6s ease;
  overflow:hidden;
}
.face-front{
  background: radial-gradient(120% 140% at 12% 8%, rgba(255,255,255,.18), rgba(255,255,255,0) 45%),
             linear-gradient(165deg, #ff84c1 0%, #ff5aa0 35%, #ff4f8b 55%, #ff3b6b 72%, #e7363a 100%);
  animation: rem-pulse 2.2s ease-in-out infinite;
}
.face-back{
  background: radial-gradient(120% 140% at 12% 8%, rgba(255,255,255,.18), rgba(255,255,255,0) 45%),
              linear-gradient(140deg, #34e59b 0%, #22d3ee 52%, #33b5e5 76%, #2ea4e0 100%);
  transform: rotateY(180deg);
}
.flip-card.flipped .face-front{ transform: rotateY(180deg); opacity:.0; filter: blur(0.3px); animation:none; }
.flip-card.flipped .face-back{ transform: rotateY(360deg); opacity:1; }

.flip-card .icon{ font-size:28px; margin-bottom:8px; }
.flip-card .msg{ font-size:18px; text-align:center; padding:0 16px; }
.flip-card .sub{ font-size:12px; opacity:.7; margin-top:6px; }

@keyframes rem-pulse{
  0%,100%{ box-shadow: 0 0 0 0 rgba(239,68,68,.30), 0 12px 28px rgba(0,0,0,.30); }
  50%   { box-shadow: 0 0 0 10px rgba(239,68,68,.08), 0 12px 28px rgba(0,0,0,.30); }
}
@keyframes rem-wiggle{
  0%, 90%, 100%{ transform: none }
  92%{ transform: translateX(-1px) rotate(-0.8deg) }
  94%{ transform: translateX(2px)  rotate(0.8deg) }
  96%{ transform: translateX(-1px) rotate(-0.8deg) }
  98%{ transform: translateX(1px)  rotate(0.8deg) }
}

/* –Ω–∞ –∫—Ä–∞—Å–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ */
.flip-card .face-front{
  /* —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å rem-pulse ‚Äî –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å –≤—Ç–æ—Ä—É—é –∞–Ω–∏–º–∞—Ü–∏—é —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: */
  animation: rem-pulse 2.2s ease-in-out infinite, rem-wiggle 2s ease-in-out infinite;
}

/* –∫–æ–≥–¥–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞ ‚Äî –∞–Ω–∏–º–∞—Ü–∏–∏ front-—Å—Ç–æ—Ä–æ–Ω—ã –≤—ã–∫–ª—é—á–∞–µ–º,
   —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ¬´–¥—Ä–æ–∂–∏¬ª —É –∑–µ–ª—ë–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã */
.flip-card.flipped .face-front{
  animation: none;
}
/* –°–µ—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è—Ö */
.rem-off .face-front{ background: linear-gradient(135deg, #64748b 0%, #475569 100%); animation:none; }
.rem-off .face-back{ background: linear-gradient(135deg, #64748b 0%, #475569 100%); }

  
/* Toggle switch (for reminder enable) */
.rem-ctrl{ display:flex; align-items:center; gap:12px; }
.rem-ctrl .rem-label{ color:var(--text-mid); }
.toggle{ position:relative; width:44px; height:24px; display:inline-block; }
.toggle input{ opacity:0; width:0; height:0; position:absolute; }
.toggle .slider{
  position:absolute; inset:0; border-radius:999px;
  background:#0E1726; border:1px solid var(--border);
  box-shadow: inset 0 1px 2px rgba(0,0,0,.35);
  transition: background .18s ease, border-color .18s ease;
}
.toggle .slider::after{
  content:""; position:absolute; width:20px; height:20px; left:2px; top:1.5px;
  background:#fff; border-radius:50%; box-shadow:0 1px 2px rgba(0,0,0,.25);
  transition: transform .18s ease;
}
.toggle input:checked + .slider{
  background: linear-gradient(135deg, #22D3EE 0%, #14B8A6 100%);
  border-color: transparent;
}
.toggle input:checked + .slider::after{ transform: translateX(20px); }

/* Brighter gradients for reminder card */
.face-front{
  background:
    radial-gradient(120% 140% at 80% 20%, rgba(255,255,255,.12), rgba(255,255,255,0)),
    linear-gradient(135deg, #ff3b5c 0%, #ff6b86 45%, #ff93a5 100%);
  animation: rem-pulse 2.2s ease-in-out infinite;
}
.face-back{
  background:
    radial-gradient(120% 140% at 80% 20%, rgba(255,255,255,.12), rgba(255,255,255,0)),
    linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
}
/* Glassmorphism –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è */
.flip-card { position: relative; }           /* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —è–∫–æ—Ä–∏–º, –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω–æ */
.flip-card .face{
  position: absolute; inset: 0;              /* –í–ê–ñ–ù–û: –≤–µ—Ä–Ω—É—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ */
  border:1px solid rgba(255,255,255,.22);
  box-shadow:0 14px 34px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
  backdrop-filter: blur(14px) saturate(1.35);
  -webkit-backdrop-filter: blur(14px) saturate(1.35);
}
.flip-card .face::before{
  content:"";
  position:absolute; inset:0; pointer-events:none;
  background:linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,0) 30%, rgba(0,0,0,.08) 100%);
  mix-blend-mode:soft-light;
  border-radius:inherit;
}

  
/* Stepper for dose input */
.mg-wrap{ display:flex; align-items:center; gap:8px }
.mg-wrap #mg{ width:120px; height:44px; padding:10px 12px; border-radius:12px }
.stepper{ display:inline-flex; gap:8px }
.stepper .step{
  width:44px; height:44px; border-radius:12px; border:1px solid var(--border);
  background:var(--surface); color:var(--text-high); font-weight:800; font-size:20px; line-height:1;
  display:grid; place-items:center; cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,.25);
}
.stepper .step:active{ transform:scale(.98) }
@media (max-width:420px){
  .mg-wrap #mg{ width:100px }
}

/* Center "sub" text and set card paddings */
.flip-card .face{ padding:16px; } /* 16‚Äì20px */
.flip-card .sub{ text-align:center; line-height:1.4; }
/* –ö–∞–ª–µ–Ω–¥–∞—Ä—å –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω */
#calWrap, #cardCalendar .preview-wrap{
  display:block !important;
  max-height:none !important;
  opacity:1 !important;
  transform:none !important;
}

  
/* "–û—Ç–∫—Ä—ã—Ç—å" ‚Äî –º–∞–ª–µ–Ω—å–∫–∞—è –≥–æ–ª—É–±–∞—è –∫–Ω–æ–ø–∫–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π —Å–∂–∞—Ç–∏—è */
.open-btn{
  display:inline-flex; align-items:center; justify-content:center;
  height:36px; padding:0 12px; border-radius:12px; text-decoration:none;
  background-image:linear-gradient(135deg,#22D3EE 0%, #14B8A6 100%);
  color:#07121F; font-weight:800; border:1px solid rgba(255,255,255,.06);
  box-shadow:0 6px 14px rgba(0,0,0,.25);
  transition: filter .15s ease, transform .12s ease;
}
.open-btn:hover{ filter:brightness(1.06) saturate(1.02); }
.open-btn:active{ transform:scale(.97); }

/* –ö–∞–ª–µ–Ω–¥–∞—Ä—å –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
#calWrap, #cardCalendar .preview-wrap{ display:block; }

/* === Pill burst FX for "–î–æ–±–∞–≤–∏—Ç—å" button === */
#save{ position:relative; overflow:hidden; isolation:isolate }
#save .fx-pill{
  position:absolute; left:0; top:0; transform:translate(-50%,-50%) scale(.4);
  font-size:18px; line-height:1; filter: drop-shadow(0 3px 6px rgba(0,0,0,.35));
  animation: pill-up .8s cubic-bezier(.2,.9,.2,1) forwards;
  pointer-events:none;
}
@keyframes pill-up{
  0%{ transform:translate(-50%,-50%) scale(.4); opacity:0 }
  45%{ transform:translate(-50%,-90%) scale(1.15); opacity:1 }
  70%{ transform:translate(-50%,-72%) scale(.95) }
  100%{ transform:translate(-50%,-130%) scale(1); opacity:0 }
}
#save .fx-dot{
  position:absolute; width:6px; height:6px; border-radius:50%;
  left:0; top:0; transform:translate(-50%,-50%); opacity:.95;
  animation: dot-burst .7s ease-out forwards;
  pointer-events:none;
}
@keyframes dot-burst{
  0%{ transform:translate(-50%,-50%) scale(.8); opacity:.95 }
  100%{ transform:translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(.9); opacity:0 }
}
/* --- Date group keeps label and input on one line --- */
.date-wrap{ display:flex; align-items:center; gap:8px; white-space:nowrap }
.date-wrap input#date{ width:180px }
@media (max-width:420px){
  .date-wrap input#date{ width:150px }
}
/* --- Calendar: fixed 7-day 3-2-2 grid layout --- */
.cal-grid{ display:grid !important; grid-template-columns:repeat(6, 1fr); gap:8px; 
  overflow:visible !important; scroll-snap-type:none !important; }
.cal-grid .day-card{ min-width:unset !important; grid-column: span 2; }     /* 1‚Äì3 */
.cal-grid .day-card:nth-child(4),
.cal-grid .day-card:nth-child(5){ grid-column: span 3; }                    /* 4‚Äì5 */
.cal-grid .day-card:nth-child(6),
.cal-grid .day-card:nth-child(7){ grid-column: span 3; }                    /* 6‚Äì7 */
@media (max-width:520px){
  .cal-grid{ grid-template-columns:repeat(6, 1fr); }
}


/* --- NOPE toast for reminder front click --- */
.flip-card { position:relative; }
.nope-toast{
  position:absolute; left:50%; top:14px; transform:translate(-50%, -6px);
  padding:8px 12px; border-radius:12px; font-weight:800; letter-spacing:.2px;
  color:#fff; background:rgba(7,13,24,.72); border:1px solid rgba(255,255,255,.08);
  box-shadow:0 10px 28px rgba(0,0,0,.35);
  backdrop-filter: blur(8px) saturate(1.1);
  -webkit-backdrop-filter: blur(8px) saturate(1.1);
  pointer-events:none; white-space:nowrap;
  animation:nope-pop 1.1s ease forwards;
}
@keyframes nope-pop{
  0%{ opacity:0; transform:translate(-50%,-2px) scale(.95) }
  12%{ opacity:1; transform:translate(-50%,-6px) scale(1) }
  86%{ opacity:1 }
  100%{ opacity:0; transform:translate(-50%,-16px) scale(.98) }
}


/* === Animal Progress Bar (snail/turtle/hare) === */
.animal-wrap{ margin-top:10px }
.animal-track{
  --w: 0%;
  position:relative; height:18px; border-radius:999px;
  background:rgba(255,255,255,.06);
  border:1px solid var(--border);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.04), 0 6px 12px rgba(0,0,0,.28);
  overflow:hidden;
}
.animal-fill{
  position:absolute; inset:0 auto 0 0; width:var(--w);
  background:linear-gradient(90deg,#22D3EE 0%, #14B8A6 100%);
  transition: width .6s cubic-bezier(.2,.7,.2,1);
}
.animal-emoji{
  position:absolute; left:var(--w); top:50%; transform:translate(-50%,-50%);
  font-size:22px; line-height:1;
  filter: drop-shadow(0 3px 6px rgba(0,0,0,.35));
  transition:left .6s cubic-bezier(.2,.7,.2,1);
  animation: animal-bob 2.2s ease-in-out infinite;
}
@keyframes animal-bob{
  0%,100%{ transform: translate(-50%, -50%) scaleX(-1); }
  50%    { transform: translate(-50%, -52%) scaleX(-1); }
}

/* === Page Fade&Slide transitions === */
body.page-enter{
  opacity:0; transform:translateY(8px);
  animation:pageIn .22s ease forwards;
}
body.page-exit{
  pointer-events:none;
  animation:pageOut .22s ease forwards;
}
@keyframes pageIn{to{opacity:1; transform:none}}
@keyframes pageOut{to{opacity:0; transform:translateY(-8px)}}

/* --- Bottom tabbar (copied from myprofile.html) --- */
.tabbar{ position:fixed; left:0; right:0; bottom:0; z-index:40; display:grid; grid-template-columns:repeat(5,1fr); gap:6px; padding:8px 12px calc(8px + env(safe-area-inset-bottom)); background:rgba(6,12,19,.78); backdrop-filter: blur(12px); border-top:1px solid rgba(255,255,255,.12) }
.tab{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; height:56px; border-radius:14px; color:#a9b0c8 }
.tab.active{ color:#fff; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.14) }
.tab svg{ width:20px; height:20px }
/* Light theme override for tabbar to match myprofile */
body.light .tabbar{ background:rgba(255,255,255,.85); border-top:1px solid rgba(0,0,0,.08); }
body.light .tab.active{ color:#0d1220; background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65)); border:1px solid rgba(0,0,0,.12); }


/* View Transitions Fade&Slide to match myprofile */
@keyframes vt-fade-slide-in {
  from { opacity: 0; transform: translateY(8px) scale(.995); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
@keyframes vt-fade-slide-out {
  from { opacity: 1; transform: translateY(0) scale(1); }
  to   { opacity: 0; transform: translateY(-8px) scale(.995); }
}
::view-transition-old(root){ animation: vt-fade-slide-out .35s ease both; }
::view-transition-new(root){ animation: vt-fade-slide-in  .35s ease both; }

</style>
</head>
<body>
  <!-- defs –¥–ª—è –Ω–æ–≤—ã—Ö –∫–æ–ª–µ—Ü –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
<svg width="0" height="0" style="position:absolute;left:-9999px;top:-9999px" aria-hidden="true" focusable="false">
  <defs>
    <!-- —Ç—Ä–µ–∫ -->
    <linearGradient id="ringTrackGrad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#1c2636"/>
      <stop offset="1" stop-color="#0f1726"/>
    </linearGradient>
    <!-- –∞–∫—Ç–∏–≤–Ω–∞—è –¥—É–≥–∞ -->
    <linearGradient id="ringArcGrad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#13ef8b"/>
      <stop offset="1" stop-color="#11d1f0"/>
    </linearGradient>
    <!-- –≤–Ω–µ—à–Ω–µ–µ –º—è–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ -->
    <filter id="ringGlow" x="-40%" y="-40%" width="180%" height="180%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="b"/>
      <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <!-- –ª—ë–≥–∫–æ–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞ -->
    <filter id="ringInner" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="3" result="blur"/>
      <feComposite in="SourceGraphic" in2="blur" operator="arithmetic" k2="-1" k3="1" result="inner"/>
      <feColorMatrix in="inner" type="matrix"
        values="0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 .75 0" result="shadow"/>
      <feMerge><feMergeNode in="shadow"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
  </defs>
</svg>
  <div class="wrap">
    <h1>Roaccutane Tracker</h1>

    <section class="card clickable" id="profileHeader" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
      <div class="glow"></div>
      <div class="row">
        <div class="ava" id="ava" data-shared="avatar">–î–î</div>
        <div style="flex:1">
          <div id="fullName" data-tg-name style="font-weight:700">‚Äî</div>
          <div class="muted">–î–µ–Ω—å –∫—É—Ä—Å–∞: <span id="courseDay">‚Äî</span> ¬∑ –í—ã–ø–∏—Ç–æ: <span id="consumedTop">0</span> –º–≥</div>
        </div>
      </div>
    </section>

    <section class="card section" aria-labelledby="progress-title">
      <div class="glow"></div>
      <div class="row" style="justify-content:space-between; align-items:center">
        <h2 id="progress-title" style="margin:0">–ü—Ä–æ–≥—Ä–µ—Å—Å</h2>
        <div class="seg" id="doseSeg">
  <button data-mode="min" data-short="–ú–∏–Ω." data-full="–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è">–ú–∏–Ω.</button>
  <button data-mode="opt" class="active" data-short="–û–ø—Ç." data-full="–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è">–û–ø—Ç.</button>
  <button data-mode="max" data-short="–ú–∞–∫—Å." data-full="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è">–ú–∞–∫—Å.</button>
</div>
      </div>

      <div class="row" style="justify-content:space-between;align-items:center;margin-top:4px">
        <div><b>–ö—É–º—É–ª—è—Ç–∏–≤–Ω–æ:</b> <span id="cumMg">0</span> –º–≥</div>
        <div class="muted"><b>–í—Å–µ–≥–æ:</b> <span id="cumPerKg">0,00</span> –º–≥/–∫–≥ ¬∑ –∫ <span id="targetLabel">135</span> –º–≥/–∫–≥</div>
      </div>

      <!-- –ö–æ–ª—å—Ü–∞: —Å–ª–µ–≤–∞(min) ¬∑ —Ü–µ–Ω—Ç—Ä(active) ¬∑ —Å–ø—Ä–∞–≤–∞(max) -->
      <div class="rings-rail" id="ringsRail" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ü–µ–ª–∏ –¥–æ–∑—ã">
        <div class="ring pos-left small" data-mode="min">
          <button type="button" aria-label="–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–æ–∑–∞">
            <svg viewBox="0 0 110 110">
              <svg viewBox="0 0 110 110">
  <!-- r=46, —Ç–æ–ª—Å—Ç—ã–π —à—Ç—Ä–∏—Ö 18px -->
  <circle class="track" cx="55" cy="55" r="46"
          stroke="url(#ringTrackGrad)" stroke-width="18" fill="none"
          filter="url(#ringInner)"/>
  <circle data-arc cx="55" cy="55" r="46"
          stroke="url(#ringArcGrad)" stroke-width="18" fill="none"
          stroke-linecap="round" stroke-dasharray="289" stroke-dashoffset="289"
          filter="url(#ringGlow)"/>
</svg>

            </svg>
            <div class="pct" data-pct></div>
          </button>
        </div>

        <div class="ring pos-center" data-mode="opt">
          <svg viewBox="0 0 110 110">
            <svg viewBox="0 0 110 110">
  <!-- r=46, —Ç–æ–ª—Å—Ç—ã–π —à—Ç—Ä–∏—Ö 18px -->
  <circle class="track" cx="55" cy="55" r="46"
          stroke="url(#ringTrackGrad)" stroke-width="18" fill="none"
          filter="url(#ringInner)"/>
  <circle data-arc cx="55" cy="55" r="46"
          stroke="url(#ringArcGrad)" stroke-width="18" fill="none"
          stroke-linecap="round" stroke-dasharray="289" stroke-dashoffset="289"
          filter="url(#ringGlow)"/>
</svg>

          </svg>
          <div class="pct" data-pct></div>
        </div>

        <div class="ring pos-right small" data-mode="max">
          <button type="button" aria-label="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–æ–∑–∞">
            <svg viewBox="0 0 110 110">
              <svg viewBox="0 0 110 110">
  <!-- r=46, —Ç–æ–ª—Å—Ç—ã–π —à—Ç—Ä–∏—Ö 18px -->
  <circle class="track" cx="55" cy="55" r="46"
          stroke="url(#ringTrackGrad)" stroke-width="18" fill="none"
          filter="url(#ringInner)"/>
  <circle data-arc cx="55" cy="55" r="46"
          stroke="url(#ringArcGrad)" stroke-width="18" fill="none"
          stroke-linecap="round" stroke-dasharray="289" stroke-dashoffset="289"
          filter="url(#ringGlow)"/>
</svg>

            </svg>
            <div class="pct" data-pct></div>
          </button>
        </div>
      </div>

      <div class="section" id="infoLines" style="margin-top:0">
        <div id="weightRow"><b>–í–µ—Å:</b> <span id="weightLine">‚Äî</span> –∫–≥</div>
        <div id="goalsLine"><b>–¶–µ–ª–∏:</b> 120 / <b>135</b> / 150 –º–≥/–∫–≥ <span id="goalsByWeight" class="muted"></span></div>
        <div id="animalProgress" class="animal-wrap" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å –∫—É—Ä—Å–∞">
  <div class="animal-track">
    <div class="animal-fill"></div>
    <div class="animal-emoji" id="animalEmoji" aria-hidden="true">üêå</div>
  </div>
  <div class="muted" style="margin-top:6px">
    <span id="animalPct">0%</span> ¬∑ –∫ —Ü–µ–ª–∏ <span id="animalTargetKg">135</span> –º–≥/–∫–≥
  </div>
</div>
        <div id="noWeightHint" class="muted" style="display:none;margin-top:8px">–£–∫–∞–∂–∏—Ç–µ –≤–µ—Å –≤ –ø—Ä–æ—Ñ–∏–ª–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ü–µ–ª—è–º.</div>
      </div>
    </section>

    <section class="card section" aria-labelledby="dose-title">
      <div class="glow"></div>
      <h2 id="dose-title" style="margin-bottom:8px">–û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏—ë–º</h2>
      <div class="row">
        <div>–ú–≥:</div>
        <div class="mg-wrap">
          <input id="mg" type="number" step="10" value="20" inputmode="numeric" pattern="\d*" aria-label="–î–æ–∑–∞ –≤ –º–∏–ª–ª–∏–≥—Ä–∞–º–º–∞—Ö">
          <div class="stepper">
            <button type="button" id="mgMinus" class="step" aria-label="–£–º–µ–Ω—å—à–∏—Ç—å –Ω–∞ 10 –º–≥">‚àí</button>
            <button type="button" id="mgPlus"  class="step" aria-label="–£–≤–µ–ª–∏—á–∏—Ç—å –Ω–∞ 10 –º–≥">+</button>
          </div>
        </div>
        <div class="date-wrap">
  <div>–î–∞—Ç–∞:</div>
        <input id="date" type="date" style="width:180px"></div>
        <button id="save" class="cta">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div id="doseHint" class="muted" style="margin-top:8px"></div>
      <div id="saveStatus" class="muted" style="margin-top:8px"></div>
    </section>


    <section class="card section" id="cardCalendar" aria-label="–ö–∞–ª–µ–Ω–¥–∞—Ä—å">
      <div class="glow"></div>
      <div class="row" style="justify-content:space-between"><h2 style="margin:0">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2><a href="/calendar" class="open-btn" id="openCalendarBtn">–û—Ç–∫—Ä—ã—Ç—å</a></div>

      <div class="preview-wrap" id="calWrap">
        <button class="cal-nav left" id="calPrev" aria-label="–ù–∞–∑–∞–¥ –Ω–∞ –Ω–µ–¥–µ–ª—é" title="–ù–∞–∑–∞–¥">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <div id="calPreview" class="cal-grid" aria-label="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ 7 –¥–Ω–µ–π"></div>
        <button class="cal-nav right" id="calNext" aria-label="–í–ø–µ—Ä—ë–¥ –Ω–∞ –Ω–µ–¥–µ–ª—é" title="–í–ø–µ—Ä—ë–¥">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 6l6 6-6 6"/></svg>
        </button>
      </div>
    </section>

    
    <section class="card section" aria-labelledby="reminder-title">
      <div class="glow"></div>
      <div class="row" style="justify-content:space-between; align-items:flex-start; gap:16px">
        <h2 id="reminder-title" style="margin:0">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</h2>
        <!-- –ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div id="remCtrl" class="rem-ctrl">  <label class="toggle"><input id="remToggle" type="checkbox"><span class="slider" aria-hidden="true"></span></label>  <span class="rem-label">–ù–∞–ø–æ–º–∏–Ω–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω–æ</span>  <label class="time"><input id="remTime" type="time" value="09:00"></label></div></div>

      <!-- –ø—Ä–∞–≤–∞—è –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
      <div class="flip-wrap">
        <div id="remCard" class="flip-card" aria-live="polite">
          <div class="face face-front" id="remFront">
            <div class="icon">‚ö†Ô∏è</div>
           <div class="msg"><b>–°–µ–≥–æ–¥–Ω—è –≤—ã –µ—â—ë –Ω–µ –ø—Ä–∏–Ω—è–ª–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç</b></div>
            <div class="sub">–ö–∞—Ä—Ç–æ—á–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—ã –æ—Ç–º–µ—Ç–∏—Ç–µ –ø—Ä–∏—ë–º –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞</div>
          </div>
          <div class="face face-back" id="remBack">
            <div class="icon">‚úÖ</div>
            <div class="msg">–ú–æ–ª–æ–¥–µ—Ü! –°–µ–≥–æ–¥–Ω—è –≤—ã –ø—Ä–∏–Ω—è–ª–∏ –ø—Ä–µ–ø–∞—Ä–∞—Ç</div>
            <div class="sub">–ö–∞—Ä—Ç–æ—á–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∑–∞–≤—Ç—Ä–∞</div>
          </div>
        </div>
      </div>
    </section>

    <section class="card section" aria-label="FAQ">
      <div class="glow"></div>
      <svg class="faq-deco" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#22D3EE"/>
            <stop offset="1" stop-color="#14B8A6"/>
          </linearGradient>
        </defs>
        <g opacity="0.9">
          <circle cx="60" cy="60" r="58" fill="url(#g)"/>
          <path d="M40 45a20 20 0 1 1 40 0c0 9-6 14-11 17-4 2-5 3-5 8v4" fill="none" stroke="#0a1220" stroke-width="5" stroke-linecap="round"/>
          <circle cx="59" cy="88" r="4" fill="#0a1220"/>
        </g>
      </svg>
      <h2 style="margin-bottom:8px">FAQ</h2>
      <div class="muted" style="margin:-6px 0 10px">–ö–æ—Ä–æ—Ç–∫–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏ —Å–æ–≤–µ—Ç—ã –ø–æ –∫—É—Ä—Å—É.</div>
      <a href="/faq#start" class="chip" style="margin-right:6px">–ö–∞–∫ –Ω–∞—á–∞—Ç—å</a>
      <a href="/faq#dose" class="chip" style="margin-right:6px">–î–æ–∑–∏—Ä–æ–≤–∫–∞</a>
      <a href="/faq#missed" class="chip" style="margin-right:6px">–ü—Ä–æ–ø—É—Å–∫ –¥–æ–∑—ã</a>
    </section>

    <section class="card section" aria-labelledby="reset-title" style="border-color:#3a1f2b;background:linear-gradient(180deg,#141824,#0f1624)">
      <h2 id="reset-title" style="margin-bottom:6px;color:#ffd7db">–û–±–Ω—É–ª–∏—Ç—å –≤—Å—ë</h2>
      <div class="muted" style="margin-bottom:10px">–ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã: –∂—É—Ä–Ω–∞–ª –ø—Ä–∏—ë–º–æ–≤, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π, –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫—ç—à–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞. –ü—Ä–æ—Ñ–∏–ª—å –æ—Å—Ç–∞–Ω–µ—Ç—Å—è.</div>
      <button id="resetBtn" class="cta" style="background:#151018;border:1px solid #a11a28;color:#ffd7db">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–±–Ω—É–ª–µ–Ω–∏—é</button>
    </section>

    <footer>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –¥–∞—ë—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –†–µ—à–µ–Ω–∏—è ‚Äî —Ç–æ–ª—å–∫–æ —Å –≤—Ä–∞—á–æ–º.</footer>
  </div>

  <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è: inline SVG (currentColor) -->
  
  <!-- Bottom tabbar identical to myprofile.html -->
  <nav class="tabbar">
    <a class="tab active" href="main-dark.html" data-vt-link>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 11l9-7 9 7"/><path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7"/><path d="M9 21v-6h6v6"/></svg>
      <small>–ì–ª–∞–≤–Ω–∞—è</small>
    </a>
    <a class="tab" href="calendar.html" data-vt-link>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="3"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
      <small>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</small>
    </a>
    <a class="tab" href="myprofile.html" data-vt-link>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <small>–ü—Ä–æ—Ñ–∏–ª—å</small>
    </a>
    <a class="tab" href="photolog.html" data-vt-link>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="14" rx="2"/><circle cx="8.5" cy="12" r="2.5"/><path d="M21 13l-4-4-6 6"/></svg>
      <small>–§–æ—Ç–æ–¥–Ω–µ–≤–Ω–∏–∫</small>
    </a>
    <a class="tab" href="labs.html" data-vt-link>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 2v5l-5 9a4 4 0 0 0 3.5 6h7a4 4 0 0 0 3.5-6l-5-9V2"/><path d="M8 11h8"/></svg>
      <small>–ê–Ω–∞–ª–∏–∑—ã</small>
    </a>
  </nav>


  <script>
    const tgApp = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    tgApp?.ready?.(); tgApp?.expand?.();
    const initUser = tgApp?.initDataUnsafe?.user || null;
    const initData = tgApp?.initData || '';

    // API helper
    const API_BASE = String(window.API_BASE||'').replace(/\/$/, '');
    const devTg = new URLSearchParams(location.search).get('tg') || '1002';
    function api(path, opts={}) {
      let url = /^https?:\/\//i.test(path) ? path : (API_BASE + path);
      const params = []; if (!initData && devTg) params.push('tg='+encodeURIComponent(devTg)); params.push('v=main-2025-08-27b');
      url += (url.includes('?') ? '&' : '?') + params.join('&');
      const headers = {'Content-Type':'application/json', ...(opts.headers||{})};
      if (initData) headers['X-Telegram-InitData'] = initData;
      return fetch(url, {...opts, headers});
    }

    // Utils
    function initials(name){ return (name||'').trim().split(/\s+/).slice(0,2).map(s=>s[0]||'').join('').toUpperCase() || 'U'; }
    const fmtInt = n => Number(n||0).toLocaleString('ru-RU');
    const fmt2   = n => Number(n||0).toLocaleString('ru-RU',{minimumFractionDigits:2,maximumFractionDigits:2});
    const todayISO = () => { const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); };
    function ddmmyyyy(iso){ if (!iso) return '‚Äî'; const s=String(iso).slice(0,10); const [y,m,d]=s.split('-'); return d.padStart(2,'0')+'.'+m.padStart(2,'0')+'.'+y; }
    function normalizeDate(value){ if (!value) return ''; const s=String(value); if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; const d=new Date(s); if (!isNaN(d)){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`;} return s.slice(0,10); }
    function daysDiffUTC(aISO,bISO){ try{ const a=new Date(aISO), b=new Date(bISO); const ad=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()); const bd=Date.UTC(b.getFullYear(),b.getMonth(),b.getDate()); return Math.floor((ad-bd)/86400000);}catch{ return 0; } }


    // Compact labels for segmented control if it overflows
   function updateSegLabels(){
  const seg = document.getElementById('doseSeg');
  if(!seg) return;
  const btns = Array.from(seg.querySelectorAll('button'));

  // –µ—Å–ª–∏ –≤ —Ä–∞–∑–º–µ—Ç–∫–µ —É–∂–µ –µ—Å—Ç—å data-full ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë; –∏–Ω–∞—á–µ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç
  btns.forEach(b => { b.dataset.full = b.dataset.full || b.textContent.trim(); });

  const overflow = seg.scrollWidth > seg.clientWidth + 2;
  btns.forEach(b => {
    b.textContent = overflow
      ? (b.dataset.short || b.dataset.full)   // —É–∑–∫–æ ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–µ
      : (b.dataset.full  || b.textContent);   // —à–∏—Ä–æ–∫–æ ‚Äî –ø–æ–ª–Ω—ã–µ
  });
}
updateSegLabels();  // –≤—ã–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É, –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è load
    new ResizeObserver(()=>updateSegLabels()).observe(document.getElementById('doseSeg'));
    window.addEventListener('orientationchange', updateSegLabels);
    window.addEventListener('load', updateSegLabels);

    // Animated slide for calendar
    // Detect touch vs desktop for calendar arrows
    const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints>0);
    if(!isTouch){ document.documentElement.classList.add('no-touch'); }

    // Days per view depends on container width (3 on phones, 5 on medium, 7 on wide)
    let daysPerView = 7;
    function recalcDaysPerView(){
      const grid = document.getElementById('calPreview');
      const wrap = document.getElementById('calWrap');
      const w = (grid?.offsetWidth || wrap?.offsetWidth || 700);
      daysPerView = w < 460 ? 3 : (w < 720 ? 5 : 7);
      if(grid){ grid.style.setProperty('--days', String(daysPerView)); grid.setAttribute('aria-label','–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ '+daysPerView+' –¥–Ω–µ–π'); }
    }
    window.addEventListener('resize', recalcDaysPerView);

    function slideCalendar(direction, cb){
      const grid = document.getElementById('calPreview');
      if(!grid){ cb(); return; }
      grid.classList.remove('leave-left','leave-right','pre-enter-left','pre-enter-right');
      grid.classList.add(direction==='next' ? 'leave-left' : 'leave-right');
      setTimeout(()=>{
        cb();
        grid.classList.remove('leave-left','leave-right');
        grid.classList.add(direction==='next' ? 'pre-enter-right' : 'pre-enter-left');
        void grid.offsetWidth; // reflow
        grid.classList.remove('pre-enter-right','pre-enter-left');
      }, 260);
    }



    // Ripple for the Save button (mouse & touch)
    (function setupRipple(){
      const btn = document.getElementById('save');
      if(!btn) return;
      function spawnRipple(x, y){
        const rect = btn.getBoundingClientRect();
        const d = Math.max(rect.width, rect.height);
        const ink = document.createElement('span');
        ink.className = 'ripple-ink';
        ink.style.width = ink.style.height = (d*1.2)+'px';
        ink.style.left = (x - rect.left - d*0.6)+'px';
        ink.style.top  = (y - rect.top  - d*0.6)+'px';
        btn.appendChild(ink);
        setTimeout(()=>ink.remove(), 650);
      }
      btn.addEventListener('click', (e)=>{
        if (e.clientX && e.clientY) spawnRipple(e.clientX, e.clientY);
      });
      btn.addEventListener('touchstart', (e)=>{
        try{
          const t = e.touches[0]; if(t) spawnRipple(t.clientX, t.clientY);
        }catch(_){}
      }, {passive:true});
    })();



    // Auto-highlight center card on mobile flat scroll (does not change selected date)
    (function setupCenterSnap(){
      const AUTO_SELECT_ON_SNAP = true;
      const grid = document.getElementById('calPreview');
      if(!grid) return;
      let timer;
      function highlightCenter(){
        // –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ ‚Äî –Ω–µ –≤–º–µ—à–∏–≤–∞–µ–º—Å—è
        if (grid.querySelector('.day-card.selected')) return;
        const center = grid.scrollLeft + grid.clientWidth/2;
        let best = null, bestDist = Infinity;
        const items = grid.querySelectorAll('.day-card');
        items.forEach((card)=>{
          const c = card.offsetLeft + card.offsetWidth/2;
          const d = Math.abs(c - center);
          if (d < bestDist){ bestDist = d; best = card; }
        });
        items.forEach(el=>el.classList.remove('snap'));
        if(best){ best.classList.add('snap');
          if (AUTO_SELECT_ON_SNAP && !grid.querySelector('.day-card.selected')){
            const iso = best.getAttribute('data-iso');
            const inp = document.getElementById('date');
            if (iso && inp) { inp.value = iso; renderCalPreview(); }
          }
        }
      }
      grid.addEventListener('scroll', ()=>{ clearTimeout(timer); timer = setTimeout(highlightCenter, 90); }, {passive:true});
      // –æ–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
      new MutationObserver(()=>highlightCenter()).observe(grid, {childList:true});
      window.addEventListener('load', highlightCenter);
      window.addEventListener('resize', highlightCenter);
    })();


    // Bottom nav
    function go(path){ try{ history.pushState(null,'',path); location.assign(path);}catch{ location.href = path; } }
    document.querySelectorAll('.bottom-nav a').forEach(a=>{
      a.addEventListener('click', (e)=>{ e.preventDefault(); go(a.getAttribute('href')); });
    });

    function navWithFx(url){
  const DUR = 220;
  document.body.classList.remove('page-enter');
  document.body.classList.add('page-exit');
  setTimeout(()=>{ location.assign(url); }, DUR);
}

    // Header user
    (function fillHeader(){
      const name = initUser ? [initUser.first_name, initUser.last_name].filter(Boolean).join(' ') : '‚Äî';
      document.getElementById('fullName').textContent = name;
      const ava = document.getElementById('ava');
      if (initUser && initUser.photo_url){ ava.innerHTML = '<img alt="" src="'+initUser.photo_url+'">'; }
      else{ ava.textContent = initials(name); }
    })();

    // State
    let ME=null, PLAN=null, DOSES=[], PROGRESS=null;
    const DOSE_PER_KG = { min:120, opt:135, max:150 };
    function loadDoseMode(){ try{ return localStorage.getItem('derma_dose_mode') || 'opt'; }catch(_){ return 'opt'; } }
    function saveDoseMode(m){ try{ localStorage.setItem('derma_dose_mode', m); }catch(_){} api('/api/dose-mode',{method:'POST',body:JSON.stringify({mode:m})}); }
    let DOSE_MODE = loadDoseMode();

    // RING helpers ‚Äì –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ç—Ä–∏ –∫–æ–ª—å—Ü–∞ –∏ –ø–æ–¥–ø–∏—Å–∏
    const RING_R = 46;                 // –Ω–æ–≤—ã–π —Ä–∞–¥–∏—É—Å
const RING_C = 2*Math.PI*RING_R;   // ~289.03
    function setRing(el, pct){
      const arc = el.querySelector('circle[data-arc]');
      const lbl = el.querySelector('[data-pct]');
      const p = Math.max(0, Math.min(100, Number(pct)||0));
      if (arc){
        arc.style.strokeDasharray = String(RING_C);
        arc.style.strokeDashoffset = String(RING_C*(1-p/100));
      }
      if (lbl){ lbl.textContent = fmt2(p) + '%'; }
    }

    function applyRingPositions(mode, pcts){
      const rail = document.getElementById('ringsRail');
      const rMin = rail.querySelector('.ring[data-mode="min"]');
      const rOpt = rail.querySelector('.ring[data-mode="opt"]');
      const rMax = rail.querySelector('.ring[data-mode="max"]');

      [rMin, rOpt, rMax].forEach(r=>{ r.classList.remove('pos-left','pos-center','pos-right','small'); });

      if (mode === 'min') {
        rMin.classList.add('pos-center');
        rOpt.classList.add('pos-right','small');
        rMax.classList.add('pos-left','small');
      } else if (mode === 'opt') {
        rMin.classList.add('pos-left','small');
        rOpt.classList.add('pos-center');
        rMax.classList.add('pos-right','small');
      } else { // max
        rMin.classList.add('pos-right','small');
        rOpt.classList.add('pos-left','small');
        rMax.classList.add('pos-center');
      }

      setRing(rMin, pcts.min || 0);
      setRing(rOpt, pcts.opt || 0);
      setRing(rMax, pcts.max || 0);
    }

    function setDoseMode(mode){
  if (DOSE_MODE === mode) return;         // –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–æ–∫
  DOSE_MODE = mode;
  saveDoseMode(mode);

  // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–∞
  document.querySelectorAll('#doseSeg button')
    .forEach(b => b.classList.toggle('active', b.dataset.mode === mode));

  // –ø–æ–¥–ø–∏—Å–∏ —Ü–µ–ª–µ–π
  document.getElementById('targetLabel').textContent = DOSE_PER_KG[mode];
  const etaLbl = document.getElementById('etaTargetLabel');
  if (etaLbl) etaLbl.textContent = DOSE_PER_KG[mode];

  // –í–ê–ñ–ù–û: –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª—å—Ü–∞ –∏ —É–ª–∏—Ç–∫—É
  updateSummary();
}
    // ‚Äî‚Äî‚Äî –°–≤–∞–π–ø—ã/–∫–ª–∏–∫–∏ –ø–æ –∫–æ–ª—å—Ü–∞–º (–ª–µ–≤–æ–µ/—Ü–µ–Ω—Ç—Ä/–ø—Ä–∞–≤–æ–µ) ‚Äî‚Äî‚Äî
(function wireProgressGestures(){
  const rail = document.getElementById('ringsRail');
  if (!rail) return;

  // –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∂–∏–º–æ–≤
  const order = ['min','opt','max'];
  const step = (dir)=>{                   // dir: +1 –≤–ø—Ä–∞–≤–æ, -1 –≤–ª–µ–≤–æ
    let i = order.indexOf(DOSE_MODE);
    if (i < 0) i = 1;                     // –¥–µ—Ñ–æ–ª—Ç 'opt'
    i = (i + dir + 3) % 3;
    setDoseMode(order[i]);                // –ú–ì–ù–û–í–ï–ù–ù–û–ï –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  };

  // –∫–ª–∏–∫–∏/–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ –∫–∞–∂–¥–æ–º—É –∫–æ–ª—å—Ü—É
  rail.querySelectorAll('.ring').forEach(r=>{
    r.style.cursor = 'pointer';
    r.setAttribute('role','button');
    r.setAttribute('tabindex','0');
    r.addEventListener('click', ()=> setDoseMode(r.dataset.mode));
    r.addEventListener('keydown', e=>{
      if (e.key==='Enter' || e.key===' ') { e.preventDefault(); setDoseMode(r.dataset.mode); }
    });
  });

  // —Å–≤–∞–π–ø (touch + mouse/trackpad)
  let x0 = null;
  const down = x => x0 = x;
  const up   = x => {
    if (x0 == null) return;
    const dx = x - x0; x0 = null;
    if (Math.abs(dx) > 30) step(dx < 0 ? +1 : -1);  // –≤–ª–µ–≤–æ ‚Üí —Å–ª–µ–¥—É—é—â–∏–π, –≤–ø—Ä–∞–≤–æ ‚Üí –ø—Ä–µ–¥—ã–¥—É—â–∏–π
  };

  // touch
  rail.addEventListener('touchstart', e=>down(e.touches[0].clientX), {passive:true});
  rail.addEventListener('touchend',   e=>{ const t=e.changedTouches[0]; up(t ? t.clientX : 0); }, {passive:true});

  // mouse
  rail.addEventListener('mousedown',  e=>down(e.clientX));
  window.addEventListener('mouseup',  e=>up(e.clientX));
})();

    // Swipe –ø–æ –±–ª–æ–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ + —Ç–∞–ø –ø–æ –º–∏–Ω–∏-–∫–æ–ª—å—Ü–∞–º
    
(function wireProgressGestures(){
  const rail = document.getElementById('ringsRail');
  if(!rail) return;

  // helper: move selection left/right
  const seq = ['min','opt','max'];
  const nextMode = (dir)=>{
    let i = seq.indexOf(DOSE_MODE);
    if (i === -1) i = 1; // default 'opt'
    if (dir > 0) i = (i + 1) % 3;      // to the right
    else        i = (i + 2) % 3;       // to the left
    setDoseMode(seq[i]);
  };

  // click/tap on ANY ring switches to that mode
  rail.querySelectorAll('.ring').forEach(r=>{
    r.setAttribute('role','button');
    r.setAttribute('tabindex','0');
    r.style.cursor = 'pointer';
    r.addEventListener('click', ()=> setDoseMode(r.dataset.mode));
    r.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault(); setDoseMode(r.dataset.mode);
      }
    });
  });

  // swipe (touch + mouse/trackpad)
  let startX = null;
  const onDown = (x)=>{ startX = x; };
  const onUp   = (x)=>{
    if(startX == null) return;
    const dx = x - startX; startX = null;
    if (Math.abs(dx) > 30){ nextMode(dx < 0 ? +1 : -1); }
  };

  // touch
  rail.addEventListener('touchstart', (e)=>{ onDown(e.touches[0].clientX); }, {passive:true});
  rail.addEventListener('touchend',   (e)=>{ const t=e.changedTouches[0]; onUp(t ? t.clientX : 0); }, {passive:true});

  // mouse/trackpad
  rail.addEventListener('mousedown', (e)=> onDown(e.clientX));
  window.addEventListener('mouseup', (e)=> onUp(e.clientX));

  // keyboard arrows on the whole rail
  rail.setAttribute('tabindex','0');
  rail.addEventListener('keydown', (e)=>{
    if (e.key === 'ArrowLeft'){ e.preventDefault(); nextMode(-1); }
    if (e.key === 'ArrowRight'){ e.preventDefault(); nextMode(+1); }
  });
})();

// –ö–Ω–æ–ø–∫–∏ –¥–æ–∑
    
    function syncChipsSelection(){ /* chips removed */ }
    function renderChips(drug){ /* chips removed */ updateDoseHint(); }
    
    // === –ö–∞–ª–µ–Ω–¥–∞—Ä—å: 7 –¥–Ω–µ–π, —Å–≤–∞–π–ø + —Å—Ç—Ä–µ–ª–∫–∏ ===
    let calOffset = 0; // —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç —Å–µ–≥–æ–¥–Ω—è (–≤ –¥–Ω—è—Ö) –∫—Ä–∞—Ç–Ω–æ 7
    function renderCalPreview(){
      const box=document.getElementById('calPreview'); box.innerHTML='';
      const map = new Map();
      DOSES.forEach(x=>{ const k=(x.date||'').slice(0,10); map.set(k, (map.get(k)||0) + Number(x.mg||x.mg_taken||0)); });

      const dows=['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];

      // —Å—Ç–∞–ª–æ: –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –±–∞–∑–æ–≤—É—é –¥–∞—Ç—É –∫ –ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö–£ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
const base = new Date(); base.setHours(0,0,0,0);
// calOffset —É —Ç–µ–±—è –∫—Ä–∞—Ç–µ–Ω 7 (—Å—Ç—Ä–µ–ª–∫–∏ –∏ —Å–≤–∞–π–ø—ã ¬±7), –æ—Å—Ç–∞–≤–ª—è–µ–º, –Ω–æ –ø–æ—Ç–æ–º –¥–æ–≤–æ–¥–∏–º –¥–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞
base.setDate(base.getDate() + calOffset);
const wd = base.getDay();            // 0-–≤—Å,1-–ø–Ω,...,6-—Å–±
const toMonday = (wd === 0 ? -6 : (1 - wd));
base.setDate(base.getDate() + toMonday);
      for(let i=0;i<7;i++){
        const d = new Date(base); d.setDate(base.getDate()+i);
        const y  = d.getFullYear();
const m  = String(d.getMonth()+1).padStart(2,'0');
const dd = String(d.getDate()).padStart(2,'0');
const iso = `${y}-${m}-${dd}`;
        const card = document.createElement('div'); card.className='day-card'; card.tabIndex=0; card.setAttribute('data-iso', iso);
        if (iso === todayISO()) card.classList.add('today');
        const mg = map.get(iso);
        const currentIso = (document.getElementById('date')?.value||'').slice(0,10);
        if (iso===currentIso) card.classList.add('selected');
        let _lbl;if(iso===todayISO()){_lbl = mg ? ('—Å–µ–≥–æ–¥–Ω—è ¬∑ '+fmtInt(mg)+' –º–≥ üíä') : '—Å–µ–≥–æ–¥–Ω—è';}else{_lbl = mg ? (fmtInt(mg)+' –º–≥ üíä') : '‚Äî';}card.innerHTML = '<div class="dow">'+dows[d.getDay()]+'</div><b>'+ddmmyyyy(iso)+'</b><div class="muted">'+_lbl+'</div>';
        card.addEventListener('click', ()=>{ const inp=document.getElementById('date'); if(inp){ inp.value = iso; } renderCalPreview(); });
        card.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); const inp=document.getElementById('date'); if(inp){ inp.value = iso; } renderCalPreview(); }});
        box.appendChild(card);
      }
    }
    (function wireCalNav(){
      const wrap = document.getElementById('calWrap');
      const prev = document.getElementById('calPrev');
      const next = document.getElementById('calNext');
      prev.addEventListener('click', ()=>{ calOffset -= 7; slideCalendar('prev', renderCalPreview); });
      next.addEventListener('click', ()=>{ calOffset += 7; slideCalendar('next', renderCalPreview); });
      let x0=null;
      wrap.addEventListener('touchstart', (e)=>{ x0 = e.touches[0].clientX; }, {passive:true});
      wrap.addEventListener('touchend',   (e)=>{
        if(x0==null) return;
        const x1=(e.changedTouches[0]||{}).clientX || x0; const dx=x1-x0; x0=null;
        if (Math.abs(dx)>30){ calOffset += (dx<0 ? +7 : -7); slideCalendar(dx<0 ? 'next' : 'prev', renderCalPreview); }
      }, {passive:true});
    })();

    function updateSummary(){
      let cum = 0;
      try{ cum = (PROGRESS && Number.isFinite(PROGRESS.taken_mg)) ? Number(PROGRESS.taken_mg) : 0; }catch(_){}
      if (!cum){
        const ms = DOSES.map(x=>Number(x.mg||x.mg_taken||0));
        cum   = ms.reduce((a,b)=>a+b,0);
        try{ const seed = Number(localStorage.getItem('derma_seed_cum_mg')||0); if (seed>0) cum += seed; }catch(_){}
      }

      const w = Number((ME?.weight_kg ?? ME?.weight ?? PROGRESS?.weight_kg ?? 0));
      document.getElementById('cumMg').textContent       = fmtInt(cum);
      document.getElementById('consumedTop').textContent = fmtInt(cum);
      document.getElementById('weightLine').textContent  = w>0 ? fmtInt(w) : '‚Äî';
      document.getElementById('noWeightHint').style.display = w>0 ? 'none':'block';

      const perKg = (w>0) ? (cum / w) : 0;
      document.getElementById('cumPerKg').textContent = w>0 ? fmt2(perKg) : '‚Äî';

      const targets = { min:120, opt:135, max:150 };
      const pcts = {};
      ['min','opt','max'].forEach(m=>{ pcts[m] = (w>0) ? (100 * cum / (targets[m]*w)) : 0; });

      applyRingPositions(DOSE_MODE, pcts);

      const goalsSpan = document.getElementById('goalsByWeight');
      if (w>0){
        goalsSpan.textContent = ' ¬∑ –ø–æ –≤–∞—à–µ–º—É –≤–µ—Å—É: '
          + fmtInt(Math.round(120*w)) + ' / '
          + fmtInt(Math.round(135*w)) + ' / '
          + fmtInt(Math.round(150*w)) + ' –º–≥';
      } else { goalsSpan.textContent = ''; }

      let eta = '‚Äî';
      const byDate = {}; DOSES.forEach(x=>{ const k=(normalizeDate(x.date)||'').slice(0,10); byDate[k]=(byDate[k]||0)+Number(x.mg||x.mg_taken||0); });
      const today = todayISO();
      // –ë–µ—Ä—ë–º ISO –±–µ–∑ —Å–¥–≤–∏–≥–∞ –≤ UTC (–ª–æ–∫–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)
const isoLocal = (d) => {
  const t = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return t.toISOString().slice(0,10);
};
      const sumDays = (n) => {
        let s = 0;
        const [Y,M,D] = today.split('-').map(Number);
        const base = new Date(Date.UTC(Y, M - 1, D));
        for (let i = 0; i < n; i++) { const d = new Date(base); d.setUTCDate(d.getUTCDate() - i); const iso = d.toISOString().slice(0, 10); s += (byDate[iso] || 0); }
        return s;
      };
      const a7  = sumDays(7)/7;
      const a14 = sumDays(14)/14;
      const avgForEta = a14>0? a14 : (a7>0? a7 : 0);
      const targetKg = targets[DOSE_MODE];
      if (w>0 && avgForEta>0){
        const left = Math.max(0, targetKg*w - cum);
        const days = Math.ceil(left / avgForEta);
        const dt = new Date(); dt.setDate(dt.getDate()+days);
        eta = ddmmyyyy(dt.toISOString().slice(0,10));
      }
      var _etaT = document.getElementById('etaTargetLabel'); if(_etaT) _etaT.textContent = targetKg;
      var _eta = document.getElementById('eta135'); if(_eta) _eta.textContent = eta;
      (function(){
        try{
          var wrap = document.getElementById('animalProgress');
          if(!wrap) return;
          var p = Math.max(0, Math.min(100, (pcts[DOSE_MODE]||0)));
          var track = wrap.querySelector('.animal-track');
          var fill = wrap.querySelector('.animal-fill');
          var emoji = wrap.querySelector('.animal-emoji');
          if(track){ track.style.setProperty('--w', p + '%'); }
          if(fill){ fill.style.width = p + '%'; }
          if(emoji){ emoji.style.left = p + '%'; emoji.textContent = (p<34?'üêå':(p<67?'üê¢':'üêá')); }
          var pctEl = document.getElementById('animalPct'); if(pctEl) pctEl.textContent = fmt2(p) + '%';
          var tEl = document.getElementById('animalTargetKg'); if(tEl) tEl.textContent = targetKg;
        }catch(_){ }
      })();

      let day='‚Äî';
      if (PLAN?.start_date){
        const diff = daysDiffUTC(new Date().toISOString().slice(0,10), PLAN.start_date);
        day = diff>=0 ? String(1+diff) : '‚Äî';
      }
      document.getElementById('courseDay').textContent = day;
    }

    function renderLast(){
      const box = document.getElementById('lastDoses');
      if (!DOSES.length){ box.textContent='–ù–µ—Ç –æ—Ç–º–µ—Ç–æ–∫'; return; }
      const rows = DOSES.slice(0,4).map(x => ddmmyyyy((normalizeDate(x.date)||'').slice(0,10))+': '+fmtInt(Number(x.mg||x.mg_taken||0))+' –º–≥ üíä');
      box.innerHTML = rows.join('<br>');
    }

    async function loadAll(){
      try{
        const [meR, planR, doseR, prR] = await Promise.all([
          api('/api/me'),
          api('/api/plan'),
          api('/api/intakes?limit=60'),
          api('/api/progress?mode='+encodeURIComponent(DOSE_MODE))
        ]);
        ME        = meR.ok   ? await meR.json()   : null;
        PLAN      = planR.ok ? await planR.json() : null;
        DOSES     = doseR.ok ? (await doseR.json()) : [];
        DOSES     = DOSES.map(d => ({ ...d, date: normalizeDate(d.date) }));
        PROGRESS  = prR.ok   ? await prR.json()   : null;
        window.__intakesLoaded = true;

        renderChips((PLAN?.drug||'roaccutane').toLowerCase());
        document.getElementById('date').value = todayISO();
        document.getElementById('date').addEventListener('change', ()=>{ renderCalPreview(); });
        updateSummary(); renderLast(); recalcDaysPerView(); renderCalPreview(); updateDoseHint();
      } catch(e) {
  renderChips('roaccutane');
  try { document.getElementById('date').value = todayISO(); } catch(_){}
  try { recalcDaysPerView(); renderCalPreview(); updateDoseHint(); } catch(_){}
}
    }

    document.getElementById('mg').addEventListener('input', syncChipsSelection);

    document.getElementById('save').addEventListener('click', async ()=>{
      const mg   = Number(document.getElementById('mg').value || 0);
      const date = document.getElementById('date').value || todayISO();
      const st   = document.getElementById('saveStatus');
      if (!(mg > 0)) { st.textContent = '–í–≤–µ–¥–∏—Ç–µ –¥–æ–∑—É > 0'; return; }
      st.textContent = '–°–æ—Ö—Ä–∞–Ω—è—é...';
      try {
        const r = await api('/api/intakes', { method: 'POST', body: JSON.stringify({ mg, date }) });
        if (!r.ok) { st.textContent = '–û—à–∏–±–∫–∞ ' + r.status; return; }
        st.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
        DOSES.unshift({ mg: mg, date: date });
        try{
          const iso = (date||'').slice(0,10);
          if (iso === (window.todayISO? window.todayISO(): iso)){
            const prev = Number(localStorage.getItem('derma_today_mg')||0);
            localStorage.setItem('derma_today_iso', iso);
            localStorage.setItem('derma_today_mg', String(prev + mg));
          }
        }catch(_){}
        try{ document.getElementById('remCard')?.classList.add('flipped'); }catch(_){}
        try{ window.renderReminder && window.renderReminder(); }catch(_){}

        await loadAll().then(()=>{ try{ window.renderReminder && window.renderReminder(); }catch(_){ } }); updateDoseHint();
      } catch (e) {
        st.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
      }
    });

    (async function hydrateTgUser(){
  const tg  = window.Telegram?.WebApp;
  const nameEl = document.querySelector('#tgName, #topName, #fullName, [data-tg-name]');
  const avaEl  = document.querySelector('#ava, #topAva, [data-tg-ava]');

  function setInitials(target, name){
    const i = (name||'').trim().split(/\s+/).map(s=>s[0]||'').slice(0,2).join('').toUpperCase() || 'U';
    if (target) target.textContent = i;
  }
  function putPhoto(target, url, fallbackName){
    if (!target) return setInitials(target, fallbackName);
    const img = new Image(); img.alt='';
    img.src = url; img.onload = ()=>{ target.innerHTML=''; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; target.appendChild(img); };
    img.onerror = ()=> setInitials(target, fallbackName);
  }

  let name = '', photo = '';
  const u = tg?.initDataUnsafe?.user;
  if (u) { name = [u.first_name,u.last_name].filter(Boolean).join(' '); photo = u.photo_url||''; }
  if (!name) {
    const qs = new URLSearchParams(location.search);
    name  = qs.get('tg_name')  || '';
    photo = qs.get('tg_photo') || '';
  }
  if (!name) {
    try { const r = await api('/api/me'); if (r.ok) { const me = await r.json(); name = me.full_name || name; } } catch(_){}
  }

  if (nameEl) nameEl.textContent = name || '‚Äî';
  if (photo) putPhoto(avaEl, photo, name); else setInitials(avaEl, name);
})();


    document.getElementById('resetBtn').addEventListener('click', ()=>{
      location.href = './reset-dark.html' + (location.search||'');
    });
    loadAll().then(()=>{ try{ window.renderReminder && window.renderReminder(); }catch(_){ } });
    document.querySelectorAll('#doseSeg button').forEach(b=> b.addEventListener('click', ()=> setDoseMode(b.dataset.mode) ));
    document.querySelector('#doseSeg button[data-mode="'+(DOSE_MODE||'opt')+'"]')?.click();
  
// === Reminder block logic ===
(function(){
  
  const todayIsoFn = (typeof window.todayISO === 'function')
    ? window.todayISO
    : () => { const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); };

  
  function drugRu(){
  const raw = ((PLAN?.drug || '') + '').trim().toLowerCase();
  if (!raw) return '–ø—Ä–µ–ø–∞—Ä–∞—Ç';
  if (raw.includes('akne') || raw.includes('aknek') || raw.includes('–∞–∫–Ω–µ–∫') || raw === 'aknekutan' || raw === '–∞–∫–Ω–µ–∫–∫—É—Ç–∞–Ω') return '–∞–∫–Ω–µ–∫–∫—É—Ç–∞–Ω';
  if (raw.includes('roacc') || raw.includes('—Ä–æ–∞–∫–∫') || raw === 'roaccutane' || raw === '—Ä–æ–∞–∫–∫—É—Ç–∞–Ω') return '—Ä–æ–∞–∫–∫—É—Ç–∞–Ω';
  return '–ø—Ä–µ–ø–∞—Ä–∞—Ç';
}
  function setReminderTexts(){
    const front = document.getElementById('remFront')?.querySelector('.msg');
    const back  = document.getElementById('remBack')?.querySelector('.msg');
    const drug = drugRu();
    if (front) front.innerHTML = '<b>–°–µ–≥–æ–¥–Ω—è –≤—ã –µ—â—ë –Ω–µ –ø—Ä–∏–Ω—è–ª–∏ ' + drug + '</b>';
    if (back)  back.textContent = '–ú–æ–ª–æ–¥–µ—Ü! –°–µ–≥–æ–¥–Ω—è –≤—ã –ø—Ä–∏–Ω—è–ª–∏ ' + drug;
  }

  const state = {
    enabled: (localStorage.getItem('rem_enabled') ?? '1') === '1',
    time: localStorage.getItem('rem_time') || '09:00',
  };
// --- Helpers for time-based reset (local device time) ---
function parseHHMM(s){
  const m = String(s||'09:00').match(/^(\d{1,2}):(\d{2})$/); 
  const hh = m ? Math.min(23, Math.max(0, parseInt(m[1],10))) : 9;
  const mm = m ? Math.min(59, Math.max(0, parseInt(m[2],10))) : 0;
  return [hh,mm];
}
function todayISOlocal(){
  const d = new Date();
  d.setHours(0,0,0,0);
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function ydayISOlocal(){
  const d = new Date();
  d.setDate(d.getDate()-1);
  d.setHours(0,0,0,0);
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
// "Logical" day tied to user's reminder time (before reminder -> yesterday bucket)
function logicalIsoByReminder(remTime){
  try{
    const [hh,mm]=parseHHMM(remTime);
    const now=new Date();
    const boundary=new Date(); boundary.setHours(hh,mm,0,0);
    return (now < boundary) ? ydayISOlocal() : todayISOlocal();
  }catch(_){ return todayIsoFn(); }
}
// Boundary id changes each time the reminder time "ticks" for a new day
function boundaryId(remTime){
  // use today's date if boundary passed, otherwise yesterday's date
  return logicalIsoByReminder(remTime);
}
function scheduleByReminder(){
  let last = null;
  const tick = ()=>{
    const id = boundaryId(state.time);
    if (id !== last){
      last = id;
      try{ localStorage.setItem('rem_boundary_id', id); }catch(_){}
      renderReminder();
    }
  };
  try{ last = localStorage.getItem('rem_boundary_id') || boundaryId(state.time); }catch(_){ last = boundaryId(state.time); }
  tick();
  setInterval(tick, 30*1000);
}


  
  
  function getTodayDoseMgLS(){
    try{
      const isoLS = localStorage.getItem('derma_today_iso')||'';
      if (isoLS === todayIsoFn()) return Number(localStorage.getItem('derma_today_mg')||0) || 0;
    }catch(_){}
    return 0;
  }
function getTodayDoseMg(){
    const iso = logicalIsoByReminder(state.time);
    let sum = 0;
    (Array.isArray(DOSES)? DOSES : []).forEach(x=>{
      const k=(x.date||'').slice(0,10);
      if (k===iso) sum += Number(x.mg||x.mg_taken||0) || 0;
    });
    return sum;
  }

  function applyCtrl(){
    const toggle = document.getElementById('remToggle');
    const time   = document.getElementById('remTime');
    const card   = document.getElementById('remCard');

    if (!toggle || !time || !card) return;

    toggle.checked = state.enabled;
    time.value = state.time;
    card.classList.toggle('rem-off', !state.enabled);

    toggle.addEventListener('change', ()=>{
      state.enabled = toggle.checked;
      localStorage.setItem('rem_enabled', state.enabled? '1':'0');
      card.classList.toggle('rem-off', !state.enabled);
    });
    time.addEventListener('change', ()=>{
      state.time = time.value || '09:00';
      localStorage.setItem('rem_time', state.time);
    });
  }

  
  function renderReminder(){
    const card = document.getElementById('remCard');
    if (!card) return;
    const sum = getTodayDoseMg();
    const ls  = getTodayDoseMgLS();
    // keep LS in sync with factual sum
    try{
      const tISO = todayIsoFn();
      if (sum > 0){
        localStorage.setItem('derma_today_iso', tISO);
        localStorage.setItem('derma_today_mg', String(sum));
      } else {
        // –µ—Å–ª–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏—à—ë–ª –Ω–æ–ª—å ‚Äî –æ–±–Ω—É–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å
        if ((localStorage.getItem('derma_today_iso')||'') === tISO){
          localStorage.setItem('derma_today_mg', '0');
        }
      }
    }catch(_){}
    // –î–æ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏—ë–º–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–ø–∞—Å–Ω–æ–π LS-—Ñ–æ–ª–ª–±–µ–∫,
    // –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    const took = (window.__intakesLoaded ? (sum > 0) : ((sum > 0) || (ls > 0)));
    card.classList.toggle('flipped', took);
}
window.renderReminder = renderReminder;

  // Render immediately so the card state persists across reloads (uses localStorage if API not ready yet)
  try{ applyCtrl(); setReminderTexts(); renderReminder(); }catch(_){}
  
  function midnightSchedule(){ /* obsolete: keep for safety */
    let last = todayIsoFn();
    setInterval(()=>{
      const cur = todayIsoFn();
      if (cur !== last){
        last = cur;
        renderReminder(); // —Å–±—Ä–æ—Å–∏—Ç—å –Ω–∞ –Ω–æ–≤—ã–π –¥–µ–Ω—å
      }
    }, 60*1000);
  }

  // tap/press on the reminder card
  const remCardEl = document.getElementById('remCard');
  if (remCardEl){
    remCardEl.addEventListener('click', (e)=>{
      // only if it's the red front side (no intake today)
      const took = getTodayDoseMg() > 0;
      if (!took){
        try {
          (tgApp && tgApp.HapticFeedback && tgApp.HapticFeedback.notificationOccurred)
            ? tgApp.HapticFeedback.notificationOccurred('error')
            : (navigator.vibrate && navigator.vibrate([10,40,10]));
        } catch(_){}
        // quick flip + "–Ω–µ—Ç-–Ω–µ—Ç-–Ω–µ—Ç" toast
        remCardEl.classList.add('flipped');
        const toast = document.createElement('div');
        toast.className = 'nope-toast';
        toast.textContent = '–ù–µ—Ç-–Ω–µ—Ç-–Ω–µ—Ç ‚òùÔ∏è  —Ç—ã –µ—â—ë –Ω–µ –ø—Ä–∏–Ω—è–ª –ø—Ä–µ–ø–∞—Ä–∞—Ç';
        remCardEl.appendChild(toast);
        setTimeout(()=>{ toast.remove(); }, 1100);
        setTimeout(()=>{ remCardEl.classList.remove('flipped'); renderReminder(); }, 850);
      }
    }, {passive:true});
  }
  scheduleByReminder();
})();


// Dose hint: "–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º: {N} –º–≥ ‚Ä¢ –°–µ–≥–æ–¥–Ω—è: {X} –º–≥"
function updateDoseHint(){
  try{
    const hint = document.getElementById('doseHint'); if (!hint) return;
    let last = 0, today = 0;
    const todayIso = (function(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); })();
    if (Array.isArray(DOSES) && DOSES.length){
      last = Number(DOSES[0]?.mg || DOSES[0]?.mg_taken || 0) || 0;
      for(const x of DOSES){
        const iso = String(x.date||'').slice(0,10);
        if (iso === todayIso) today += Number(x.mg||x.mg_taken||0) || 0;
      }
    }
    hint.textContent = `–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º: ${fmtInt(last)} –º–≥ ‚Ä¢ –°–µ–≥–æ–¥–Ω—è: ${fmtInt(today)} –º–≥`;
  }catch(_){}
}

// Stepper (+/- 10 –º–≥)
(function wireStepper(){
  const minus = document.getElementById('mgMinus');
  const plus  = document.getElementById('mgPlus');
  const input = document.getElementById('mg');
  if (!input) return;
  const STEP = 10;
  function clamp(v){ v = Math.round(v/STEP)*STEP; if (v<0) v=0; if (v>1000) v=1000; return v; }
  minus?.addEventListener('click', ()=>{ input.value = clamp((Number(input.value)||0) - STEP); updateDoseHint(); });
  plus?.addEventListener('click',  ()=>{ input.value = clamp((Number(input.value)||0) + STEP); updateDoseHint(); });
  input?.addEventListener('input', ()=>{ updateDoseHint(); });
})();


(function hookOpenCalendar(){
  const btn = document.getElementById('openCalendarBtn');
  if(!btn) return;
  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    try{ if(typeof go==='function'){ go('/calendar'); return; } }catch(_){}
    location.assign('/calendar');
  });
})();


// --- Pill burst animation on Add button ---
(function setupPillBurst(){
  const btn = document.getElementById('save');
  if(!btn) return;
  function burst(x,y){
    const rect = btn.getBoundingClientRect();
    const cx = x ? (x - rect.left) : rect.width/2;
    const cy = y ? (y - rect.top)  : rect.height/2;
    // Pill emoji
    const pill = document.createElement('span');
    pill.className = 'fx-pill';
    pill.textContent = 'üíä';
    pill.style.left = cx + 'px';
    pill.style.top  = cy + 'px';
    btn.appendChild(pill);
    setTimeout(()=>pill.remove(), 900);

    // Particles
    const colors = ['#22D3EE','#14B8A6','#5EEAD4','#FDE047','#A7F3D0','#93C5FD'];
    const N = 10;
    for(let i=0;i<N;i++){
      const dot = document.createElement('span');
      dot.className = 'fx-dot';
      dot.style.left = cx + 'px';
      dot.style.top  = cy + 'px';
      const angle = (Math.PI*2) * (i/N) + (Math.random()*0.6 - 0.3);
      const r = 22 + Math.random()*16;
      dot.style.setProperty('--dx',  Math.cos(angle)*r + 'px');
      dot.style.setProperty('--dy',  Math.sin(angle)*r + 'px');
      dot.style.width = dot.style.height = (4 + Math.random()*4) + 'px';
      dot.style.background = colors[i % colors.length];
      btn.appendChild(dot);
      setTimeout(()=>dot.remove(), 800);
    }
  }
  btn.addEventListener('click', (e)=>{
    try{ burst(e.clientX, e.clientY); }catch(_){ burst(); }
  });
  btn.addEventListener('touchstart', (e)=>{
    try{ const t = e.touches[0]; if(t) burst(t.clientX, t.clientY); }catch(_){ burst(); }
  }, {passive:true});
})();

document.addEventListener('DOMContentLoaded', ()=>{
  document.body.classList.add('page-enter');
  document.body.addEventListener('animationend', e=>{
    if(e.animationName==='pageIn') document.body.classList.remove('page-enter');
  }, {once:true});
});

</script>

<script>
// Match myprofile cross-page animation for links with data-vt-link
document.addEventListener('click', (e)=>{
  const a = e.target.closest('a[data-vt-link]');
  if(!a) return;
  if(e.metaKey||e.ctrlKey||e.shiftKey||e.altKey||a.target==='_blank') return;
  e.preventDefault();
  const go = ()=>{ window.location.href = a.getAttribute('href'); };
  if (document.startViewTransition) {
    document.startViewTransition(go);
  } else {
    go();
  }
});
</script>
<script>
(function hookOpenCalendar(){
  const btn = document.getElementById('openCalendarBtn');
  if(!btn) return;
  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    try{ if(typeof go==='function'){ go('/calendar'); return; } }catch(_){}
    location.assign('/calendar');
  });
})();
</script>
<script>
(function setupPillBurst(){
  const btn = document.getElementById('save');
  if(!btn) return;
  function burst(x,y){
    const rect = btn.getBoundingClientRect();
    const cx = x ? (x - rect.left) : rect.width/2;
    const cy = y ? (y - rect.top)  : rect.height/2;
    const pill = document.createElement('span');
    pill.className = 'fx-pill'; pill.textContent = 'üíä';
    pill.style.left = cx + 'px'; pill.style.top = cy + 'px';
    btn.appendChild(pill); setTimeout(()=>pill.remove(), 900);

    const colors = ['#22D3EE','#14B8A6','#5EEAD4','#FDE047','#A7F3D0','#93C5FD'];
    for(let i=0;i<10;i++){
      const dot = document.createElement('span');
      dot.className = 'fx-dot';
      dot.style.left = cx + 'px'; dot.style.top = cy + 'px';
      const angle = (Math.PI*2)*(i/10) + (Math.random()*0.6 - 0.3);
      const r = 22 + Math.random()*16;
      dot.style.setProperty('--dx',  Math.cos(angle)*r + 'px');
      dot.style.setProperty('--dy',  Math.sin(angle)*r + 'px');
      dot.style.width = dot.style.height = (4 + Math.random()*4) + 'px';
      dot.style.background = colors[i % colors.length];
      btn.appendChild(dot); setTimeout(()=>dot.remove(), 800);
    }
  }
  btn.addEventListener('click', (e)=>{ try{ burst(e.clientX, e.clientY); }catch(_){ burst(); }});
  btn.addEventListener('touchstart', (e)=>{ try{ const t=e.touches[0]; if(t) burst(t.clientX,t.clientY); }catch(_){ burst(); } }, {passive:true});
})();
</script>

<script>
(function(){
  const header = document.getElementById('profileHeader');
  if(!header) return;

  header.addEventListener('click', () => {
    // 1) –≥–µ–æ–º–µ—Ç—Ä–∏—è ¬´–≥–µ—Ä–æ—è¬ª
    const av = header.querySelector('[data-shared="avatar"]');
    if (av) {
      const r = av.getBoundingClientRect();
      const img = av.querySelector('img');
      const txt = (av.querySelector('span')?.textContent || '').trim().slice(0,1).toUpperCase();
      sessionStorage.setItem('share:avatar', JSON.stringify({
        x: r.left, y: r.top + window.scrollY, w: r.width, h: r.height,
        br: getComputedStyle(av).borderRadius,
        src: img?.currentSrc || img?.src || '',
        text: txt, bg: getComputedStyle(av).backgroundColor,
        ts: Date.now()
      }));
    }

    // 2) –°–ù–ê–ü–®–û–¢ –î–ê–ù–ù–´–• –î–õ–Ø myprofile (—Ñ–æ–ª–±—ç–∫, –∫–æ–≥–¥–∞ –Ω–µ—Ç API)
    const snap = {
      name: (document.getElementById('profileName')?.textContent || '').trim()  // ‚Üê –≤–∞—à —Å–µ–ª–µ–∫—Ç–æ—Ä –∏–º–µ–Ω–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
            || (window.USER_NAME || ''),
      avatarSrc: header.querySelector('[data-shared="avatar"] img')?.currentSrc
                 || header.querySelector('[data-shared="avatar"] img')?.src || '',
      weightKg:  Number(window.PROFILE_WEIGHT_KG || localStorage.getItem('rt_weightKG') || 0),
      goalMgPerKg: Number(window.PROFILE_TARGET_MGKG || localStorage.getItem('rt_goalMgKg') || 135),
      takenMg:  Number(window.PROFILE_TAKEN_MG || localStorage.getItem('rt_takenMg') || 0),
      todayMg:  Number(window.PROFILE_TODAY_MG || localStorage.getItem('rt_todayMg') || 0),
      drug:     String(window.PROFILE_DRUG || localStorage.getItem('rt_drug') || '–ò–∑–æ—Ç—Ä–µ—Ç–∏–Ω–æ–∏–Ω'),
      startISO: String(window.PROFILE_START_ISO || localStorage.getItem('rt_startISO') || '')
    };
    sessionStorage.setItem('share:user', JSON.stringify(snap));

    // 3) –Ω–∞–≤–∏–≥–∞—Ü–∏—è
    location.href = 'myprofile.html#fx=avatar';
  });
})();
</script>


</body>
</html>
