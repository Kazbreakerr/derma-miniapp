<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Врач — Roaccutane Tracker</title>
  <style>
    :root{
      /* База (dark) */
      --dr-bg: #0E1116;
      --dr-card: #141A22;
      --dr-text: #EDEFF2;
      --dr-text-muted: #9AA3AE;
      --dr-stroke: #1F2833;
      --dr-ok: #34D399;
      --dr-warn: #F59E0B;
      --dr-err: #EF4444;
      --dr-blue: #60A5FA;

      /* Градиенты мята → пастельно-розовый */
      --dr-grad-1: linear-gradient(135deg, #6FEAD8 0%, #BDF7EE 40%, #FFD6E9 100%);
      --dr-grad-2: linear-gradient(135deg, rgba(111,234,216,.18) 0%, rgba(255,214,233,.18) 100%);

      --dr-r: 18px;
      --dr-pad: 16px;
      --dr-gap: 12px;
      --dr-ease: cubic-bezier(.2,.6,.2,1);
      --dr-dur: .24s;
    }
    [data-theme="light"]{
      --dr-bg: #F7F8FA;
      --dr-card: #FFFFFF;
      --dr-text: #0F1720;
      --dr-text-muted: #6B7280;
      --dr-stroke: #E7EAF0;
      --dr-grad-1: linear-gradient(135deg, #CFF9F0 0%, #FFE6F2 100%);
      --dr-grad-2: linear-gradient(135deg, #EFFFF9 0%, #FFF1F6 100%);
    }

    html,body{height:100%}
    body{ margin:0; background:var(--dr-bg); color:var(--dr-text);
      font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }

    .dr-wrap{ max-width: 980px; margin: 0 auto; padding: 16px clamp(12px,4vw,24px) 90px; }

    /* Header */
    .dr-top{ display:flex; justify-content:space-between; align-items:center; margin:8px 0 16px; }
    .dr-h1{ font-weight:800; font-size: clamp(18px,2.8vw,24px); letter-spacing:.2px; }
    .dr-code-pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px;
      background: #0D1219; border:1px solid var(--dr-stroke); color:var(--dr-text-muted); font-size:12px; }
    .dr-code-pill b{ letter-spacing:1.2px; color:var(--dr-text); }

    /* Tabs nav (top) */
    .dr-tabs{ display:flex; gap:8px; align-items:center; border-bottom: 1px solid var(--dr-stroke); padding-bottom:8px; position:sticky; top:0; background: var(--dr-bg); z-index:10;}
    .dr-tab{
      padding:10px 14px; border-radius:999px; cursor:pointer; border:1px solid transparent; color:var(--dr-text);
    }
    .dr-tab.active{ background: var(--dr-grad-1); color:#0b1511; font-weight:700; }
    .dr-tab:hover{ border-color: var(--dr-stroke); }

    /* Search + filters */
    .dr-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:14px 0; }
    .dr-search{ flex:1 1 320px; min-width: 220px; display:flex; }
    .dr-input{
      width:100%; padding: 12px 12px; border-radius: 12px; background:#0D1219; border:1px solid var(--dr-stroke); color:var(--dr-text);
    }
    [data-theme="light"] .dr-input{ background:#FAFBFC; }
    .dr-chip{
      border:1px solid var(--dr-stroke); border-radius: 999px; padding:8px 12px; cursor:pointer; color:var(--dr-text); background:transparent; font-size:14px;
    }
    .dr-chip.active{ background: var(--dr-grad-1); color:#0b1511; font-weight:700; border-color:transparent; }
    .dr-select{ padding:8px 10px; border-radius:999px; border:1px solid var(--dr-stroke); background:#0D1219; color:var(--dr-text); }
    [data-theme="light"] .dr-select{ background:#FAFBFC; }

    /* Cards */
    .dr-card{ background: var(--dr-card); border:1px solid var(--dr-stroke); border-radius: var(--dr-r); padding:14px; box-shadow: 0 6px 22px rgba(0,0,0,.14); }
    .dr-list{ display:grid; gap:10px; }
    .dr-empty{ text-align:center; padding:48px 16px; border:1px dashed var(--dr-stroke); border-radius: var(--dr-r); color:var(--dr-text-muted); }
    .dr-empty .dr-btn{ margin-top:12px; }

    /* Patient card */
    .p-card{ position:relative; overflow:hidden; }
    .p-top{ display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .p-name{ font-weight:800; font-size:16px; }
    .p-meta{ color:var(--dr-text-muted); font-size:13px; }
    .p-grid{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; margin-top:8px; }
    .p-badges{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .badge{ padding:6px 8px; border-radius:999px; font-size:12px; background:#0D1219; border:1px solid var(--dr-stroke); }
    [data-theme="light"] .badge{ background:#FAFBFC; }
    .prog{ height:8px; background:#0D1219; border:1px solid var(--dr-stroke); border-radius:999px; overflow:hidden; }
    .prog > i{ display:block; height:100%; width:0; background: var(--dr-grad-1); }
    .labs{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-size:12px; }
    .lab{ display:inline-flex; align-items:center; gap:6px; }
    .dot{ width:10px; height:10px; border-radius:999px; }
    .dot.g{ background:#22C55E; } .dot.y{ background:#F59E0B; } .dot.r{ background:#EF4444; }
    .icons{ display:flex; gap:10px; align-items:center; color:var(--dr-text-muted); }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--dr-stroke); border-radius:999px; font-size:12px; }
    .p-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .dr-btn{
      padding: 10px 12px; border-radius: 12px; border:1px solid transparent; cursor:pointer; font-weight:700;
      color:#05140C; background: var(--dr-grad-1); transition: transform var(--dr-dur) var(--dr-ease);
    }
    .dr-btn:active{ transform: translateY(1px) scale(.99); }
    .dr-btn-ghost{ padding:10px 12px; border-radius:12px; background:transparent; color:var(--dr-text); border:1px solid var(--dr-stroke); cursor:pointer; }

    /* Swipe actions (simple) */
    .swipe{ position:relative; }
    .swipe-track{ position:relative; }
    .swipe-actions{ position:absolute; inset:0 0 0 auto; width:260px; display:flex; gap:8px; align-items:center; justify-content:center;
      background: #111922; border-left:1px solid var(--dr-stroke); }
    .swipe-actions .dr-btn{ padding:10px 10px; }

    /* Orders (inner tabs) */
    .inner-tabs{ display:flex; gap:8px; margin:12px 0; border-bottom:1px solid var(--dr-stroke); padding-bottom:8px; }
    .inner-tab{ padding:8px 12px; border-radius:999px; cursor:pointer; }
    .inner-tab.active{ background: var(--dr-grad-1); color:#0b1511; font-weight:700; }
    .preset-list{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
    .preset{ padding:12px; border:1px solid var(--dr-stroke); border-radius:14px; background:#0D1219; }
    [data-theme="light"] .preset{ background:#FAFBFC; }
    .preset b{ display:block; margin-bottom:6px; }
    .preset .dr-btn{ margin-top:10px; width:100%; }

    .history{ margin-top:16px; }
    .history h4{ margin:0 0 8px; }
    .history .row{ display:flex; justify-content:space-between; padding:8px 10px; border:1px solid var(--dr-stroke); border-radius:12px; margin-bottom:8px; background:#0D1219; }
    [data-theme="light"] .history .row{ background:#FAFBFC; }

    /* Requests */
    .req-row{ display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; }
    .req-actions{ display:flex; gap:8px; }
    .chip{ border:1px solid var(--dr-stroke); border-radius:999px; padding:8px 12px; }
    .chip.grad{ background: var(--dr-grad-1); color:#0b1511; font-weight:700; border-color:transparent; }

    /* Patient details modal */
    .modal{ position:fixed; inset:0; display:none; align-items:flex-end; justify-content:center; background:rgba(0,0,0,.45); z-index:50; }
    .modal.show{ display:flex; }
    .sheet{ width:min(980px,96vw); max-height:92vh; overflow:auto; border-radius:20px 20px 12px 12px; background:var(--dr-card); border:1px solid var(--dr-stroke);
      padding:16px; transform: translateY(12px); opacity:0; transition: all var(--dr-dur) var(--dr-ease); }
    .modal.show .sheet{ transform: translateY(0); opacity:1; }
    .sheet h3{ margin:0 0 8px; }
    .meta{ color:var(--dr-text-muted); font-size:13px; }
    .kv{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin:10px 0; }
    @media (max-width:640px){ .kv{ grid-template-columns: 1fr; } }
    .kv .cell{ background:#0D1219; border:1px solid var(--dr-stroke); border-radius:12px; padding:10px; }
    [data-theme="light"] .kv .cell{ background:#FAFBFC; }

    /* Profile screen */
    .stat{ display:grid; gap:10px; grid-template-columns: repeat(4,1fr); }
    @media (max-width:800px){ .stat{ grid-template-columns: repeat(2,1fr);} }

    /* Toggle (re-use from onboarding) */
    .dr-switch{ display:inline-flex; align-items:center; gap:10px; cursor:pointer; user-select:none; }
    .dr-switch input{ display:none; }
    .dr-toggle{ width:44px; height:26px; border-radius:999px; background:#2A3442; position:relative;
      transition:all var(--dr-dur) var(--dr-ease); border:1px solid rgba(255,255,255,.06); }
    .dr-knob{ position:absolute; top:3px; left:3px; width:20px; height:20px; border-radius:999px; background:#FFFFFF; transition:all var(--dr-dur) var(--dr-ease);
      box-shadow: 0 2px 6px rgba(0,0,0,.25); }
    .dr-switch input:checked + .dr-toggle{ background: var(--dr-grad-1); border-color: transparent; box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset; }
    .dr-switch input:checked + .dr-toggle .dr-knob{ transform: translateX(18px);
      box-shadow: 0 2px 6px rgba(0,0,0,.25), 0 0 0 3px rgba(255,214,233,.28); }

    /* Transitions for tab pages */
    .tabpage{ position:relative; }
    .tab-sec{ position:absolute; inset:0; opacity:0; transform: translateX(8px); pointer-events:none; transition: opacity var(--dr-dur) var(--dr-ease), transform var(--dr-dur) var(--dr-ease); }
    .tab-sec.active{ opacity:1; transform: translateX(0); pointer-events:auto; }
  </style>
</head>
<body>
  <div class="dr-wrap">
    <div class="dr-top">
      <div class="dr-h1">Кабинет врача</div>
      <div class="dr-code-pill">Ваш код: <b id="topCode">— — — — —</b></div>
    </div>

    <nav class="dr-tabs">
      <div class="dr-tab active" data-tab="patients">Пациенты</div>
      <div class="dr-tab" data-tab="requests">Заявки</div>
      <div class="dr-tab" data-tab="orders">Назначения</div>
      <div class="dr-tab" data-tab="profile">Профиль</div>
    </nav>

    <main class="tabpage" style="min-height:60vh;">
      <!-- PATIENTS -->
      <section class="tab-sec active" id="tab-patients">
        <div class="dr-row">
          <div class="dr-search"><input id="search" class="dr-input" placeholder="Поиск: ФИО, @ник или код"></div>
          <button class="dr-chip" data-filter="status" data-value="all">Все статусы</button>
          <button class="dr-chip" data-filter="status" data-value="on">На курсе</button>
          <button class="dr-chip" data-filter="status" data-value="off">Не на курсе</button>
          <button class="dr-chip" data-filter="red" data-value="true">Есть красные анализы</button>
          <select id="daysNoReport" class="dr-select" title="Без отчёта > N дней">
            <option value="0">Без отчёта: —</option>
            <option value="7">Без отчёта &gt; 7 дн</option>
            <option value="14">Без отчёта &gt; 14 дн</option>
            <option value="30">Без отчёта &gt; 30 дн</option>
          </select>
          <button id="resetFilters" class="dr-chip">Сброс</button>
        </div>

        <div id="patientsList" class="dr-list"></div>
        <div id="patientsEmpty" class="dr-empty" style="display:none">
          Поделитесь кодом <b id="emptyCode">AB12C</b> — новые пациенты появятся здесь.
          <div>
            <button class="dr-btn-ghost" id="showQR">Показать QR</button>
          </div>
        </div>
      </section>

      <!-- REQUESTS -->
      <section class="tab-sec" id="tab-requests">
        <div class="dr-row">
          <label class="dr-switch">
            <input type="checkbox" id="autoAccept">
            <span class="dr-toggle"><span class="dr-knob"></span></span>
            <span>Автопринятие</span>
          </label>
        </div>
        <div id="requestsList" class="dr-list"></div>
        <div id="requestsEmpty" class="dr-empty" style="display:none">Пока нет заявок</div>
      </section>

      <!-- ORDERS -->
      <section class="tab-sec" id="tab-orders">
        <div class="inner-tabs">
          <div class="inner-tab active" data-in="analyses">Анализы</div>
          <div class="inner-tab" data-in="reco">Рекомендации</div>
        </div>
        <div id="orders-analyses">
          <div class="preset-list">
            <div class="preset">
              <b>Старт</b>
              ALT, AST, Триглицериды, Холестерин общий, (hCG при необходимости)
              <button class="dr-btn" data-preset="start">Отправить пациенту</button>
            </div>
            <div class="preset">
              <b>4-я неделя</b>
              ALT, AST, Триглицериды, Холестерин общий
              <button class="dr-btn" data-preset="week4">Отправить пациенту</button>
            </div>
            <div class="preset">
              <b>Контроль липидов</b>
              Триглицериды, Холестерин общий
              <button class="dr-btn" data-preset="lipids">Отправить пациенту</button>
            </div>
            <div class="preset">
              <b>hCG (для женщин)</b>
              hCG (качественный) + дата
              <button class="dr-btn" data-preset="hcg">Отправить пациенту</button>
            </div>
          </div>
          <div class="history">
            <h4>Последние отправки</h4>
            <div id="ordersHistory"></div>
          </div>
        </div>

        <div id="orders-reco" style="display:none">
          <div class="preset-list">
            <div class="preset">
              <b>Коррекция дозы</b>
              Рекомендую скорректировать дозу согласно переносимости и анализам.
              <button class="dr-btn" data-reco="dose">Отправить пациенту</button>
            </div>
            <div class="preset">
              <b>Контрацепция</b>
              Напоминаю о необходимости надёжной контрацепции на курсе.
              <button class="dr-btn" data-reco="contraception">Отправить пациенту</button>
            </div>
            <div class="preset">
              <b>Избегать витамина A</b>
              Пожалуйста, исключите витамин A и ретиноиды в добавках.
              <button class="dr-btn" data-reco="vitA">Отправить пациенту</button>
            </div>
            <div class="preset">
              <b>Контроль алкоголя</b>
              Рекомендация ограничить алкоголь на курсе.
              <button class="dr-btn" data-reco="alcohol">Отправить пациенту</button>
            </div>
          </div>
          <div class="history">
            <h4>Последние рекомендации</h4>
            <div id="recoHistory"></div>
          </div>
        </div>
      </section>

      <!-- PROFILE -->
      <section class="tab-sec" id="tab-profile">
        <div class="dr-card" style="margin-top:10px">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <div>
              <div style="font-weight:800; font-size:18px;" id="profName">ФИО врача</div>
              <div class="meta" id="profMeta">Специализация • Клиника, Город</div>
            </div>
            <div>
              <div class="dr-code-pill">Мой код: <b id="profCode">— — — — —</b></div>
            </div>
          </div>
          <div class="dr-row" style="margin-top:12px">
            <button class="dr-btn-ghost" id="copyCode">Скопировать</button>
            <button class="dr-btn-ghost" id="qrCode">QR</button>
            <button class="dr-btn-ghost" id="shareCode">Поделиться</button>
            <label class="dr-switch" style="margin-left:auto">
              <input type="checkbox" id="autoAcceptProfile">
              <span class="dr-toggle"><span class="dr-knob"></span></span>
              <span>Автопринятие</span>
            </label>
          </div>
        </div>
        <div class="dr-card" style="margin-top:12px">
          <div class="stat">
            <div class="kv cell"><div><b>Всего пациентов</b><div id="stTotal" style="font-size:22px; font-weight:800; margin-top:6px;">0</div></div></div>
            <div class="kv cell"><div><b>На курсе</b><div id="stOn" style="font-size:22px; font-weight:800; margin-top:6px;">0</div></div></div>
            <div class="kv cell"><div><b>Просрочены анализы</b><div id="stRed" style="font-size:22px; font-weight:800; margin-top:6px;">0</div></div></div>
            <div class="kv cell"><div><b>Нужен ответ</b><div id="stNeeds" style="font-size:22px; font-weight:800; margin-top:6px;">0</div></div></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Patient details modal -->
  <div class="modal" id="patientModal" aria-hidden="true">
    <div class="sheet">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h3 id="ptTitle">Пациент</h3>
        <button class="dr-btn-ghost" id="ptClose">Закрыть</button>
      </div>
      <div id="ptMeta" class="meta"></div>

      <div class="kv" style="margin-top:12px">
        <div class="cell">
          <b>Курс</b>
          <div id="ptCourse" class="meta"></div>
          <div class="prog" style="margin-top:8px"><i id="ptProg"></i></div>
        </div>
        <div class="cell">
          <b>Риски</b>
          <div id="ptRisks" class="meta"></div>
        </div>
      </div>

      <div class="kv">
        <div class="cell">
          <b>Анализы</b>
          <div id="ptLabs" class="meta"></div>
        </div>
        <div class="cell">
          <b>Отчёты и фото</b>
          <div id="ptReports" class="meta"></div>
        </div>
      </div>

      <div class="p-actions" style="margin-top:8px">
        <button class="dr-btn" id="ptOrder">Назначить анализы</button>
        <button class="dr-btn" id="ptReco">Оставить рекомендацию</button>
        <button class="dr-btn-ghost" id="ptPhoto">Запросить фото</button>
        <button class="dr-btn-ghost" id="ptFinish">Завершить курс</button>
      </div>

      <div style="margin-top:12px; text-align:right">
        <button class="dr-btn-ghost" id="ptDetach">Открепить пациента</button>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div class="modal" id="qrModal" aria-hidden="true">
    <div class="sheet" style="max-width:420px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>QR для пациента</h3>
        <button class="dr-btn-ghost" id="qrClose">Закрыть</button>
      </div>
      <div id="qrBox" style="display:grid;place-items:center;"></div>
      <div class="meta" style="margin-top:8px">Содержимое: ссылка с вашим кодом.</div>
    </div>
  </div>

  <script>
    // Utils and storage
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const storage = { set:(k,v)=>localStorage.setItem(k, JSON.stringify(v)), get:(k,d=null)=>JSON.parse(localStorage.getItem(k)||'null') ?? d };

    const fmtDate = iso => {
      if(!iso) return '—';
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    };

    const daysBetween = (iso)=>{
      if(!iso) return Infinity;
      const d = new Date(iso);
      const now = new Date();
      return Math.floor((now - d)/86400000);
    };

    const shareURL = (code)=> `${location.origin}${location.pathname}?attach=doctor&code=${code}`;

    // Sample data (can be replaced with API)
    const samplePatients = [
      {
        id: 'p1', name:'Мария Петрова', age:24, city:'Москва', handle:'@m_pet',
        course:{ start:'2025-06-09', dose_mg:20, progress:34, onCourse:true, target_mgkg:140 },
        labs:{ date:'2025-08-14', ALT:{val:22, status:'g'}, AST:{val:19, status:'g'}, TG:{val:1.9, status:'y'}, CHOL:{val:5.4, status:'y'} },
        lastReport:'2025-08-20', newMsgs:2, red:false,
        risks:['печень: нет','липиды: пов.','психика: нет','алк.: редко','медикаменты: нет']
      },
      {
        id:'p2', name:'Алексей Смирнов', age:28, city:'СПб', handle:'@sm_al',
        course:{ start:'2025-05-18', dose_mg:30, progress:72, onCourse:true, target_mgkg:140 },
        labs:{ date:'2025-08-10', ALT:{val:48, status:'y'}, AST:{val:44, status:'y'}, TG:{val:3.2, status:'r'}, CHOL:{val:6.1, status:'r'} },
        lastReport:'2025-08-02', newMsgs:0, red:true,
        risks:['печень: нет','липиды: да','психика: нет','алк.: иногда','мед.: витA?']
      },
      {
        id:'p3', name:'Анна Ким', age:22, city:'Казань', handle:'@anna_k',
        course:{ start:null, dose_mg:0, progress:0, onCourse:false, target_mgkg:0 },
        labs:{ date:null, ALT:{val:null, status:'g'}, AST:{val:null, status:'g'}, TG:{val:null, status:'g'}, CHOL:{val:null, status:'g'} },
        lastReport:null, newMsgs:1, red:false,
        risks:['печень: нет','липиды: нет','психика: нет','алк.: редко','мед.: нет']
      }
    ];

    const sampleRequests = [
      { id:'r1', name:'Ирина Л.', age:26, city:'Москва', course:'20 мг/сут, старт 05.08', date:'2025-08-21' },
      { id:'r2', name:'Дмитрий Ф.', age:31, city:'Воронеж', course:null, date:'2025-08-22' }
    ];

    // State
    let state = {
      patients: storage.get('patientsList', samplePatients),
      requests: storage.get('patientsRequests', sampleRequests),
      filters: { q:'', status:'all', red:false, days:0 }
    };

    // Code at top and placeholders
    function initHeader(){
      const code = storage.get('doctorCode') || 'AB12C';
      $('#topCode').textContent = code;
      $('#emptyCode').textContent = code;
      $('#profCode').textContent = code;
    }

    // Tabs Nav
    function setTab(tab){
      $$('.dr-tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===tab));
      ['patients','requests','orders','profile'].forEach(id=> $('#tab-'+id).classList.toggle('active', id===tab));
      // hash
      location.hash = '#/doctor/'+tab;
      // inner defaults
      if(tab==='orders'){ setInner('analyses'); }
      renderAll();
    }

    $$('.dr-tab').forEach(t=> t.addEventListener('click', ()=> setTab(t.dataset.tab)));

    // Inner tabs for Orders
    function setInner(which){
      $$('.inner-tab').forEach(i=> i.classList.toggle('active', i.dataset.in===which));
      $('#orders-analyses').style.display = (which==='analyses')?'block':'none';
      $('#orders-reco').style.display = (which==='reco')?'block':'none';
    }
    $$('.inner-tab').forEach(i=> i.addEventListener('click', ()=> setInner(i.dataset.in)));

    // Render patients list with filters
    function matchesFilters(p){
      const q = state.filters.q.toLowerCase().trim();
      const inSearch = !q || [p.name, p.handle, p.id].some(x => (x||'').toLowerCase().includes(q));
      const stOk = state.filters.status==='all' ? true : (state.filters.status==='on' ? p.course.onCourse : !p.course.onCourse);
      const redOk = state.filters.red ? !!p.red || [p.labs?.ALT?.status,p.labs?.AST?.status,p.labs?.TG?.status,p.labs?.CHOL?.status].includes('r') : true;
      const daysOk = state.filters.days>0 ? daysBetween(p.lastReport) > state.filters.days : true;
      return inSearch && stOk && redOk && daysOk;
    }

    function renderPatients(){
      const list = $('#patientsList'); list.innerHTML='';
      const filtered = state.patients.filter(matchesFilters);
      if(filtered.length===0){
        $('#patientsEmpty').style.display = state.patients.length? 'block':'block';
      }else{
        $('#patientsEmpty').style.display = 'none';
      }
      filtered.forEach(p=> list.appendChild(patientCard(p)));
    }

    function patientCard(p){
      const el = document.createElement('div');
      el.className = 'dr-card p-card swipe';
      const lastDate = p.labs?.date ? fmtDate(p.labs.date) : '—';
      el.innerHTML = `
        <div class="swipe-track">
          <div class="p-top">
            <div>
              <div class="p-name">${p.name} <span class="p-meta">• ${p.age} • ${p.city}</span></div>
              <div class="p-meta">${p.handle||''}</div>
            </div>
            <div class="pill">${p.newMsgs?`Новых: ${p.newMsgs}`:'Нет новых'}</div>
          </div>
          <div class="p-grid">
            <div>
              <div class="p-badges">
                <span class="badge">Курс: ${p.course.start?fmtDate(p.course.start):'—'} • ${p.course.dose_mg||0} мг/сут</span>
                <span class="badge">Цель: ${p.course.target_mgkg||'-'} мг/кг</span>
                <span class="badge">Прогресс: ${p.course.progress||0}%</span>
              </div>
              <div class="prog" style="margin-top:8px"><i style="width:${p.course.progress||0}%"></i></div>
            </div>
            <div class="icons">
              <span title="Фото">📷</span>
              <span title="Отчёты">📝</span>
              <span title="Сообщения">💬</span>
            </div>
          </div>
          <div class="labs" style="margin-top:8px">
            <div class="lab"><span class="dot ${p.labs.ALT.status}"></span>ALT</div>
            <div class="lab"><span class="dot ${p.labs.AST.status}"></span>AST</div>
            <div class="lab"><span class="dot ${p.labs.TG.status}"></span>TG</div>
            <div class="lab"><span class="dot ${p.labs.CHOL.status}"></span>ХС</div>
            <span class="p-meta" style="margin-left:auto">от ${lastDate}</span>
          </div>
          <div class="p-actions" style="margin-top:10px">
            <button class="dr-btn-ghost" data-open="${p.id}">Открыть</button>
            <button class="dr-btn" data-order="${p.id}">Назначить анализы</button>
            <button class="dr-btn" data-reco="${p.id}">Оставить рекомендацию</button>
          </div>
        </div>
      `;
      // Actions
      el.querySelector('[data-open]').addEventListener('click', ()=> openPatient(p.id));
      el.querySelector('[data-order]').addEventListener('click', ()=> sendOrderTo([p.id], 'custom'));
      el.querySelector('[data-reco]').addEventListener('click', ()=> sendRecoTo([p.id], 'custom'));
      return el;
    }

    // Requests
    function renderRequests(){
      const list = $('#requestsList'); list.innerHTML='';
      const reqs = state.requests;
      $('#requestsEmpty').style.display = reqs.length? 'none':'block';
      reqs.forEach(r=>{
        const row = document.createElement('div');
        row.className='dr-card req-row';
        row.innerHTML = `
          <div>
            <div class="p-name">${r.name} <span class="p-meta">• ${r.age} • ${r.city}</span></div>
            <div class="p-meta">${r.course || 'Без курса'}</div>
            <div class="p-meta">Запрос: ${fmtDate(r.date)}</div>
          </div>
          <div class="req-actions">
            <button class="dr-btn" data-accept="${r.id}">Принять</button>
            <button class="dr-btn-ghost" data-decline="${r.id}">Отклонить</button>
          </div>
        `;
        row.querySelector('[data-accept]').addEventListener('click', ()=> acceptReq(r.id));
        row.querySelector('[data-decline]').addEventListener('click', ()=> declineReq(r.id));
        list.appendChild(row);
      });
    }

    function acceptReq(id){
      const idx = state.requests.findIndex(x=>x.id===id);
      if(idx>-1){
        const r = state.requests.splice(idx,1)[0];
        // create simple patient entity
        const newP = {
          id:'p'+Math.random().toString(36).slice(2,6).toUpperCase(),
          name:r.name, age:r.age, city:r.city, handle:'', newMsgs:0, red:false,
          course:{ start:null, dose_mg:0, progress:0, onCourse:false, target_mgkg:0 },
          labs:{ date:null, ALT:{status:'g'}, AST:{status:'g'}, TG:{status:'g'}, CHOL:{status:'g'} },
          lastReport:null,
          risks:['печень: —','липиды: —','психика: —']
        };
        state.patients.unshift(newP);
        persist();
        renderAll();
        toast('Пациент принят');
      }
    }
    function declineReq(id){
      const idx = state.requests.findIndex(x=>x.id===id);
      if(idx>-1){ state.requests.splice(idx,1); persist(); renderAll(); toast('Заявка отклонена'); }
    }

    // Orders: presets
    const presetMap = {
      start: ['ALT','AST','TG','ХС','hCG*'],
      week4: ['ALT','AST','TG','ХС'],
      lipids:['TG','ХС'],
      hcg:['hCG']
    };

    function choosePatients(cb){
      // simple prompt-style selector (can be replaced with modal list)
      const names = state.patients.map((p,i)=> `${i+1}. ${p.name}`).join('\\n');
      const pick = prompt('Введите номера пациентов через запятую:\\n'+names);
      if(!pick) return;
      const ids = pick.split(',').map(s=>parseInt(s.trim(),10)-1).filter(i=>i>=0 && i<state.patients.length).map(i=>state.patients[i].id);
      if(ids.length) cb(ids);
    }

    function pushOrderHistory(text, ids){
      const hist = storage.get('ordersHistory', []);
      hist.unshift({ at:new Date().toISOString(), text, to: ids.map(id=> state.patients.find(p=>p.id===id)?.name || id), status:'ожидает' });
      storage.set('ordersHistory', hist);
      renderOrdersHistory();
      toast('Отправлено');
    }
    function renderOrdersHistory(){
      const box = $('#ordersHistory'); const hist = storage.get('ordersHistory', []);
      box.innerHTML = hist.length? '' : '<div class="meta">Пока пусто</div>';
      hist.slice(0,8).forEach(h=>{
        const row = document.createElement('div'); row.className='row';
        row.innerHTML = `<div>${fmtDate(h.at)} — ${h.text} → ${h.to.join(', ')}</div><div class="chip">${h.status}</div>`;
        box.appendChild(row);
      });
    }

    function sendOrderTo(ids, preset){
      const title = preset==='custom' ? 'Анализы (по выбору врача)' : `Назначение: ${preset}`;
      pushOrderHistory(title, ids);
    }

    $$('#orders-analyses .dr-btn').forEach(btn=> btn.addEventListener('click', e=>{
      const preset = e.target.dataset.preset;
      choosePatients(ids=> sendOrderTo(ids, preset));
    }));

    // Recommendations
    function pushRecoHistory(text, ids){
      const hist = storage.get('recoHistory', []);
      hist.unshift({ at:new Date().toISOString(), text, to: ids.map(id=> state.patients.find(p=>p.id===id)?.name || id) });
      storage.set('recoHistory', hist);
      renderRecoHistory();
      toast('Рекомендация отправлена');
    }
    function renderRecoHistory(){
      const box = $('#recoHistory'); const hist = storage.get('recoHistory', []);
      box.innerHTML = hist.length? '' : '<div class="meta">Пока пусто</div>';
      hist.slice(0,8).forEach(h=>{
        const row = document.createElement('div'); row.className='row';
        row.innerHTML = `<div>${fmtDate(h.at)} — ${h.text} → ${h.to.join(', ')}</div>`;
        box.appendChild(row);
      });
    }
    $$('#orders-reco .dr-btn').forEach(btn=> btn.addEventListener('click', e=>{
      const kind = e.target.dataset.reco;
      const texts = {
        dose: 'Коррекция дозы',
        contraception: 'Напоминание о контрацепции',
        vitA: 'Исключение витамина A',
        alcohol: 'Ограничение алкоголя'
      };
      const base = texts[kind] || 'Рекомендация';
      const txt = prompt('Текст рекомендации (можно отредактировать):', base);
      if(!txt) return;
      choosePatients(ids=> pushRecoHistory(txt, ids));
    }));

    // Patient details
    function openPatient(id){
      const p = state.patients.find(x=>x.id===id); if(!p) return;
      $('#ptTitle').textContent = p.name + ' • ' + p.age + ' • ' + p.city;
      $('#ptMeta').textContent = p.handle || '';
      $('#ptCourse').textContent = `Старт: ${p.course.start?fmtDate(p.course.start):'—'} • Доза: ${p.course.dose_mg||0} мг/сут • Цель: ${p.course.target_mgkg||'-'} мг/кг • Выполнено: ${p.course.progress||0}%`;
      $('#ptProg').style.width = (p.course.progress||0)+'%';
      $('#ptRisks').textContent = p.risks.join(' • ');
      const lastDate = p.labs?.date ? fmtDate(p.labs.date) : '—';
      $('#ptLabs').textContent = `ALT ${p.labs.ALT.val??'—'} • AST ${p.labs.AST.val??'—'} • TG ${p.labs.TG.val??'—'} • ХС ${p.labs.CHOL.val??'—'} — от ${lastDate}`;
      $('#ptReports').textContent = p.lastReport? ('Последний отчёт: '+ fmtDate(p.lastReport)) : 'Ещё нет отчётов.';
      $('#patientModal').classList.add('show'); $('#patientModal').setAttribute('aria-hidden','false');
      // attach actions
      $('#ptOrder').onclick = ()=> sendOrderTo([id], 'custom');
      $('#ptReco').onclick = ()=> {
        const txt = prompt('Текст рекомендации:', 'Рекомендация');
        if(txt) pushRecoHistory(txt, [id]);
      };
      $('#ptPhoto').onclick = ()=> toast('Запрос фото отправлен');
      $('#ptFinish').onclick = ()=> toast('Курс помечен как завершён (UI-демо)');
      $('#ptDetach').onclick = ()=> {
        if(confirm('Открепить пациента?')){
          state.patients = state.patients.filter(x=>x.id!==id);
          persist(); renderAll(); $('#ptClose').click();
        }
      };
    }
    $('#ptClose').addEventListener('click', ()=> { $('#patientModal').classList.remove('show'); $('#patientModal').setAttribute('aria-hidden','true'); });

    // Profile screen
    function renderProfile(){
      const prof = storage.get('doctorProfile', {name:'Иванова Анастасия Сергеевна', specialty:'Дерматолог', clinic:'Медцентр «Скин+»', city:'Москва'});
      $('#profName').textContent = prof.name || 'ФИО врача';
      $('#profMeta').textContent = `${prof.specialty||'Специализация'} • ${prof.clinic||'Клиника'}, ${prof.city||'Город'}`;
      const settings = storage.get('doctorSettings', { autoAccept:false });
      $('#autoAccept').checked = !!settings.autoAccept;
      $('#autoAcceptProfile').checked = !!settings.autoAccept;
      $('#autoAccept').onchange = (e)=> { settings.autoAccept = e.target.checked; storage.set('doctorSettings', settings); $('#autoAcceptProfile').checked = settings.autoAccept; };
      $('#autoAcceptProfile').onchange = (e)=> { settings.autoAccept = e.target.checked; storage.set('doctorSettings', settings); $('#autoAccept').checked = settings.autoAccept; };
      // stats
      const total = state.patients.length;
      const on = state.patients.filter(p=>p.course.onCourse).length;
      const red = state.patients.filter(p=> p.red || [p.labs.ALT.status,p.labs.AST.status,p.labs.TG.status,p.labs.CHOL.status].includes('r')).length;
      const needs = state.patients.filter(p=> (p.newMsgs||0)>0).length;
      $('#stTotal').textContent = total;
      $('#stOn').textContent = on;
      $('#stRed').textContent = red;
      $('#stNeeds').textContent = needs;
    }

    // Search / filters
    $('#search').addEventListener('input', e=> { state.filters.q = e.target.value; renderPatients(); });
    $$('#tab-patients .dr-chip').forEach(chip=> chip.addEventListener('click', ()=>{
      const f = chip.dataset.filter, val = chip.dataset.value;
      if(f==='status'){ state.filters.status = val; $$('#tab-patients .dr-chip[data-filter="status"]').forEach(c=> c.classList.toggle('active', c===chip)); }
      if(f==='red'){ state.filters.red = !state.filters.red; chip.classList.toggle('active', state.filters.red); }
      renderPatients();
    }));
    $('#daysNoReport').addEventListener('change', e=> { state.filters.days = parseInt(e.target.value,10)||0; renderPatients(); });
    $('#resetFilters').addEventListener('click', ()=>{
      state.filters = { q:'', status:'all', red:false, days:0 };
      $('#search').value=''; $('#daysNoReport').value='0';
      $$('#tab-patients .dr-chip').forEach(c=> c.classList.remove('active'));
      renderPatients();
    });

    // QR buttons
    $('#showQR').addEventListener('click', openQR);
    $('#qrCode').addEventListener('click', openQR);
    function openQR(){
      const code = storage.get('doctorCode') || 'AB12C';
      const url = shareURL(code);
      const api = 'https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=' + encodeURIComponent(url);
      $('#qrBox').innerHTML = `<img alt="QR" src="${api}" decoding="async" loading="lazy">`;
      $('#qrModal').classList.add('show'); $('#qrModal').setAttribute('aria-hidden','false');
    }
    $('#qrClose').addEventListener('click', ()=> { $('#qrModal').classList.remove('show'); $('#qrModal').setAttribute('aria-hidden','true'); });

    // Profile copy/share
    $('#copyCode').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(storage.get('doctorCode') || 'AB12C'); toast('Код скопирован'); }catch(e){}
    });
    $('#shareCode').addEventListener('click', async ()=>{
      const code = storage.get('doctorCode') || 'AB12C';
      const url = shareURL(code);
      if(navigator.share){ try{ await navigator.share({ title:'Код врача', text:`Мой код: ${code}`, url }); }catch(e){} }
      else { try{ await navigator.clipboard.writeText(url); toast('Ссылка скопирована'); }catch(e){} }
    });

    // Persist state
    function persist(){
      storage.set('patientsList', state.patients);
      storage.set('patientsRequests', state.requests);
    }

    // Render helpers
    function renderAll(){
      renderPatients();
      renderRequests();
      renderOrdersHistory();
      renderRecoHistory();
      renderProfile();
    }

    // Toast
    function toast(txt){
      const n = document.createElement('div');
      n.textContent = txt;
      n.style.cssText = 'position:fixed;left:50%;bottom:28px;transform:translateX(-50%);padding:10px 14px;border-radius:12px;background:rgba(0,0,0,.7);color:#fff;font-weight:600;z-index:9999';
      document.body.appendChild(n);
      setTimeout(()=>n.remove(), 1400);
    }

    // Init
    initHeader();
    renderAll();

    // Router (hash) support
    function initRoute(){
      const h = location.hash.replace('#/doctor/','');
      const tabs = ['patients','requests','orders','profile'];
      if(tabs.includes(h)) setTab(h);
      else setTab('patients');
    }
    window.addEventListener('hashchange', initRoute);
    initRoute();
  </script>
</body>
</html>
