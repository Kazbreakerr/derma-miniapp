<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–í—Ä–∞—á ‚Äî Roaccutane Tracker</title>
  <style>
    :root{
      /* –ë–∞–∑–∞ (dark) */
      --dr-bg: #0E1116;
      --dr-card: #141A22;
      --dr-text: #EDEFF2;
      --dr-text-muted: #9AA3AE;
      --dr-stroke: #1F2833;
      --dr-ok: #34D399;
      --dr-warn: #F59E0B;
      --dr-err: #EF4444;
      --dr-blue: #60A5FA;

      /* –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã –º—è—Ç–∞ ‚Üí –ø–∞—Å—Ç–µ–ª—å–Ω–æ-—Ä–æ–∑–æ–≤—ã–π */
      --dr-grad-1: linear-gradient(135deg, #6FEAD8 0%, #BDF7EE 40%, #FFD6E9 100%);
      --dr-grad-2: linear-gradient(135deg, rgba(111,234,216,.18) 0%, rgba(255,214,233,.18) 100%);

      --dr-r: 18px;
      --dr-pad: 16px;
      --dr-gap: 12px;
      --dr-ease: cubic-bezier(.2,.6,.2,1);
      --dr-dur: .24s;
    }
    [data-theme="light"]{
      --dr-bg: #F7F8FA;
      --dr-card: #FFFFFF;
      --dr-text: #0F1720;
      --dr-text-muted: #6B7280;
      --dr-stroke: #E7EAF0;
      --dr-grad-1: linear-gradient(135deg, #CFF9F0 0%, #FFE6F2 100%);
      --dr-grad-2: linear-gradient(135deg, #EFFFF9 0%, #FFF1F6 100%);
    }

    html,body{height:100%}
    body{ margin:0; background:var(--dr-bg); color:var(--dr-text);
      font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }

    .dr-wrap{ max-width: 980px; margin: 0 auto; padding: 16px clamp(12px,4vw,24px) 90px; }

    /* Header */
    .dr-top{ display:flex; justify-content:space-between; align-items:center; margin:8px 0 16px; }
    .dr-h1{ font-weight:800; font-size: clamp(18px,2.8vw,24px); letter-spacing:.2px; }
    .dr-code-pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px;
      background: #0D1219; border:1px solid var(--dr-stroke); color:var(--dr-text-muted); font-size:12px; }
    .dr-code-pill b{ letter-spacing:1.2px; color:var(--dr-text); }

    /* Tabs nav (top) */
    .dr-tabs{ display:flex; gap:8px; align-items:center; border-bottom: 1px solid var(--dr-stroke); padding-bottom:8px; position:sticky; top:0; background: var(--dr-bg); z-index:10;}
    .dr-tab{
      padding:10px 14px; border-radius:999px; cursor:pointer; border:1px solid transparent; color:var(--dr-text);
    }
    .dr-tab.active{ background: var(--dr-grad-1); color:#0b1511; font-weight:700; }
    .dr-tab:hover{ border-color: var(--dr-stroke); }

    /* Search + filters */
    .dr-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:14px 0; }
    .dr-search{ flex:1 1 320px; min-width: 220px; display:flex; }
    .dr-input{
      width:100%; padding: 12px 12px; border-radius: 12px; background:#0D1219; border:1px solid var(--dr-stroke); color:var(--dr-text);
    }
    [data-theme="light"] .dr-input{ background:#FAFBFC; }
    .dr-chip{
      border:1px solid var(--dr-stroke); border-radius: 999px; padding:8px 12px; cursor:pointer; color:var(--dr-text); background:transparent; font-size:14px;
    }
    .dr-chip.active{ background: var(--dr-grad-1); color:#0b1511; font-weight:700; border-color:transparent; }
    .dr-select{ padding:8px 10px; border-radius:999px; border:1px solid var(--dr-stroke); background:#0D1219; color:var(--dr-text); }
    [data-theme="light"] .dr-select{ background:#FAFBFC; }

    /* Cards */
    .dr-card{ background: var(--dr-card); border:1px solid var(--dr-stroke); border-radius: var(--dr-r); padding:14px; box-shadow: 0 6px 22px rgba(0,0,0,.14); }
    .dr-list{ display:grid; gap:10px; }
    .dr-empty{ text-align:center; padding:48px 16px; border:1px dashed var(--dr-stroke); border-radius: var(--dr-r); color:var(--dr-text-muted); }
    .dr-empty .dr-btn{ margin-top:12px; }

    /* Patient card */
    .p-card{ position:relative; overflow:hidden; }
    .p-top{ display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .p-name{ font-weight:800; font-size:16px; }
    .p-meta{ color:var(--dr-text-muted); font-size:13px; }
    .p-grid{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; margin-top:8px; }
    .p-badges{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .badge{ padding:6px 8px; border-radius:999px; font-size:12px; background:#0D1219; border:1px solid var(--dr-stroke); }
    [data-theme="light"] .badge{ background:#FAFBFC; }
    .prog{ height:8px; background:#0D1219; border:1px solid var(--dr-stroke); border-radius:999px; overflow:hidden; }
    .prog > i{ display:block; height:100%; width:0; background: var(--dr-grad-1); }
    .labs{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-size:12px; }
    .lab{ display:inline-flex; align-items:center; gap:6px; }
    .dot{ width:10px; height:10px; border-radius:999px; }
    .dot.g{ background:#22C55E; } .dot.y{ background:#F59E0B; } .dot.r{ background:#EF4444; }
    .icons{ display:flex; gap:10px; align-items:center; color:var(--dr-text-muted); }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--dr-stroke); border-radius:999px; font-size:12px; }
    .p-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .dr-btn{
      padding: 10px 12px; border-radius: 12px; border:1px solid transparent; cursor:pointer; font-weight:700;
      color:#05140C; background: var(--dr-grad-1); transition: transform var(--dr-dur) var(--dr-ease);
    }
    .dr-btn:active{ transform: translateY(1px) scale(.99); }
    .dr-btn-ghost{ padding:10px 12px; border-radius:12px; background:transparent; color:var(--dr-text); border:1px solid var(--dr-stroke); cursor:pointer; }

    /* Swipe actions (simple) */
    .swipe{ position:relative; }
    .swipe-track{ position:relative; }
    .swipe-actions{ position:absolute; inset:0 0 0 auto; width:260px; display:flex; gap:8px; align-items:center; justify-content:center;
      background: #111922; border-left:1px solid var(--dr-stroke); }
    .swipe-actions .dr-btn{ padding:10px 10px; }

    /* Orders (inner tabs) */
    .inner-tabs{ display:flex; gap:8px; margin:12px 0; border-bottom:1px solid var(--dr-stroke); padding-bottom:8px; }
    .inner-tab{ padding:8px 12px; border-radius:999px; cursor:pointer; }
    .inner-tab.active{ background: var(--dr-grad-1); color:#0b1511; font-weight:700; }
    .preset-list{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
    .preset{ padding:12px; border:1px solid var(--dr-stroke); border-radius:14px; background:#0D1219; }
    [data-theme="light"] .preset{ background:#FAFBFC; }
    .preset b{ display:block; margin-bottom:6px; }
    .preset .dr-btn{ margin-top:10px; width:100%; }

    .history{ margin-top:16px; }
    .history h4{ margin:0 0 8px; }
    .history .row{ display:flex; justify-content:space-between; padding:8px 10px; border:1px solid var(--dr-stroke); border-radius:12px; margin-bottom:8px; background:#0D1219; }
    [data-theme="light"] .history .row{ background:#FAFBFC; }

    /* Requests */
    .req-row{ display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; }
    .req-actions{ display:flex; gap:8px; }
    .chip{ border:1px solid var(--dr-stroke); border-radius:999px; padding:8px 12px; }
    .chip.grad{ background: var(--dr-grad-1); color:#0b1511; font-weight:700; border-color:transparent; }

    /* Patient details modal */
    .modal{ position:fixed; inset:0; display:none; align-items:flex-end; justify-content:center; background:rgba(0,0,0,.45); z-index:50; }
    .modal.show{ display:flex; }
    .sheet{ width:min(980px,96vw); max-height:92vh; overflow:auto; border-radius:20px 20px 12px 12px; background:var(--dr-card); border:1px solid var(--dr-stroke);
      padding:16px; transform: translateY(12px); opacity:0; transition: all var(--dr-dur) var(--dr-ease); }
    .modal.show .sheet{ transform: translateY(0); opacity:1; }
    .sheet h3{ margin:0 0 8px; }
    .meta{ color:var(--dr-text-muted); font-size:13px; }
    .kv{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin:10px 0; }
    @media (max-width:640px){ .kv{ grid-template-columns: 1fr; } }
    .kv .cell{ background:#0D1219; border:1px solid var(--dr-stroke); border-radius:12px; padding:10px; }
    [data-theme="light"] .kv .cell{ background:#FAFBFC; }

    /* Profile screen */
    .stat{ display:grid; gap:10px; grid-template-columns: repeat(4,1fr); }
    @media (max-width:800px){ .stat{ grid-template-columns: repeat(2,1fr);} }

    /* Toggle (re-use from onboarding) */
    .dr-switch{ display:inline-flex; align-items:center; gap:10px; cursor:pointer; user-select:none; }
    .dr-switch input{ display:none; }
    .dr-toggle{ width:44px; height:26px; border-radius:999px; background:#2A3442; position:relative;
      transition:all var(--dr-dur) var(--dr-ease); border:1px solid rgba(255,255,255,.06); }
    .dr-knob{ position:absolute; top:3px; left:3px; width:20px; height:20px; border-radius:999px; background:#FFFFFF; transition:all var(--dr-dur) var(--dr-ease);
      box-shadow: 0 2px 6px rgba(0,0,0,.25); }
    .dr-switch input:checked + .dr-toggle{ background: var(--dr-grad-1); border-color: transparent; box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset; }
    .dr-switch input:checked + .dr-toggle .dr-knob{ transform: translateX(18px);
      box-shadow: 0 2px 6px rgba(0,0,0,.25), 0 0 0 3px rgba(255,214,233,.28); }

    /* Transitions for tab pages */
    .tabpage{ position:relative; }
    .tab-sec{ position:absolute; inset:0; opacity:0; transform: translateX(8px); pointer-events:none; transition: opacity var(--dr-dur) var(--dr-ease), transform var(--dr-dur) var(--dr-ease); }
    .tab-sec.active{ opacity:1; transform: translateX(0); pointer-events:auto; }
  </style>
</head>
<body>
  <div class="dr-wrap">
    <div class="dr-top">
      <div class="dr-h1">–ö–∞–±–∏–Ω–µ—Ç –≤—Ä–∞—á–∞</div>
      <div class="dr-code-pill">–í–∞—à –∫–æ–¥: <b id="topCode">‚Äî ‚Äî ‚Äî ‚Äî ‚Äî</b></div>
    </div>

    <nav class="dr-tabs">
      <div class="dr-tab active" data-tab="patients">–ü–∞—Ü–∏–µ–Ω—Ç—ã</div>
      <div class="dr-tab" data-tab="requests">–ó–∞—è–≤–∫–∏</div>
      <div class="dr-tab" data-tab="orders">–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è</div>
      <div class="dr-tab" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </nav>

    <main class="tabpage" style="min-height:60vh;">
      <!-- PATIENTS -->
      <section class="tab-sec active" id="tab-patients">
        <div class="dr-row">
          <div class="dr-search"><input id="search" class="dr-input" placeholder="–ü–æ–∏—Å–∫: –§–ò–û, @–Ω–∏–∫ –∏–ª–∏ –∫–æ–¥"></div>
          <button class="dr-chip" data-filter="status" data-value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</button>
          <button class="dr-chip" data-filter="status" data-value="on">–ù–∞ –∫—É—Ä—Å–µ</button>
          <button class="dr-chip" data-filter="status" data-value="off">–ù–µ –Ω–∞ –∫—É—Ä—Å–µ</button>
          <button class="dr-chip" data-filter="red" data-value="true">–ï—Å—Ç—å –∫—Ä–∞—Å–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã</button>
          <select id="daysNoReport" class="dr-select" title="–ë–µ–∑ –æ—Ç—á—ë—Ç–∞ > N –¥–Ω–µ–π">
            <option value="0">–ë–µ–∑ –æ—Ç—á—ë—Ç–∞: ‚Äî</option>
            <option value="7">–ë–µ–∑ –æ—Ç—á—ë—Ç–∞ &gt; 7 –¥–Ω</option>
            <option value="14">–ë–µ–∑ –æ—Ç—á—ë—Ç–∞ &gt; 14 –¥–Ω</option>
            <option value="30">–ë–µ–∑ –æ—Ç—á—ë—Ç–∞ &gt; 30 –¥–Ω</option>
          </select>
          <button id="resetFilters" class="dr-chip">–°–±—Ä–æ—Å</button>
        </div>

        <div id="patientsList" class="dr-list"></div>
        <div id="patientsEmpty" class="dr-empty" style="display:none">
          –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º <b id="emptyCode">AB12C</b> ‚Äî –Ω–æ–≤—ã–µ –ø–∞—Ü–∏–µ–Ω—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.
          <div>
            <button class="dr-btn-ghost" id="showQR">–ü–æ–∫–∞–∑–∞—Ç—å QR</button>
          </div>
        </div>
      </section>

      <!-- REQUESTS -->
      <section class="tab-sec" id="tab-requests">
        <div class="dr-row">
          <label class="dr-switch">
            <input type="checkbox" id="autoAccept">
            <span class="dr-toggle"><span class="dr-knob"></span></span>
            <span>–ê–≤—Ç–æ–ø—Ä–∏–Ω—è—Ç–∏–µ</span>
          </label>
        </div>
        <div id="requestsList" class="dr-list"></div>
        <div id="requestsEmpty" class="dr-empty" style="display:none">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫</div>
      </section>

      <!-- ORDERS -->
      <section class="tab-sec" id="tab-orders">
        <div class="inner-tabs">
          <div class="inner-tab active" data-in="analyses">–ê–Ω–∞–ª–∏–∑—ã</div>
          <div class="inner-tab" data-in="reco">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
        </div>
        <div id="orders-analyses">
          <div class="preset-list">
            <div class="preset">
              <b>–°—Ç–∞—Ä—Ç</b>
              ALT, AST, –¢—Ä–∏–≥–ª–∏—Ü–µ—Ä–∏–¥—ã, –•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω –æ–±—â–∏–π, (hCG –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
              <button class="dr-btn" data-preset="start">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç—É</button>
            </div>
            <div class="preset">
              <b>4-—è –Ω–µ–¥–µ–ª—è</b>
              ALT, AST, –¢—Ä–∏–≥–ª–∏—Ü–µ—Ä–∏–¥—ã, –•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω –æ–±—â–∏–π
              <button class="dr-btn" data-preset="week4">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç—É</button>
            </div>
            <div class="preset">
              <b>–ö–æ–Ω—Ç—Ä–æ–ª—å –ª–∏–ø–∏–¥–æ–≤</b>
              –¢—Ä–∏–≥–ª–∏—Ü–µ—Ä–∏–¥—ã, –•–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω –æ–±—â–∏–π
              <button class="dr-btn" data-preset="lipids">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç—É</button>
            </div>
            <div class="preset">
              <b>hCG (–¥–ª—è –∂–µ–Ω—â–∏–Ω)</b>
              hCG (–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π) + –¥–∞—Ç–∞
              <button class="dr-btn" data-preset="hcg">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç—É</button>
            </div>
          </div>
          <div class="history">
            <h4>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏</h4>
            <div id="ordersHistory"></div>
          </div>
        </div>

        <div id="orders-reco" style="display:none">
          <div class="preset-list">
            <div class="preset">
              <b>–ö–æ—Ä—Ä–µ–∫—Ü–∏—è –¥–æ–∑—ã</b>
              –†–µ–∫–æ–º–µ–Ω–¥—É—é —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∑—É —Å–æ–≥–ª–∞—Å–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞–º.
              <button class="dr-btn" data-reco="dose">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç—É</button>
            </div>
            <div class="preset">
              <b>–ö–æ–Ω—Ç—Ä–∞—Ü–µ–ø—Ü–∏—è</b>
              –ù–∞–ø–æ–º–∏–Ω–∞—é –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞–¥—ë–∂–Ω–æ–π –∫–æ–Ω—Ç—Ä–∞—Ü–µ–ø—Ü–∏–∏ –Ω–∞ –∫—É—Ä—Å–µ.
              <button class="dr-btn" data-reco="contraception">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç—É</button>
            </div>
            <div class="preset">
              <b>–ò–∑–±–µ–≥–∞—Ç—å –≤–∏—Ç–∞–º–∏–Ω–∞ A</b>
              –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–∫–ª—é—á–∏—Ç–µ –≤–∏—Ç–∞–º–∏–Ω A –∏ —Ä–µ—Ç–∏–Ω–æ–∏–¥—ã –≤ –¥–æ–±–∞–≤–∫–∞—Ö.
              <button class="dr-btn" data-reco="vitA">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç—É</button>
            </div>
            <div class="preset">
              <b>–ö–æ–Ω—Ç—Ä–æ–ª—å –∞–ª–∫–æ–≥–æ–ª—è</b>
              –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∞–ª–∫–æ–≥–æ–ª—å –Ω–∞ –∫—É—Ä—Å–µ.
              <button class="dr-btn" data-reco="alcohol">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç—É</button>
            </div>
          </div>
          <div class="history">
            <h4>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h4>
            <div id="recoHistory"></div>
          </div>
        </div>
      </section>

      <!-- PROFILE -->
      <section class="tab-sec" id="tab-profile">
        <div class="dr-card" style="margin-top:10px">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <div>
              <div style="font-weight:800; font-size:18px;" id="profName">–§–ò–û –≤—Ä–∞—á–∞</div>
              <div class="meta" id="profMeta">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Ä¢ –ö–ª–∏–Ω–∏–∫–∞, –ì–æ—Ä–æ–¥</div>
            </div>
            <div>
              <div class="dr-code-pill">–ú–æ–π –∫–æ–¥: <b id="profCode">‚Äî ‚Äî ‚Äî ‚Äî ‚Äî</b></div>
            </div>
          </div>
          <div class="dr-row" style="margin-top:12px">
            <button class="dr-btn-ghost" id="copyCode">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="dr-btn-ghost" id="qrCode">QR</button>
            <button class="dr-btn-ghost" id="shareCode">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            <label class="dr-switch" style="margin-left:auto">
              <input type="checkbox" id="autoAcceptProfile">
              <span class="dr-toggle"><span class="dr-knob"></span></span>
              <span>–ê–≤—Ç–æ–ø—Ä–∏–Ω—è—Ç–∏–µ</span>
            </label>
          </div>
        </div>
        <div class="dr-card" style="margin-top:12px">
          <div class="stat">
            <div class="kv cell"><div><b>–í—Å–µ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</b><div id="stTotal" style="font-size:22px; font-weight:800; margin-top:6px;">0</div></div></div>
            <div class="kv cell"><div><b>–ù–∞ –∫—É—Ä—Å–µ</b><div id="stOn" style="font-size:22px; font-weight:800; margin-top:6px;">0</div></div></div>
            <div class="kv cell"><div><b>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω—ã –∞–Ω–∞–ª–∏–∑—ã</b><div id="stRed" style="font-size:22px; font-weight:800; margin-top:6px;">0</div></div></div>
            <div class="kv cell"><div><b>–ù—É–∂–µ–Ω –æ—Ç–≤–µ—Ç</b><div id="stNeeds" style="font-size:22px; font-weight:800; margin-top:6px;">0</div></div></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Patient details modal -->
  <div class="modal" id="patientModal" aria-hidden="true">
    <div class="sheet">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <h3 id="ptTitle">–ü–∞—Ü–∏–µ–Ω—Ç</h3>
        <button class="dr-btn-ghost" id="ptClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="ptMeta" class="meta"></div>

      <div class="kv" style="margin-top:12px">
        <div class="cell">
          <b>–ö—É—Ä—Å</b>
          <div id="ptCourse" class="meta"></div>
          <div class="prog" style="margin-top:8px"><i id="ptProg"></i></div>
        </div>
        <div class="cell">
          <b>–†–∏—Å–∫–∏</b>
          <div id="ptRisks" class="meta"></div>
        </div>
      </div>

      <div class="kv">
        <div class="cell">
          <b>–ê–Ω–∞–ª–∏–∑—ã</b>
          <div id="ptLabs" class="meta"></div>
        </div>
        <div class="cell">
          <b>–û—Ç—á—ë—Ç—ã –∏ —Ñ–æ—Ç–æ</b>
          <div id="ptReports" class="meta"></div>
        </div>
      </div>

      <div class="p-actions" style="margin-top:8px">
        <button class="dr-btn" id="ptOrder">–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑—ã</button>
        <button class="dr-btn" id="ptReco">–û—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é</button>
        <button class="dr-btn-ghost" id="ptPhoto">–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ç–æ</button>
        <button class="dr-btn-ghost" id="ptFinish">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∫—É—Ä—Å</button>
      </div>

      <div style="margin-top:12px; text-align:right">
        <button class="dr-btn-ghost" id="ptDetach">–û—Ç–∫—Ä–µ–ø–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞</button>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div class="modal" id="qrModal" aria-hidden="true">
    <div class="sheet" style="max-width:420px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>QR –¥–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
        <button class="dr-btn-ghost" id="qrClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="qrBox" style="display:grid;place-items:center;"></div>
      <div class="meta" style="margin-top:8px">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ: —Å—Å—ã–ª–∫–∞ —Å –≤–∞—à–∏–º –∫–æ–¥–æ–º.</div>
    </div>
  </div>

  <script>
    // Utils and storage
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const storage = { set:(k,v)=>localStorage.setItem(k, JSON.stringify(v)), get:(k,d=null)=>JSON.parse(localStorage.getItem(k)||'null') ?? d };

    const fmtDate = iso => {
      if(!iso) return '‚Äî';
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    };

    const daysBetween = (iso)=>{
      if(!iso) return Infinity;
      const d = new Date(iso);
      const now = new Date();
      return Math.floor((now - d)/86400000);
    };

    const shareURL = (code)=> `${location.origin}${location.pathname}?attach=doctor&code=${code}`;

    // Sample data (can be replaced with API)
    const samplePatients = [
      {
        id: 'p1', name:'–ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞', age:24, city:'–ú–æ—Å–∫–≤–∞', handle:'@m_pet',
        course:{ start:'2025-06-09', dose_mg:20, progress:34, onCourse:true, target_mgkg:140 },
        labs:{ date:'2025-08-14', ALT:{val:22, status:'g'}, AST:{val:19, status:'g'}, TG:{val:1.9, status:'y'}, CHOL:{val:5.4, status:'y'} },
        lastReport:'2025-08-20', newMsgs:2, red:false,
        risks:['–ø–µ—á–µ–Ω—å: –Ω–µ—Ç','–ª–∏–ø–∏–¥—ã: –ø–æ–≤.','–ø—Å–∏—Ö–∏–∫–∞: –Ω–µ—Ç','–∞–ª–∫.: —Ä–µ–¥–∫–æ','–º–µ–¥–∏–∫–∞–º–µ–Ω—Ç—ã: –Ω–µ—Ç']
      },
      {
        id:'p2', name:'–ê–ª–µ–∫—Å–µ–π –°–º–∏—Ä–Ω–æ–≤', age:28, city:'–°–ü–±', handle:'@sm_al',
        course:{ start:'2025-05-18', dose_mg:30, progress:72, onCourse:true, target_mgkg:140 },
        labs:{ date:'2025-08-10', ALT:{val:48, status:'y'}, AST:{val:44, status:'y'}, TG:{val:3.2, status:'r'}, CHOL:{val:6.1, status:'r'} },
        lastReport:'2025-08-02', newMsgs:0, red:true,
        risks:['–ø–µ—á–µ–Ω—å: –Ω–µ—Ç','–ª–∏–ø–∏–¥—ã: –¥–∞','–ø—Å–∏—Ö–∏–∫–∞: –Ω–µ—Ç','–∞–ª–∫.: –∏–Ω–æ–≥–¥–∞','–º–µ–¥.: –≤–∏—ÇA?']
      },
      {
        id:'p3', name:'–ê–Ω–Ω–∞ –ö–∏–º', age:22, city:'–ö–∞–∑–∞–Ω—å', handle:'@anna_k',
        course:{ start:null, dose_mg:0, progress:0, onCourse:false, target_mgkg:0 },
        labs:{ date:null, ALT:{val:null, status:'g'}, AST:{val:null, status:'g'}, TG:{val:null, status:'g'}, CHOL:{val:null, status:'g'} },
        lastReport:null, newMsgs:1, red:false,
        risks:['–ø–µ—á–µ–Ω—å: –Ω–µ—Ç','–ª–∏–ø–∏–¥—ã: –Ω–µ—Ç','–ø—Å–∏—Ö–∏–∫–∞: –Ω–µ—Ç','–∞–ª–∫.: —Ä–µ–¥–∫–æ','–º–µ–¥.: –Ω–µ—Ç']
      }
    ];

    const sampleRequests = [
      { id:'r1', name:'–ò—Ä–∏–Ω–∞ –õ.', age:26, city:'–ú–æ—Å–∫–≤–∞', course:'20 –º–≥/—Å—É—Ç, —Å—Ç–∞—Ä—Ç 05.08', date:'2025-08-21' },
      { id:'r2', name:'–î–º–∏—Ç—Ä–∏–π –§.', age:31, city:'–í–æ—Ä–æ–Ω–µ–∂', course:null, date:'2025-08-22' }
    ];

    // State
    let state = {
      patients: storage.get('patientsList', samplePatients),
      requests: storage.get('patientsRequests', sampleRequests),
      filters: { q:'', status:'all', red:false, days:0 }
    };

    // Code at top and placeholders
    function initHeader(){
      const code = storage.get('doctorCode') || 'AB12C';
      $('#topCode').textContent = code;
      $('#emptyCode').textContent = code;
      $('#profCode').textContent = code;
    }

    // Tabs Nav
    function setTab(tab){
      $$('.dr-tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===tab));
      ['patients','requests','orders','profile'].forEach(id=> $('#tab-'+id).classList.toggle('active', id===tab));
      // hash
      location.hash = '#/doctor/'+tab;
      // inner defaults
      if(tab==='orders'){ setInner('analyses'); }
      renderAll();
    }

    $$('.dr-tab').forEach(t=> t.addEventListener('click', ()=> setTab(t.dataset.tab)));

    // Inner tabs for Orders
    function setInner(which){
      $$('.inner-tab').forEach(i=> i.classList.toggle('active', i.dataset.in===which));
      $('#orders-analyses').style.display = (which==='analyses')?'block':'none';
      $('#orders-reco').style.display = (which==='reco')?'block':'none';
    }
    $$('.inner-tab').forEach(i=> i.addEventListener('click', ()=> setInner(i.dataset.in)));

    // Render patients list with filters
    function matchesFilters(p){
      const q = state.filters.q.toLowerCase().trim();
      const inSearch = !q || [p.name, p.handle, p.id].some(x => (x||'').toLowerCase().includes(q));
      const stOk = state.filters.status==='all' ? true : (state.filters.status==='on' ? p.course.onCourse : !p.course.onCourse);
      const redOk = state.filters.red ? !!p.red || [p.labs?.ALT?.status,p.labs?.AST?.status,p.labs?.TG?.status,p.labs?.CHOL?.status].includes('r') : true;
      const daysOk = state.filters.days>0 ? daysBetween(p.lastReport) > state.filters.days : true;
      return inSearch && stOk && redOk && daysOk;
    }

    function renderPatients(){
      const list = $('#patientsList'); list.innerHTML='';
      const filtered = state.patients.filter(matchesFilters);
      if(filtered.length===0){
        $('#patientsEmpty').style.display = state.patients.length? 'block':'block';
      }else{
        $('#patientsEmpty').style.display = 'none';
      }
      filtered.forEach(p=> list.appendChild(patientCard(p)));
    }

    function patientCard(p){
      const el = document.createElement('div');
      el.className = 'dr-card p-card swipe';
      const lastDate = p.labs?.date ? fmtDate(p.labs.date) : '‚Äî';
      el.innerHTML = `
        <div class="swipe-track">
          <div class="p-top">
            <div>
              <div class="p-name">${p.name} <span class="p-meta">‚Ä¢ ${p.age} ‚Ä¢ ${p.city}</span></div>
              <div class="p-meta">${p.handle||''}</div>
            </div>
            <div class="pill">${p.newMsgs?`–ù–æ–≤—ã—Ö: ${p.newMsgs}`:'–ù–µ—Ç –Ω–æ–≤—ã—Ö'}</div>
          </div>
          <div class="p-grid">
            <div>
              <div class="p-badges">
                <span class="badge">–ö—É—Ä—Å: ${p.course.start?fmtDate(p.course.start):'‚Äî'} ‚Ä¢ ${p.course.dose_mg||0} –º–≥/—Å—É—Ç</span>
                <span class="badge">–¶–µ–ª—å: ${p.course.target_mgkg||'-'} –º–≥/–∫–≥</span>
                <span class="badge">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${p.course.progress||0}%</span>
              </div>
              <div class="prog" style="margin-top:8px"><i style="width:${p.course.progress||0}%"></i></div>
            </div>
            <div class="icons">
              <span title="–§–æ—Ç–æ">üì∑</span>
              <span title="–û—Ç—á—ë—Ç—ã">üìù</span>
              <span title="–°–æ–æ–±—â–µ–Ω–∏—è">üí¨</span>
            </div>
          </div>
          <div class="labs" style="margin-top:8px">
            <div class="lab"><span class="dot ${p.labs.ALT.status}"></span>ALT</div>
            <div class="lab"><span class="dot ${p.labs.AST.status}"></span>AST</div>
            <div class="lab"><span class="dot ${p.labs.TG.status}"></span>TG</div>
            <div class="lab"><span class="dot ${p.labs.CHOL.status}"></span>–•–°</div>
            <span class="p-meta" style="margin-left:auto">–æ—Ç ${lastDate}</span>
          </div>
          <div class="p-actions" style="margin-top:10px">
            <button class="dr-btn-ghost" data-open="${p.id}">–û—Ç–∫—Ä—ã—Ç—å</button>
            <button class="dr-btn" data-order="${p.id}">–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑—ã</button>
            <button class="dr-btn" data-reco="${p.id}">–û—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é</button>
          </div>
        </div>
      `;
      // Actions
      el.querySelector('[data-open]').addEventListener('click', ()=> openPatient(p.id));
      el.querySelector('[data-order]').addEventListener('click', ()=> sendOrderTo([p.id], 'custom'));
      el.querySelector('[data-reco]').addEventListener('click', ()=> sendRecoTo([p.id], 'custom'));
      return el;
    }

    // Requests
    function renderRequests(){
      const list = $('#requestsList'); list.innerHTML='';
      const reqs = state.requests;
      $('#requestsEmpty').style.display = reqs.length? 'none':'block';
      reqs.forEach(r=>{
        const row = document.createElement('div');
        row.className='dr-card req-row';
        row.innerHTML = `
          <div>
            <div class="p-name">${r.name} <span class="p-meta">‚Ä¢ ${r.age} ‚Ä¢ ${r.city}</span></div>
            <div class="p-meta">${r.course || '–ë–µ–∑ –∫—É—Ä—Å–∞'}</div>
            <div class="p-meta">–ó–∞–ø—Ä–æ—Å: ${fmtDate(r.date)}</div>
          </div>
          <div class="req-actions">
            <button class="dr-btn" data-accept="${r.id}">–ü—Ä–∏–Ω—è—Ç—å</button>
            <button class="dr-btn-ghost" data-decline="${r.id}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
          </div>
        `;
        row.querySelector('[data-accept]').addEventListener('click', ()=> acceptReq(r.id));
        row.querySelector('[data-decline]').addEventListener('click', ()=> declineReq(r.id));
        list.appendChild(row);
      });
    }

    function acceptReq(id){
      const idx = state.requests.findIndex(x=>x.id===id);
      if(idx>-1){
        const r = state.requests.splice(idx,1)[0];
        // create simple patient entity
        const newP = {
          id:'p'+Math.random().toString(36).slice(2,6).toUpperCase(),
          name:r.name, age:r.age, city:r.city, handle:'', newMsgs:0, red:false,
          course:{ start:null, dose_mg:0, progress:0, onCourse:false, target_mgkg:0 },
          labs:{ date:null, ALT:{status:'g'}, AST:{status:'g'}, TG:{status:'g'}, CHOL:{status:'g'} },
          lastReport:null,
          risks:['–ø–µ—á–µ–Ω—å: ‚Äî','–ª–∏–ø–∏–¥—ã: ‚Äî','–ø—Å–∏—Ö–∏–∫–∞: ‚Äî']
        };
        state.patients.unshift(newP);
        persist();
        renderAll();
        toast('–ü–∞—Ü–∏–µ–Ω—Ç –ø—Ä–∏–Ω—è—Ç');
      }
    }
    function declineReq(id){
      const idx = state.requests.findIndex(x=>x.id===id);
      if(idx>-1){ state.requests.splice(idx,1); persist(); renderAll(); toast('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞'); }
    }

    // Orders: presets
    const presetMap = {
      start: ['ALT','AST','TG','–•–°','hCG*'],
      week4: ['ALT','AST','TG','–•–°'],
      lipids:['TG','–•–°'],
      hcg:['hCG']
    };

    function choosePatients(cb){
      // simple prompt-style selector (can be replaced with modal list)
      const names = state.patients.map((p,i)=> `${i+1}. ${p.name}`).join('\\n');
      const pick = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:\\n'+names);
      if(!pick) return;
      const ids = pick.split(',').map(s=>parseInt(s.trim(),10)-1).filter(i=>i>=0 && i<state.patients.length).map(i=>state.patients[i].id);
      if(ids.length) cb(ids);
    }

    function pushOrderHistory(text, ids){
      const hist = storage.get('ordersHistory', []);
      hist.unshift({ at:new Date().toISOString(), text, to: ids.map(id=> state.patients.find(p=>p.id===id)?.name || id), status:'–æ–∂–∏–¥–∞–µ—Ç' });
      storage.set('ordersHistory', hist);
      renderOrdersHistory();
      toast('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
    }
    function renderOrdersHistory(){
      const box = $('#ordersHistory'); const hist = storage.get('ordersHistory', []);
      box.innerHTML = hist.length? '' : '<div class="meta">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>';
      hist.slice(0,8).forEach(h=>{
        const row = document.createElement('div'); row.className='row';
        row.innerHTML = `<div>${fmtDate(h.at)} ‚Äî ${h.text} ‚Üí ${h.to.join(', ')}</div><div class="chip">${h.status}</div>`;
        box.appendChild(row);
      });
    }

    function sendOrderTo(ids, preset){
      const title = preset==='custom' ? '–ê–Ω–∞–ª–∏–∑—ã (–ø–æ –≤—ã–±–æ—Ä—É –≤—Ä–∞—á–∞)' : `–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: ${preset}`;
      pushOrderHistory(title, ids);
    }

    $$('#orders-analyses .dr-btn').forEach(btn=> btn.addEventListener('click', e=>{
      const preset = e.target.dataset.preset;
      choosePatients(ids=> sendOrderTo(ids, preset));
    }));

    // Recommendations
    function pushRecoHistory(text, ids){
      const hist = storage.get('recoHistory', []);
      hist.unshift({ at:new Date().toISOString(), text, to: ids.map(id=> state.patients.find(p=>p.id===id)?.name || id) });
      storage.set('recoHistory', hist);
      renderRecoHistory();
      toast('–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
    }
    function renderRecoHistory(){
      const box = $('#recoHistory'); const hist = storage.get('recoHistory', []);
      box.innerHTML = hist.length? '' : '<div class="meta">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>';
      hist.slice(0,8).forEach(h=>{
        const row = document.createElement('div'); row.className='row';
        row.innerHTML = `<div>${fmtDate(h.at)} ‚Äî ${h.text} ‚Üí ${h.to.join(', ')}</div>`;
        box.appendChild(row);
      });
    }
    $$('#orders-reco .dr-btn').forEach(btn=> btn.addEventListener('click', e=>{
      const kind = e.target.dataset.reco;
      const texts = {
        dose: '–ö–æ—Ä—Ä–µ–∫—Ü–∏—è –¥–æ–∑—ã',
        contraception: '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –∫–æ–Ω—Ç—Ä–∞—Ü–µ–ø—Ü–∏–∏',
        vitA: '–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤–∏—Ç–∞–º–∏–Ω–∞ A',
        alcohol: '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∞–ª–∫–æ–≥–æ–ª—è'
      };
      const base = texts[kind] || '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è';
      const txt = prompt('–¢–µ–∫—Å—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–º–æ–∂–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å):', base);
      if(!txt) return;
      choosePatients(ids=> pushRecoHistory(txt, ids));
    }));

    // Patient details
    function openPatient(id){
      const p = state.patients.find(x=>x.id===id); if(!p) return;
      $('#ptTitle').textContent = p.name + ' ‚Ä¢ ' + p.age + ' ‚Ä¢ ' + p.city;
      $('#ptMeta').textContent = p.handle || '';
      $('#ptCourse').textContent = `–°—Ç–∞—Ä—Ç: ${p.course.start?fmtDate(p.course.start):'‚Äî'} ‚Ä¢ –î–æ–∑–∞: ${p.course.dose_mg||0} –º–≥/—Å—É—Ç ‚Ä¢ –¶–µ–ª—å: ${p.course.target_mgkg||'-'} –º–≥/–∫–≥ ‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${p.course.progress||0}%`;
      $('#ptProg').style.width = (p.course.progress||0)+'%';
      $('#ptRisks').textContent = p.risks.join(' ‚Ä¢ ');
      const lastDate = p.labs?.date ? fmtDate(p.labs.date) : '‚Äî';
      $('#ptLabs').textContent = `ALT ${p.labs.ALT.val??'‚Äî'} ‚Ä¢ AST ${p.labs.AST.val??'‚Äî'} ‚Ä¢ TG ${p.labs.TG.val??'‚Äî'} ‚Ä¢ –•–° ${p.labs.CHOL.val??'‚Äî'} ‚Äî –æ—Ç ${lastDate}`;
      $('#ptReports').textContent = p.lastReport? ('–ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç—á—ë—Ç: '+ fmtDate(p.lastReport)) : '–ï—â—ë –Ω–µ—Ç –æ—Ç—á—ë—Ç–æ–≤.';
      $('#patientModal').classList.add('show'); $('#patientModal').setAttribute('aria-hidden','false');
      // attach actions
      $('#ptOrder').onclick = ()=> sendOrderTo([id], 'custom');
      $('#ptReco').onclick = ()=> {
        const txt = prompt('–¢–µ–∫—Å—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:', '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è');
        if(txt) pushRecoHistory(txt, [id]);
      };
      $('#ptPhoto').onclick = ()=> toast('–ó–∞–ø—Ä–æ—Å —Ñ–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      $('#ptFinish').onclick = ()=> toast('–ö—É—Ä—Å –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω (UI-–¥–µ–º–æ)');
      $('#ptDetach').onclick = ()=> {
        if(confirm('–û—Ç–∫—Ä–µ–ø–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞?')){
          state.patients = state.patients.filter(x=>x.id!==id);
          persist(); renderAll(); $('#ptClose').click();
        }
      };
    }
    $('#ptClose').addEventListener('click', ()=> { $('#patientModal').classList.remove('show'); $('#patientModal').setAttribute('aria-hidden','true'); });

    // Profile screen
    function renderProfile(){
      const prof = storage.get('doctorProfile', {name:'–ò–≤–∞–Ω–æ–≤–∞ –ê–Ω–∞—Å—Ç–∞—Å–∏—è –°–µ—Ä–≥–µ–µ–≤–Ω–∞', specialty:'–î–µ—Ä–º–∞—Ç–æ–ª–æ–≥', clinic:'–ú–µ–¥—Ü–µ–Ω—Ç—Ä ¬´–°–∫–∏–Ω+¬ª', city:'–ú–æ—Å–∫–≤–∞'});
      $('#profName').textContent = prof.name || '–§–ò–û –≤—Ä–∞—á–∞';
      $('#profMeta').textContent = `${prof.specialty||'–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è'} ‚Ä¢ ${prof.clinic||'–ö–ª–∏–Ω–∏–∫–∞'}, ${prof.city||'–ì–æ—Ä–æ–¥'}`;
      const settings = storage.get('doctorSettings', { autoAccept:false });
      $('#autoAccept').checked = !!settings.autoAccept;
      $('#autoAcceptProfile').checked = !!settings.autoAccept;
      $('#autoAccept').onchange = (e)=> { settings.autoAccept = e.target.checked; storage.set('doctorSettings', settings); $('#autoAcceptProfile').checked = settings.autoAccept; };
      $('#autoAcceptProfile').onchange = (e)=> { settings.autoAccept = e.target.checked; storage.set('doctorSettings', settings); $('#autoAccept').checked = settings.autoAccept; };
      // stats
      const total = state.patients.length;
      const on = state.patients.filter(p=>p.course.onCourse).length;
      const red = state.patients.filter(p=> p.red || [p.labs.ALT.status,p.labs.AST.status,p.labs.TG.status,p.labs.CHOL.status].includes('r')).length;
      const needs = state.patients.filter(p=> (p.newMsgs||0)>0).length;
      $('#stTotal').textContent = total;
      $('#stOn').textContent = on;
      $('#stRed').textContent = red;
      $('#stNeeds').textContent = needs;
    }

    // Search / filters
    $('#search').addEventListener('input', e=> { state.filters.q = e.target.value; renderPatients(); });
    $$('#tab-patients .dr-chip').forEach(chip=> chip.addEventListener('click', ()=>{
      const f = chip.dataset.filter, val = chip.dataset.value;
      if(f==='status'){ state.filters.status = val; $$('#tab-patients .dr-chip[data-filter="status"]').forEach(c=> c.classList.toggle('active', c===chip)); }
      if(f==='red'){ state.filters.red = !state.filters.red; chip.classList.toggle('active', state.filters.red); }
      renderPatients();
    }));
    $('#daysNoReport').addEventListener('change', e=> { state.filters.days = parseInt(e.target.value,10)||0; renderPatients(); });
    $('#resetFilters').addEventListener('click', ()=>{
      state.filters = { q:'', status:'all', red:false, days:0 };
      $('#search').value=''; $('#daysNoReport').value='0';
      $$('#tab-patients .dr-chip').forEach(c=> c.classList.remove('active'));
      renderPatients();
    });

    // QR buttons
    $('#showQR').addEventListener('click', openQR);
    $('#qrCode').addEventListener('click', openQR);
    function openQR(){
      const code = storage.get('doctorCode') || 'AB12C';
      const url = shareURL(code);
      const api = 'https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=' + encodeURIComponent(url);
      $('#qrBox').innerHTML = `<img alt="QR" src="${api}" decoding="async" loading="lazy">`;
      $('#qrModal').classList.add('show'); $('#qrModal').setAttribute('aria-hidden','false');
    }
    $('#qrClose').addEventListener('click', ()=> { $('#qrModal').classList.remove('show'); $('#qrModal').setAttribute('aria-hidden','true'); });

    // Profile copy/share
    $('#copyCode').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(storage.get('doctorCode') || 'AB12C'); toast('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); }catch(e){}
    });
    $('#shareCode').addEventListener('click', async ()=>{
      const code = storage.get('doctorCode') || 'AB12C';
      const url = shareURL(code);
      if(navigator.share){ try{ await navigator.share({ title:'–ö–æ–¥ –≤—Ä–∞—á–∞', text:`–ú–æ–π –∫–æ–¥: ${code}`, url }); }catch(e){} }
      else { try{ await navigator.clipboard.writeText(url); toast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'); }catch(e){} }
    });

    // Persist state
    function persist(){
      storage.set('patientsList', state.patients);
      storage.set('patientsRequests', state.requests);
    }

    // Render helpers
    function renderAll(){
      renderPatients();
      renderRequests();
      renderOrdersHistory();
      renderRecoHistory();
      renderProfile();
    }

    // Toast
    function toast(txt){
      const n = document.createElement('div');
      n.textContent = txt;
      n.style.cssText = 'position:fixed;left:50%;bottom:28px;transform:translateX(-50%);padding:10px 14px;border-radius:12px;background:rgba(0,0,0,.7);color:#fff;font-weight:600;z-index:9999';
      document.body.appendChild(n);
      setTimeout(()=>n.remove(), 1400);
    }

    // Init
    initHeader();
    renderAll();

    // Router (hash) support
    function initRoute(){
      const h = location.hash.replace('#/doctor/','');
      const tabs = ['patients','requests','orders','profile'];
      if(tabs.includes(h)) setTab(h);
      else setTab('patients');
    }
    window.addEventListener('hashchange', initRoute);
    initRoute();
  </script>
</body>
</html>
