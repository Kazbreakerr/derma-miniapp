<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Профиль — RoaccutaneTracker</title>
  <style>
    :root{
      --bg-0:#0f1722; /* общий фон */
      --bg-1:rgba(255,255,255,.06); /* стекло */
      --bg-2:rgba(255,255,255,.04);
      --bd-1:rgba(255,255,255,.14); /* границы */
      --txt:#edf2ff;
      --muted:#a9b0c8;
      --accent-1:#23e3cc; /* бирюзовый */
      --accent-2:#3489ff; /* сине-бирюзовый градиент */
      --warning:#ffb545;
      --good:#2ee6a1;
      --bad:#ff6a7b;
      --shadow:0 14px 34px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
      --radius-2xl:24px;
      --radius-xl:18px;
      --radius-lg:14px;
      --gap:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--txt); background: radial-gradient(1200px 600px at 75% -10%, #18304e, transparent 60%),
                 radial-gradient(900px 600px at -10% 10%, #1a2b3f, transparent 60%), var(--bg-0);
      font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }
    a{color:inherit; text-decoration:none}

    .container{ max-width:820px; margin:0 auto; padding:20px 14px 88px; }

    /* Top bar */
    .topbar{ position:sticky; top:0; z-index:50; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 6px; background:linear-gradient(to bottom, rgba(15,23,34,.9), rgba(15,23,34,.55) 60%, transparent); backdrop-filter: blur(10px); }
    .title{ font-weight:700; letter-spacing:.2px; font-size:18px; opacity:.9 }
    .iconbtn{ display:inline-flex; align-items:center; justify-content:center; width:42px; height:42px; border-radius:999px; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); border:1px solid var(--bd-1); box-shadow:var(--shadow); cursor:pointer }
    .iconbtn.modern{ position:relative; background:linear-gradient(135deg, rgba(35,227,204,.18), rgba(52,137,255,.12)); border:1px solid rgba(255,255,255,.18); }
    .iconbtn.modern:hover{ transform:translateY(-1px) scale(1.02) }
    .iconbtn.modern::after{ content:""; position:absolute; inset:0; border-radius:inherit; box-shadow:inset 0 1px 8px rgba(255,255,255,.06), 0 0 0 1px rgba(0,0,0,.15); pointer-events:none }
    .iconbtn:hover{ transform:translateY(-1px) }

    /* Glass card */
    .card{ background:var(--bg-1); border:1px solid var(--bd-1); box-shadow:var(--shadow); border-radius:var(--radius-2xl); backdrop-filter: blur(14px) saturate(1.35); -webkit-backdrop-filter: blur(14px) saturate(1.35); }

    /* HERO (shared element) */
    .hero{ position:relative; padding:20px; overflow:hidden; background: linear-gradient(135deg, rgba(46,230,161,.14), rgba(35,227,204,.10) 40%, rgba(52,137,255,.06)), var(--bg-1); }
    .hero[view-transition-name]{
      /* Важное: имя должно совпадать с блоком на main для Shared Element Transition */
    }
    .hero-head{ display:grid; place-items:center; gap:14px; padding:8px 0 12px; }

    .avatar-wrap{ position:relative; width:168px; height:168px; }
    .avatar{ width:100%; height:100%; border-radius:999px; background:#0d1623; display:grid; place-items:center; overflow:hidden; border:1px solid var(--bd-1); }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block }

    /* Progress ring (SVG) */
    .ring{ position:absolute; inset:-6px; }
    .ring svg{ width:calc(100% + 12px); height:calc(100% + 12px); display:block }
    .ring .track{ stroke:rgba(255,255,255,.14) }
    .ring .bar{ stroke-linecap:round; filter: drop-shadow(0 2px 4px rgba(0,0,0,.35)); }

    .hero-name{ font-weight:700; font-size:18px; }
    .hero-meta{ color:var(--muted); font-size:13px; }

    /* Chips grid around avatar */
    .chips{ margin-top:8px; display:grid; grid-template-columns:repeat(6, minmax(0,1fr)); gap:10px; }
    @media (max-width:720px){ .chips{ grid-template-columns:repeat(3, minmax(0,1fr)); } }
    @media (max-width:420px){ .chips{ grid-template-columns:repeat(2, minmax(0,1fr)); } }
    .chip{ display:flex; flex-direction:column; justify-content:center; align-items:flex-start; gap:2px; padding:12px; min-height:64px; border-radius:var(--radius-lg); background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); border:1px solid var(--bd-1); }
    .chip b{ font-size:14px; letter-spacing:.2px }
    .chip small{ color:var(--muted) }

    /* Soft divider between blocks */
    .soft-bridge{ height:20px; }

    /* Details block */
    .details{ padding:16px; border-radius:var(--radius-2xl); background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); border:1px solid var(--bd-1); }
    .sec-title{ font-weight:700; margin:0 0 10px 2px; }

    .row{ display:flex; gap:12px; flex-wrap:wrap }
    .row .card{ padding:14px; border-radius:var(--radius-xl); }

    .kv{ display:grid; grid-template-columns: 120px 1fr; gap:8px 12px; align-items:center; }
    .kv dt{ color:var(--muted) }
    .kv dd{ margin:0 }

    .doctor{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; min-width:260px; }
    .doctor .actions{ display:flex; gap:8px }

    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; min-height:44px; padding:0 14px; font-weight:600; border-radius:14px; border:1px solid var(--bd-1); background:var(--bg-2); cursor:pointer; }
    .btn svg{ width:18px; height:18px; min-width:18px; min-height:18px; }
    .btn:hover{ transform:translateY(-1px) }
    .btn.ghost{ background:transparent }
    .btn.primary{ border:none; background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); color:#0d1220 }

    .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--bd-1); background:rgba(255,255,255,.06); font-weight:600 }
    .pill.ok{ color:var(--good) }
    .pill.warn{ color:var(--warning) }
    .pill.bad{ color:var(--bad) }

    /* CTA Diary */
    .diary{ margin-top:12px; display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-radius:var(--radius-xl); border:1px solid var(--bd-1); background:linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); }

    /* Reminders */
    .reminders{ margin-top:16px; padding:16px; }
    .reminders h3{ margin:0 0 10px 2px; font-weight:700 }
    .field{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 14px; border-radius:14px; border:1px solid var(--bd-1); background:var(--bg-2); margin-top:10px }
    .field .lhs{ display:flex; flex-direction:column; gap:4px }
    .field .rhs{ display:flex; align-items:center; gap:12px }
    .field .unit{ opacity:.8 }

    /* switch */
    .switch{ position:relative; width:54px; height:32px; flex:0 0 auto }
    .switch input{ opacity:0; width:0; height:0 }
    .switch .slider{ position:absolute; inset:0; border-radius:999px; background:rgba(255,255,255,.18); transition:.25s ease; border:1px solid var(--bd-1) }
    .switch .slider::before{ content:""; position:absolute; width:26px; height:26px; border-radius:999px; left:3px; top:2px; background:#0d1320; border:1px solid rgba(255,255,255,.25); box-shadow:0 2px 6px rgba(0,0,0,.45); transition:.25s ease }
    .switch input:checked + .slider{ background:linear-gradient(135deg, var(--accent-1), var(--accent-2)); }
    .switch input:checked + .slider::before{ transform:translateX(22px); background:#0d1220; border-color:transparent }

    .field input[type=time], .field input[type=number]{ height:36px; padding:0 10px; border-radius:10px; border:1px solid var(--bd-1); background:rgba(255,255,255,.06); color:var(--txt); font-weight:600; min-width:88px }
    .field input[type=number]{ width:88px; }

    /* Bottom nav */
    .tabbar{ position:fixed; left:0; right:0; bottom:0; z-index:40; display:grid; grid-template-columns:repeat(5,1fr); gap:6px; padding:8px 12px calc(8px + env(safe-area-inset-bottom)); background:rgba(6,12,19,.78); backdrop-filter: blur(12px); border-top:1px solid rgba(255,255,255,.12) }
    .tab{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; height:56px; border-radius:14px; color:var(--muted) }
    .tab.active{ color:#fff; background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); border:1px solid var(--bd-1) }
    .tab svg{ width:20px; height:20px }

    /* View Transitions (optional cross-page) */
    ::view-transition-old(root), ::view-transition-new(root){ animation-duration:.38s; }
    .hero{ view-transition-name: profile-hero; }

    /* Utility */
    .muted{ color:var(--muted) }
  /* --- Overrides for contrast edit button & new RX/lightbox styles --- */
    .iconbtn.modern{ background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); border:none; color:#0d1220; box-shadow: 0 8px 24px rgba(35,227,204,.25), 0 2px 0 rgba(0,0,0,.2) inset; }
    .iconbtn.modern:hover{ transform:translateY(-1px) scale(1.03) }
    .iconbtn.modern::after{ display:none }

    /* RX (prescription) */
    .rx{ margin-top:10px; display:grid; grid-template-columns: 80px 1fr; gap:12px; align-items:center; }
    .rx .rx-label{ font-weight:700 }
    .rx .rx-controls{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .rx-thumb{ width:72px; height:72px; border-radius:12px; border:1px dashed rgba(255,255,255,.35); background-size:cover; background-position:center; background-color:rgba(255,255,255,.05); box-shadow:var(--shadow); cursor:pointer }

    /* Lightbox */
    .lightbox{ position:fixed; inset:0; background:rgba(3,6,12,.75); display:flex; align-items:center; justify-content:center; padding:24px; z-index:9999 }
    .lightbox[hidden]{ display:none }
    .lightbox img{ max-width:90vw; max-height:85vh; border-radius:14px; box-shadow:0 24px 80px rgba(0,0,0,.6); background:#000 }
  .btn.contrast{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.45); color:#fff; }
    .btn.contrast:hover{ background:rgba(255,255,255,.1); }
    .btn.contrast svg{ stroke: currentColor; }
  /* Light theme overrides */
    body.light{ color:var(--txt); background: radial-gradient(1600px 900px at 82% -12%, rgba(82, 220, 164, .55), transparent 60%), radial-gradient(1600px 900px at -12% 0%, rgba(255, 185, 150, .55), transparent 60%), var(--bg-0); }
    body.light:root{}
    body.light{ --bg-0:#eef2f8; --bg-1:rgba(255,255,255,.66); --bg-2:rgba(255,255,255,.45); --bd-1:rgba(0,0,0,.08); --txt:#0d1220; --muted:#5a6783; }
    body.light .tabbar{ background:rgba(255,255,255,.85); border-top:1px solid rgba(0,0,0,.08); }
    body.light .topbar{ background:linear-gradient(to bottom, rgba(255,255,255,.92), rgba(255,255,255,.7) 60%, transparent); }

  /* Light theme component overrides for visibility */
  body.light .btn.contrast{ 
    background: rgba(255,255,255,.92); 
    border:1px solid rgba(0,0,0,.12); 
    color:#0d1220; 
  }
  body.light .btn.contrast:hover{ background: rgba(255,255,255,.98); }
  body.light .rx-thumb{ 
    border:1px dashed rgba(0,0,0,.18); 
    background-color: rgba(255,255,255,.9);
  }
  body.light .text-input,
  body.light .field input[type=time],
  body.light .field input[type=number]{
    background: rgba(255,255,255,.98);
    color:#0d1220;
    border:1px solid rgba(0,0,0,.12);
  }
  body.light .pill.ok{ color:#09a66d; }
  body.light .topbar{ box-shadow: none; }


    /* Theme switch FAB */
    .theme-fab{ display:none !important; position:fixed; right:12px; bottom:calc(74px + env(safe-area-inset-bottom)); z-index:45; display:inline-flex; align-items:center; gap:8px; height:44px; padding:0 14px; border-radius:999px; border:none; cursor:pointer; font-weight:700; background:linear-gradient(135deg, var(--accent-1), var(--accent-2)); color:#0d1220; box-shadow:var(--shadow); }
    .theme-fab svg{ width:18px; height:18px }

    .btn.contrast{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.45); color:#fff; }
    .btn.contrast:hover{ background:rgba(255,255,255,.1); }
    .btn.contrast svg{ stroke: currentColor; }
  /* Doctor bind */
    .doc-bind{ display:flex; gap:10px; align-items:center; padding-top:6px }
    .text-input{ height:42px; padding:0 12px; border-radius:12px; border:1px solid var(--bd-1); background:rgba(255,255,255,.06); color:var(--txt); font-weight:600; min-width:220px }
    .text-input::placeholder{ color:var(--muted) }
    .help{ font-size:13px; color:var(--muted) }
  /* Doctor small avatar + detach */
    .doc-head{ display:grid; grid-template-columns:44px 1fr auto; align-items:center; gap:10px; margin-top:8px }
    .doc-avatar{ width:44px; height:44px; border-radius:999px; overflow:hidden; border:1px solid var(--bd-1); background:#0d1623; display:grid; place-items:center; font-weight:700 }
    .doc-avatar img{ width:100%; height:100%; object-fit:cover; display:block }
    .btn.danger{ color:var(--bad); background:rgba(255,0,0,.05); border:1px solid rgba(255,255,255,.2) }
    .btn.danger:hover{ background:rgba(255,0,0,.12) }
  .subcap{ font-weight:700; text-transform:uppercase; letter-spacing:.06em; font-size:13px; color:var(--muted); margin:12px 0 8px }
    .doc-actions{ display:flex; gap:8px; flex-wrap:wrap }
    .rx-controls{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
  .doctor [hidden]{display:none !important}
    .btn[disabled]{ opacity:.5; cursor:not-allowed; filter:saturate(.6) }
    .err{ font-size:13px; color:var(--bad); margin-left:2px }
  .lightbox .lb-close{ position:absolute; top:16px; right:16px; width:40px; height:40px; border-radius:999px; display:grid; place-items:center; background:rgba(255,255,255,.1); border:1px solid var(--bd-1); cursor:pointer; box-shadow:var(--shadow) }
    .lightbox .lb-close:hover{ transform:translateY(-1px) }
  
/* --- Light theme tuning (reduce glare) --- */
body.light{
  --bg-0:#e7edf4;            /* чуть темнее базовый фон */
  --bg-1:rgba(255,255,255,.60); /* карточки менее белые */
  --bg-2:rgba(13,18,32,.035);   /* мягкая тень/подложка */
  --bd-1:rgba(0,0,0,.10);       /* границы чуть контрастнее */
}
/* Мягче фон таббара, карточек и топбара */
body.light .tabbar{ background:rgba(255,255,255,.80); }
body.light .topbar{ background:linear-gradient(to bottom, rgba(255,255,255,.90), rgba(255,255,255,.65) 60%, transparent); }
body.light .card{ background:var(--bg-1); border-color:var(--bd-1); }
/* --- Onboarding "Профиль" button visibility in light theme --- */
body.light #onboarding .btn,
body.light .onboarding .btn,
body.light .btn.profile,
body.light [data-onboarding] .btn{
  background: rgba(255,255,255,.94);
  border: 1px solid rgba(0,0,0,.14);
  color: #0d1220 !important;
}


/* Light: active tab contrast */
body.light .tab.active{
  color:#0d1220;
  background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65));
  border:1px solid rgba(0,0,0,.12);
}


/* === Fade&Slide cross-page transitions === */
@keyframes vt-fade-slide-in {
  from { opacity: 0; transform: translateY(8px) scale(.995); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
@keyframes vt-fade-slide-out {
  from { opacity: 1; transform: translateY(0) scale(1); }
  to   { opacity: 0; transform: translateY(-8px) scale(.995); }
}
::view-transition-old(root){ animation: vt-fade-slide-out .35s ease both; }
::view-transition-new(root){ animation: vt-fade-slide-in  .35s ease both; }

</style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="title">Профиль</div>
    <button class="iconbtn modern" id="editBtn" title="Редактировать профиль" aria-label="Редактировать">
      <!-- pencil icon -->
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
    </button>
  </div>

  <main class="container">
    <!-- HERO -->
    <section class="card hero" id="hero">
      <div class="hero-head">
        <div class="avatar-wrap">
          <div class="avatar" aria-label="Аватар">
            <img id="avatarImg" alt="Аватар" src="" onerror="this.remove()">
            <!-- fallback initials -->
            <span id="avatarFallback" style="font-weight:700; opacity:.9">U</span>
          </div>
          <div class="ring" aria-hidden="true">
            <svg viewBox="0 0 120 120">
              <defs>
                <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
                  <stop offset="0%" stop-color="var(--accent-1)"/>
                  <stop offset="100%" stop-color="var(--accent-2)"/>
                </linearGradient>
              </defs>
              <circle class="track" cx="60" cy="60" r="54" fill="none" stroke-width="6" />
              <circle class="bar"   cx="60" cy="60" r="54" fill="none" stroke="url(#g)" stroke-width="6" stroke-dasharray="339.292" stroke-dashoffset="339.292" />
            </svg>
          </div>
        </div>
        <div class="hero-name" id="userName">Имя</div>
        <div class="hero-meta" id="heroMeta">Цель: — mg/kg • Прогноз окончания: —</div>
      </div>

      <div class="chips" id="chips">
        <div class="chip"><small>Цель, mg/kg</small><b id="goalMgKg">—</b></div>
        <div class="chip"><small>Цель, mg</small><b id="goalMg">—</b></div>
        <div class="chip"><small>Текущий прогресс</small><b id="progressAbs">—</b><small id="progressPct" class="muted">—</small></div>
        <div class="chip"><small>Вес</small><b id="weight">—</b></div>
        <div class="chip"><small>Препарат</small><b id="drug">—</b></div>
        <div class="chip"><small>Дата начала</small><b id="start">—</b></div>
      </div>
    </section>

    <div class="soft-bridge"></div>

    <!-- DETAILS -->
    <section class="details card">
      <h3 class="sec-title">Детали профиля</h3>

      <div class="row">
        <div class="card" style="flex:1; min-width:260px;">
          <dl class="kv">
            <dt>Аллергии</dt><dd id="allergies">нет данных</dd>
            <dt>Сегодня</dt><dd id="today">— мг</dd>
            <dt>Последний приём</dt><dd id="lastDose">— мг</dd>
          </dl>
        </div>

        <div class="card doctor">
          <div>
            <div style="font-weight:700">Лечащий врач</div>
            <div class="muted" id="doctorMeta">Врач не прикреплён</div>
          </div>
          <div class="doc-head" id="docHead" style="grid-column:1/-1" hidden>
            <div class="doc-avatar">
              <img id="docAvatarImg" alt="Врач" onerror="this.remove()">
              <span id="docAvatarFallback">?</span>
            </div>
            <div>
              <div class="doc-name" id="docName" style="font-weight:700"></div>
              <div class="muted" id="docSub"></div>
            </div>
            <button class="btn danger" id="docDetachBtn" type="button">Открепить</button>
          </div>
          <div class="doc-bind" id="docBind" style="grid-column:1/-1">
            <input id="docCodeInput" class="text-input" type="text" placeholder="Введите код врача">
            <button class="btn primary" id="docBindBtn" disabled>Прикрепить врача</button>
            
          </div>
          <div class="err" id="docError" style="grid-column:1/-1" hidden>Код врача не найден</div>
          <div id="analysesBlock" style="grid-column:1/-1" hidden>
            <div class="subcap">Анализы</div>
          <div class="actions doc-actions">
            <button class="btn primary" id="shareBtn" title="Отправить отчёт">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#0d1220" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg>
              Отправить отчёт
            </button>
            <a class="btn" href="labs.html" data-vt-link>
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
              Контроль анализов</a>
            <a class="btn contrast" id="doctorProfileBtn" href="#" target="_blank" rel="noopener" hidden>
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 3h7v7"/><path d="M14 10 21 3"/><path d="M5 7h5"/><path d="M5 11h3"/><path d="M5 15h7"/></svg>
              Профиль врача
            </a>
          </div>
          </div>
          <div id="labLine" style="grid-column:1/-1" class="muted" hidden>
            Статус: <span id="labStatus" class="pill ok">OK</span> • Дедлайн: <span id="labDue">—</span>
          </div>
          <!-- RX prescription block -->
          <div class="rx" style="grid-column:1/-1">
            <div class="rx-label">Рецепт</div>
            <div class="rx-controls">
              <div class="rx-thumb" id="rxThumb" title="Открыть рецепт" hidden></div>
              <button class="btn contrast" id="rxUploadBtn">
                <!-- cloud-upload icon -->
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 16.5a4.5 4.5 0 0 0-1.6-8.7 6 6 0 0 0-11.3 2.2A4 4 0 0 0 4 14.5"/>
                  <polyline points="16 16 12 12 8 16"/>
                  <line x1="12" y1="12" x2="12" y2="22"/>
                </svg>
                Загрузить рецепт
              </button>
              <button class="btn danger" id="rxDeleteBtn" hidden>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
                Удалить рецепт
              </button>
              <input id="rxInput" type="file" accept="image/*" hidden>
            </div>
          </div>
        </div>
      </div>

      <div class="diary">
        <div>
          <div style="font-weight:700">Дневник состояния</div>
          <div class="muted">Отслеживайте самочувствие, сухость кожи/губ, настроение</div>
        </div>
        <a class="btn primary" href="diary.html" data-vt-link>
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#0d1220" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 0 6.5 22H20"/><path d="M20 22V6a2 2 0 0 0-2-2H6.5A2.5 2.5 0 0 0 4 6.5V22"/><path d="M8 8h8"/><path d="M8 12h8"/></svg>
          Посетить дневник
        </a>
      </div>
    </section>

    <!-- REMINDERS -->
    <section class="card reminders">
      <h3>Напоминания</h3>
      <div class="field">
        <div class="lhs">
          <b>Напоминать ежедневно</b>
          <span class="muted">Выберите время</span>
        </div>
        <div class="rhs">
          <label class="switch" aria-label="Вкл/выкл ежедневное напоминание">
            <input id="remDaily" type="checkbox">
            <span class="slider"></span>
          </label>
          <input id="remTime" type="time" value="09:00">
        </div>
      </div>
      <div class="field">
        <div class="lhs">
          <b>Напоминать о закупке лекарства</b>
          <span class="muted">Когда останется ≤ заданного количества капсул</span>
        </div>
        <div class="rhs">
          <label class="switch" aria-label="Вкл/выкл напоминание о закупке">
            <input id="remStock" type="checkbox">
            <span class="slider"></span>
          </label>
          <input id="remThreshold" class="num" type="number" min="1" max="200" step="1" value="10" aria-label="Порог капсул">
          <span class="unit">капсул</span>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom tabbar -->
  <nav class="tabbar">
    <a class="tab" href="main-dark.html" data-vt-link>
      <!-- home icon (rounded) -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 11l9-7 9 7"/><path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7"/><path d="M9 21v-6h6v6"/></svg>
      <small>Главная</small>
    </a>
    <a class="tab" href="calendar.html" data-vt-link>
      <!-- calendar icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="3"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
      <small>Календарь</small>
    </a>
    <a class="tab active" href="myprofile.html" data-vt-link>
      <!-- profile icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <small>Профиль</small>
    </a>
    <a class="tab" href="photolog.html" data-vt-link>
      <!-- image/gallery icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="14" rx="2"/><circle cx="8.5" cy="12" r="2.5"/><path d="M21 13l-4-4-6 6"/></svg>
      <small>Фотодневник</small>
    </a>
    <a class="tab" href="labs.html" data-vt-link>
      <!-- flask icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 2v5l-5 9a4 4 0 0 0 3.5 6h7a4 4 0 0 0 3.5-6l-5-9V2"/><path d="M8 11h8"/></svg>
      <small>Анализы</small>
    </a>
  </nav>
  <button class="theme-fab" id="themeBtn" type="button" title="Поменять тему">
    <svg viewBox="0 0 24 24" fill="none" stroke="#0d1220" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></svg>
    <span>Светлая тема</span>
  </button>

  <script>
  // ======= Demo state (замени интеграцией с твоими данными) =======
  const STATE = {
    name: 'Ульяна',
    avatarUrl: '', // вставь URL или оставь пустым, будут инициалы
    weightKg: 47.2,
    drug: 'Роаккутан',
    startISO: '2025-07-20',
    goalMgPerKg: 120, // целевая кумулятивная в mg/kg
    takenMg: 2100,    // уже принято, мг
    todayMg: 20,
    lastDoseMg: 20,
    allergies: 'Отсутствуют',
    doctor: { name: 'Иванова Н.В.', phone: '+7 999 000‑00‑00', clinic: 'Derma Clinic' },
    labs: { status: 'ok', dueISO: '2025-09-05' }
  };

  // ======= Helpers =======
  const $ = s => document.querySelector(s);
  function fmtDate(iso){ try{ const d=new Date(iso+'T00:00:00'); return d.toLocaleDateString('ru-RU'); }catch(_){ return iso||'—'; } }
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

  function populate(){
    $('#userName').textContent = STATE.name || 'Профиль';
    const av = $('#avatarImg'); if(STATE.avatarUrl){ av.src = STATE.avatarUrl; } else { $('#avatarFallback').textContent = (STATE.name||'U').trim().charAt(0).toUpperCase(); }

    const goalMg = Math.round(STATE.weightKg * STATE.goalMgPerKg);
    const pct = clamp(goalMg? (STATE.takenMg/goalMg*100):0, 0, 100);

    $('#goalMgKg').textContent = STATE.goalMgPerKg + ' mg/kg';
    $('#goalMg').textContent   = goalMg.toLocaleString('ru-RU') + ' мг';
    $('#progressAbs').textContent = STATE.takenMg.toLocaleString('ru-RU') + ' мг';
    $('#progressPct').textContent = Math.round(pct) + '%';
    $('#weight').textContent = STATE.weightKg + ' кг';
    $('#drug').textContent = STATE.drug;
    $('#start').textContent = fmtDate(STATE.startISO);

    // simple forecast: remaining / (today or avg 20mg/day)
    const daily = Math.max(STATE.todayMg || 0, 20);
    const remain = Math.max(goalMg - STATE.takenMg, 0);
    const days = Math.ceil(remain / daily) || 0;
    const eta = new Date(); eta.setDate(eta.getDate()+days);
    $('#heroMeta').textContent = `Цель: ${STATE.goalMgPerKg} mg/kg • Прогноз окончания: ${fmtDate(eta.toISOString().slice(0,10))}`;

    $('#allergies').textContent = STATE.allergies || 'Не указаны';
    $('#today').textContent = (STATE.todayMg||0) + ' мг';
    $('#lastDose').textContent = (STATE.lastDoseMg||0) + ' мг';

    const doc = STATE.doctor||{}; $('#doctorMeta').textContent = [doc.name, doc.clinic, doc.phone].filter(Boolean).join(' • ');

    const st = (STATE.labs||{}).status||'miss';
    const pill = document.getElementById('labStatus');
    pill.textContent = st==='ok' ? 'OK' : (st==='warn' ? 'Внимание' : 'Не сдано');
    pill.className = 'pill ' + (st==='ok'?'ok':st==='warn'?'warn':'bad');
    $('#labDue').textContent = fmtDate((STATE.labs||{}).dueISO || '');

    // update ring
    const C = 2*Math.PI*54; const off = C*(1-pct/100);
    document.querySelector('.ring .bar').setAttribute('stroke-dashoffset', off);
  }


  // --- Telegram user override (name + photo) ---
  (function applyTelegramUser(){
    try{
      const tg = window.Telegram?.WebApp;
      const u = tg?.initDataUnsafe?.user;
      if(u){
        const full = [u.first_name, u.last_name].filter(Boolean).join(' ').trim();
        if (full) STATE.name = full;
        if (u.photo_url) STATE.avatarUrl = u.photo_url;
      }
    }catch(_){}
  })();

  populate();

  // ======= Theme toggle =======
  const THEME_KEY = 'rt_theme';
  function updateThemeBtn(){
    const btn = document.getElementById('themeBtn'); if(!btn) return;
    const isLight = document.body.classList.contains('light');
    btn.innerHTML = isLight
      ? '<svg viewBox="0 0 24 24" fill="none" stroke="#0d1220" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg><span>Тёмная тема</span>'
      : '<svg viewBox="0 0 24 24" fill="none" stroke="#0d1220" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></svg><span>Светлая тема</span>';
  }
  function setTheme(t){ document.body.classList.toggle('light', t==='light'); localStorage.setItem(THEME_KEY, t); updateThemeBtn(); }
  (function initTheme(){ const saved = localStorage.getItem(THEME_KEY); setTheme(saved==='light'?'light':'dark'); })();
  document.addEventListener('click', (e)=>{ const b = e.target.closest('#themeBtn'); if(!b) return; const light = document.body.classList.contains('light'); setTheme(light? 'dark' : 'light'); });

  // ======= Prefs (reminders) =======
  const DEFAULT_PREFS = { daily:false, time:'09:00', stock:false, threshold:10 };
  const prefs = Object.assign({}, DEFAULT_PREFS, JSON.parse(localStorage.getItem('rt_prefs')||'{}'));
  const elDaily = document.getElementById('remDaily');
  const elTime = document.getElementById('remTime');
  const elStock = document.getElementById('remStock');
  const elThr = document.getElementById('remThreshold');

  function syncPrefsToUI(){ if(!elDaily) return; elDaily.checked = !!prefs.daily; if(elTime) elTime.value = prefs.time||'09:00'; if(elStock) elStock.checked = !!prefs.stock; if(elThr) elThr.value = String(prefs.threshold||10); }
  function savePrefs(){ localStorage.setItem('rt_prefs', JSON.stringify(prefs)); }

  syncPrefsToUI();

  elDaily?.addEventListener('change',()=>{ prefs.daily = elDaily.checked; savePrefs(); });
  elTime?.addEventListener('change',()=>{ prefs.time = elTime.value||'09:00'; savePrefs(); });
  elStock?.addEventListener('change',()=>{ prefs.stock = elStock.checked; savePrefs(); });
  elThr?.addEventListener('change',()=>{ const n = Math.max(1, Math.min(200, parseInt(elThr.value||'10',10))); prefs.threshold = n; elThr.value = String(n); savePrefs(); });

  // ======= Share report =======
  document.getElementById('shareBtn').addEventListener('click', async () => {
    const goalMg = Math.round(STATE.weightKg * STATE.goalMgPerKg);
    const text = [
      `Отчёт по курсу RoaccutaneTracker`,
      `Пациент: ${STATE.name}`,
      `Препарат: ${STATE.drug}`,
      `Старт курса: ${fmtDate(STATE.startISO)}`,
      `Вес: ${STATE.weightKg} кг`,
      `Цель: ${STATE.goalMgPerKg} mg/kg (${goalMg} мг)`,
      `Принято: ${STATE.takenMg} мг`,
      `Сегодня: ${STATE.todayMg||0} мг`,
      `Аллергии: ${STATE.allergies||'—'}`
    ].join('\n');

    if (navigator.share) {
      try{ await navigator.share({ title:'Отчёт Roaccutane', text }); }catch(_){}
    } else {
      await navigator.clipboard.writeText(text);
      alert('Отчёт скопирован в буфер обмена');
    }
  });

  // ======= Prescription (rx) =======
  const RX_KEY = 'rt_rx_image';
  const rxThumb = document.getElementById('rxThumb');
  const rxUploadBtn = document.getElementById('rxUploadBtn');
  const rxDeleteBtn = document.getElementById('rxDeleteBtn');
  const rxInput = document.getElementById('rxInput');
  // Lightbox helpers (элементы ниже в разметке)
  function getRxLightbox(){
    return { lb: document.getElementById('rxLightbox'), img: document.getElementById('rxFull') };
  }

  function rxSync(){
    const data = localStorage.getItem(RX_KEY);
    if(data){
      if(rxThumb){ rxThumb.style.backgroundImage = `url(${data})`; rxThumb.hidden = false; }
      if(rxDeleteBtn) rxDeleteBtn.hidden = false;
      if(rxUploadBtn) rxUploadBtn.textContent = 'Заменить рецепт';
    } else {
      if(rxThumb){ rxThumb.hidden = true; rxThumb.style.backgroundImage = ''; }
      if(rxDeleteBtn) rxDeleteBtn.hidden = true;
      if(rxUploadBtn) rxUploadBtn.textContent = 'Загрузить рецепт';
      if(rxInput) rxInput.value = '';
    }
  }

  function rxOpen(){
    const data = localStorage.getItem(RX_KEY);
    if(!data) return;
    const { lb, img } = getRxLightbox();
    if(img) img.src = data;
    if(lb) lb.hidden = false;
    document.body.style.overflow='hidden';
  }

  rxUploadBtn?.addEventListener('click', ()=> rxInput?.click());
  rxInput?.addEventListener('change', (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = () => { try{ localStorage.setItem(RX_KEY, r.result); }catch(_){} rxSync(); };
    r.readAsDataURL(file);
  });
  rxThumb?.addEventListener('click', rxOpen);
  rxDeleteBtn?.addEventListener('click', ()=>{
    if(!localStorage.getItem(RX_KEY)) return;
    const ok = (typeof confirm === 'function') ? confirm('Удалить рецепт?') : true;
    if(ok !== false){
      try{ localStorage.removeItem(RX_KEY); }catch(_){}
      const { lb, img } = getRxLightbox(); if(lb) lb.hidden = true; if(img) img.src = '';
      rxSync();
    }
  });

  // Закрытие лайтбокса (крестик или клик по фону)
  document.addEventListener('click', (e)=>{
    if(e.target.closest('#rxClose')){
      const { lb, img } = getRxLightbox();
      if(lb) lb.hidden = true; if(img) img.src=''; document.body.style.overflow='';
      return;
    }
    const el = e.target.closest('#rxLightbox');
    if(!el) return;
    el.hidden = true;
    const { img } = getRxLightbox();
    if(img) img.src = '';
    document.body.style.overflow='';
  });

  rxSync();

  // ======= Doctor link/binding =======
  const DOCTOR_KEY = 'rt_doctor';
  const CODE_RE = /^[A-Za-z0-9]{5}$/;
  const docBindEl = document.getElementById('docBind');
  const docCodeInput = document.getElementById('docCodeInput');
  const docBindBtn = document.getElementById('docBindBtn');
  const doctorMeta = document.getElementById('doctorMeta');
  const doctorProfileBtn = document.getElementById('doctorProfileBtn');
  const docHead = document.getElementById('docHead');
  const docAvatarImg = document.getElementById('docAvatarImg');
  const docAvatarFallback = document.getElementById('docAvatarFallback');
  const docNameEl = document.getElementById('docName');
  const docSubEl = document.getElementById('docSub');
  const docDetachBtn = document.getElementById('docDetachBtn');

  function getDoctor(){ try{ return JSON.parse(localStorage.getItem(DOCTOR_KEY)||'null'); }catch(_){ return null; } }
  function setDoctor(obj){ try{ if(obj) localStorage.setItem(DOCTOR_KEY, JSON.stringify(obj)); else localStorage.removeItem(DOCTOR_KEY); }catch(_){ } }
  function applyDoctor(){
    const d = getDoctor();
    const bind = document.getElementById('docBind');
    const head = document.getElementById('docHead');
    const analyses = document.getElementById('analysesBlock');
    const labLine = document.getElementById('labLine');
    if(d){
      doctorMeta.textContent = 'Врач прикреплён';
      if(head) head.hidden = false;
      if(bind) bind.style.display = 'none';
      if(analyses) analyses.hidden = false;
      if(labLine) labLine.hidden = false;
      // fill card
      if(docNameEl) docNameEl.textContent = d.name || `Врач по коду ${d.code}`;
      if(docSubEl) docSubEl.textContent = [ `Код ${d.code}`, d.clinic, d.phone ].filter(Boolean).join(' • ');
      if(docAvatarFallback) docAvatarFallback.textContent = (d.name||'Врач').trim().charAt(0).toUpperCase();
      if(d.avatarUrl && docAvatarImg){ docAvatarImg.src = d.avatarUrl; }
      if(doctorProfileBtn){ doctorProfileBtn.hidden = !d.url; if(d.url) doctorProfileBtn.href = d.url; }
      // status
      const dueISO = d.deadlineISO || new Date(Date.now()+10*864e5).toISOString().slice(0,10);
      document.getElementById('labDue').textContent = fmtDate(dueISO);
      const pill = document.getElementById('labStatus'); pill.textContent = 'OK'; pill.className = 'pill ok';
    } else {
      doctorMeta.textContent = 'Врач не прикреплён';
      if(head) head.hidden = true;
      if(bind) bind.style.display = 'flex';
      if(analyses) analyses.hidden = true;
      if(labLine) labLine.hidden = true;
      if(doctorProfileBtn) doctorProfileBtn.hidden = true;
    }
  }

  applyDoctor();

  // UX: Enter to submit & normalize code
  docCodeInput?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); docBindBtn?.click(); } });
  docCodeInput?.addEventListener('input', (e)=>{ const t=e.target; t.value = t.value.toUpperCase().replace(/[^A-Z0-9]/g,''); const valid = CODE_RE.test(t.value); if(docBindBtn) docBindBtn.disabled = !valid; const err = document.getElementById('docError'); if(err) err.hidden = true; });

  docBindBtn?.addEventListener('click', ()=>{
    const code = (docCodeInput?.value||'').trim(); if(!CODE_RE.test(code)) { const err = document.getElementById('docError'); if(err) err.hidden = false; return; }
    // Demo-реестр: подставь реальный запрос к API
    const REG = {
      '12345': { name:'Иванова Н.В.', clinic:'Derma Clinic', phone:'+7 999 000‑00‑00', url:'doctor-ivanova.html', avatarUrl:'' },
      'ABCDE': { name:'Петров А.С.',  clinic:'SkinLab',      phone:'+7 999 111‑11‑11', url:'doctor-petrov.html',  avatarUrl:'' }
    };
    const d = REG[code];
    if(!d){ const err = document.getElementById('docError'); if(err) err.hidden = false; return; }
    const data = { code, ...d, status:'OK', deadlineISO: new Date(Date.now()+10*864e5).toISOString().slice(0,10) };
    setDoctor(data);
    applyDoctor();
  });

  docDetachBtn?.addEventListener('click', ()=>{
    setDoctor(null);
    if(docCodeInput) docCodeInput.value = '';
    applyDoctor();
  });

  // ======= Edit flow =======
  document.getElementById('editBtn').addEventListener('click', (ev)=>{
    navigateWithVT('profile-dark.html');
  });

  // ======= View Transitions helper for links =======
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a[data-vt-link]');
    if(!a) return;
    if(e.metaKey||e.ctrlKey||e.shiftKey||e.altKey||a.target==='_blank') return;
    e.preventDefault(); navigateWithVT(a.href);
  });

  function navigateWithVT(href){
    if (document.startViewTransition) {
      document.startViewTransition(() => { window.location.href = href; });
    } else {
      window.location.href = href;
    }
  }
  </script>
  <div class="lightbox" id="rxLightbox" hidden>
    <button class="lb-close" id="rxClose" aria-label="Закрыть">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
    <img id="rxFull" alt="Рецепт">
  </div>
<script>
// === Shared Element Transition: avatar (entry) ===
(function runSharedAvatarEntrance(){
  try{
    if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
    if (!location.hash.includes('fx=avatar')) return;
    const raw = sessionStorage.getItem('share:avatar');
    if (!raw) return;
    const info = JSON.parse(raw);
    const target = document.querySelector('.avatar') || document.querySelector('[data-shared="avatar"]');
    if (!target) return;
    if (!target.hasAttribute('data-shared')) target.setAttribute('data-shared','avatar');
    const final = target.getBoundingClientRect();
    const ghost = document.createElement(info.src ? 'img' : 'div');
    if (info.src){ ghost.src = info.src; ghost.alt = ''; }
    else{
      ghost.textContent = info.text || '';
      ghost.style.display='grid'; ghost.style.placeItems='center';
      ghost.style.fontWeight='700'; ghost.style.color = getComputedStyle(target).color || '#fff';
    }
    Object.assign(ghost.style, {
      position:'fixed', left: info.left+'px', top: info.top+'px',
      width: info.width+'px', height: info.height+'px',
      borderRadius: info.br || getComputedStyle(target).borderRadius,
      background: info.src ? 'transparent' : (getComputedStyle(target).backgroundColor || '#0d1623'),
      border: getComputedStyle(target).border || '1px solid rgba(255,255,255,.14)',
      overflow:'hidden', zIndex: '9999', pointerEvents:'none',
      boxShadow: '0 14px 34px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06)'
    });
    document.body.appendChild(ghost);
    const realVis = target.style.visibility; target.style.visibility='hidden';
    const cont = document.querySelector('main') || document.body;
    cont.style.opacity='0'; cont.style.transform='translateY(6px)';
    cont.animate([{opacity:0, transform:'translateY(6px)'},{opacity:1, transform:'translateY(0)'}], {duration:420, easing:'cubic-bezier(0.2,0.7,0.2,1)', fill:'forwards'}).onfinish=()=>{
      cont.style.opacity=''; cont.style.transform='';
    };
    const dx = final.left - info.left;
    const dy = final.top - info.top;
    const sx = final.width/Math.max(1,info.width);
    const sy = final.height/Math.max(1,info.height);
    const anim = ghost.animate(
      [{ transform:'translate(0,0) scale(1)', opacity:1 },
       { transform:`translate(${dx}px, ${dy}px) scale(${sx}, ${sy})`, opacity:1 }],
      {duration:460, easing:'cubic-bezier(0.2,0.7,0.2,1)', fill:'forwards'}
    );
    anim.onfinish = ()=>{
      ghost.remove(); target.style.visibility = realVis || '';
      try{ sessionStorage.removeItem('share:avatar'); }catch(_){}
      try{ history.replaceState(null,'', location.pathname + location.search); }catch(_){}
    };
  }catch(e){ /* silent */ }
})();
</script>
</body>
</html>
